<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ€¨ç§å¥³é…æ€æ¡Œå½• Â· ç»ˆæå®Œæ•´ç‰ˆ Day1â€“Day20</title>
<style>
:root{
  --bg:#0f1220;
  --card:#1b1f3a;
  --card2:#14182e;
  --text:#eaeaff;
  --muted:#b7b9ff;
  --border:#3b3f7a;
  --accent:#ff6aa2;
  --good:#7cffb2;
  --warn:#ffd36b;
  --bad:#ff5b5b;
  --glow:#ff6aa288;
  --shadow:0 0 12px #0007;
  --r:14px;
}
*{box-sizing:border-box}
body{
  margin:0;
  color:var(--text);
  font-family:"PingFang SC","Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background: radial-gradient(1200px 800px at 20% 0%, #1a1f44 0%, var(--bg) 55%, #0b0d18 100%);
}
.container{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  padding:12px;
}
.card{
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:14px;
  box-shadow:var(--shadow);
  position:relative;
  overflow:hidden;
}
h3{margin:0 0 10px; color:var(--accent); font-size:16px; letter-spacing:.4px;}
.small{font-size:12px;color:var(--muted);line-height:1.55}
.hr{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:10px 0;}
@media(max-width:820px){.container{grid-template-columns:1fr;}}

/* story */
#story{height:300px;overflow:auto;line-height:1.78;font-size:14px;padding-right:6px;}
#story::-webkit-scrollbar{width:8px}
#story::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

/* options */
.option{
  background:#242a62;
  border:1px solid #2f3578;
  padding:10px;
  margin:8px 0;
  border-radius:10px;
  cursor:pointer;
  transition:.15s;
  user-select:none;
}
.option:hover{transform:translateY(-1px); border-color:var(--accent); box-shadow:0 0 10px var(--glow);}
.option.highlight{border-color:var(--accent); box-shadow:0 0 16px var(--glow);}
.tag{
  display:inline-block;
  font-size:12px;
  padding:2px 8px;
  border-radius:999px;
  margin-right:8px;
  border:1px solid #ffffff22;
  opacity:.95;
}
.tag-main{color:var(--accent);background:#ff6aa214;border-color:#ff6aa244;}
.tag-safe{color:var(--good);background:#7cffb214;border-color:#7cffb255;}
.tag-risk{color:var(--bad);background:#ff5b5b14;border-color:#ff5b5b66;}
.tag-warn{color:var(--warn);background:#ffd36b14;border-color:#ffd36b66;}

/* stats */
.stat{display:flex;align-items:center;gap:10px;margin:6px 0;font-size:13px;}
.stat b{width:88px;color:#fff;font-weight:600}
.bar{flex:1;height:8px;background:#00000033;border:1px solid #ffffff12;border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,#7cffb2,#ffd36b,#ff6aa2);width:50%}
.val{width:44px;text-align:right}

/* system */
.sysRow{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0;font-size:13px;}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ffffff22;}
.badge-ok{color:var(--good);border-color:#7cffb266;background:#7cffb214;}
.badge-warn{color:var(--warn);border-color:#ffd36b66;background:#ffd36b12;}
.badge-bad{color:var(--bad);border-color:#ff5b5b66;background:#ff5b5b14;}

.btn{
  cursor:pointer;
  border-radius:10px;
  padding:8px 10px;
  border:1px solid #ffffff22;
  background:#20245a;
  color:var(--text);
  transition:.15s;
  font-size:13px;
}
.btn:hover{transform:translateY(-1px);border-color:var(--accent);box-shadow:0 0 10px var(--glow);}
.btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

/* floating tip */
.float{
  position:fixed; right:14px; top:14px; z-index:9999;
  padding:8px 10px; border-radius:10px;
  border:1px solid #ffffff22; background:#12152aee; box-shadow:var(--shadow);
  animation: floatUp 1.4s ease-out forwards; font-size:13px;
}
.float.good{color:var(--good);border-color:#7cffb255}
.float.bad{color:var(--bad);border-color:#ff5b5b66}
.float.warn{color:var(--warn);border-color:#ffd36b66}
@keyframes floatUp{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-40px)}}

/* punishment animation */
.flash{position:fixed;inset:0;background:radial-gradient(900px 400px at 50% 20%, #ff5b5b33, transparent 70%);opacity:0;pointer-events:none;z-index:9998;}
.flash.on{animation:flash .55s ease-in-out;}
@keyframes flash{0%{opacity:0}35%{opacity:1}100%{opacity:0}}
.shake{animation:shake .42s linear}
@keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}100%{transform:translateX(0)}}

/* modal */
.mask{position:fixed;inset:0;background:#00000088;display:none;align-items:center;justify-content:center;z-index:10000;}
.mask.show{display:flex}
.modal{
  width:min(820px, 92vw);
  max-height:86vh;
  overflow:auto;
  background:linear-gradient(180deg,#1b1f3a 0%, #14182e 100%);
  border:1px solid var(--border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:14px;
}
.modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px;}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px;}
@media(max-width:680px){.grid{grid-template-columns:1fr}}
.item{border:1px solid #ffffff1a;background:#10132a66;border-radius:12px;padding:10px;}
.item h4{margin:0 0 6px;color:#fff;font-size:14px;}
.meta{display:flex;gap:8px;align-items:center;margin:6px 0;font-size:12px;color:var(--muted);}
.price{color:var(--accent);border:1px solid #ff6aa244;background:#ff6aa214;border-radius:999px;padding:2px 8px;}
.desc{font-size:12px;line-height:1.55;color:#d7d9ff;}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;}
.badge2{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ffffff22;color:#fff;background:#00000022}

/* portraits */
.portraitWrap{display:flex;gap:10px;align-items:center;margin-bottom:8px;}
.portrait{
  width:44px;height:44px;border-radius:12px;
  border:1px solid #ffffff22;
  background:#0d1024;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
  box-shadow:0 0 10px #0006;
}
.pName{font-weight:800}
</style>
</head>

<body>
<div class="flash" id="flash"></div>

<div class="container">

  <div class="card" id="cardStory">
    <h3>ğŸ“œ å½“å‰å‰§æƒ…</h3>
    <div class="portraitWrap">
      <div class="portrait" id="portraitBox">æŸ³</div>
      <div>
        <div class="pName" id="portraitName">æŸ³æ‰¶é£</div>
        <div class="small" id="subtitle"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div id="story"></div>
  </div>

  <div class="card" id="cardAction">
    <h3>ğŸ¯ è¡ŒåŠ¨é¢æ¿</h3>
    <div class="small">æ¯å›åˆï¼šå…ˆé€‰ 1 é¡¹è¿›å…¥â€œç»“ç®—â€ï¼Œå†ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ã€‚é«˜äº®=æ€æ¡Œ/é«˜é£é™©ã€‚</div>
    <div class="hr"></div>
    <div id="options"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnCustom">âœï¸ è‡ªå®šä¹‰è¡ŒåŠ¨</button>
      <button class="btn" id="btnAI">ğŸ¤– AIç»­å†™</button>
      <button class="btn" id="btnEnd">â© ç»“æŸæœ¬å›åˆ</button>
    </div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnApi">ğŸ”‘ è®¾ç½®AIå¯†é’¥</button>
      <button class="btn" id="btnJump20">â­ ç›´æ¥åˆ°Day20ç»“å±€</button>
    </div>
    <div class="small" id="aiHint" style="margin-top:8px"></div>
  </div>

  <div class="card" id="cardStats">
    <h3>ğŸ“Š è§’è‰²çŠ¶æ€</h3>
    <div class="small">ç³»ç»Ÿè­¦å‘Šå€¼â‰¥70æ›´ç‹ ï¼›å¥åº·â‰¤15å¯èƒ½â€œç—…å€’â€ï¼›Day20è‡ªåŠ¨ç»“å±€åˆ¤å®šã€‚</div>
    <div class="hr"></div>
    <div id="stats"></div>
  </div>

  <div class="card" id="cardSystem">
    <h3>âš™ ç³»ç»Ÿç›‘æ§</h3>
    <div id="system"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnAch">ğŸ† æˆå°±</button>
      <button class="btn" id="btnSave">ğŸ’¾ å­˜æ¡£</button>
      <button class="btn" id="btnLoad">ğŸ“¥ è¯»æ¡£</button>
      <button class="btn" id="btnReset">ğŸ§¨ æ¸…æ¡£é‡å¼€</button>
    </div>
  </div>

</div>

<!-- Shop/Ach/API Modal -->
<div class="mask" id="mask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:900;color:#fff" id="modalTitle">çª—å£</div>
        <div class="small" id="modalSub">â€”</div>
      </div>
      <button class="btn" id="btnClose">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* =========================================================
   ç»ˆæå®Œæ•´ç‰ˆï¼šDay1â€“Day20 + ä¿®å¤ç‚¹å‡»ä¸è§¦å‘ + ç»“å±€/æˆå°±/ç«‹ç»˜/å­˜æ¡£
   ========================================================= */

/* ========= åŸºç¡€å·¥å…· ========= */
const $ = id => document.getElementById(id);
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function tip(text, kind="good"){
  const d=document.createElement("div");
  d.className=`float ${kind}`;
  d.innerText=text;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1400);
}

function typeText(text){
  const storyBox = $("story");
  storyBox.innerHTML="";
  let i=0;
  const s = String(text||"");
  const timer=setInterval(()=>{
    storyBox.innerHTML += (s[i] ?? "");
    storyBox.scrollTop = storyBox.scrollHeight;
    i++;
    if(i>=s.length) clearInterval(timer);
  }, 10);
}

/* ========= æ¸¸æˆæ•°æ®ï¼ˆDay1â€“Day20 ä¸»çº¿ï¼‰ ========= */
const Days = Array.from({length:20}, (_,i)=>{
  const d=i+1;
  const title = `ç¬¬${d}æ—¥`;
  // ä½ è¦ç”œå® +æƒè°‹å¤šçº¿ï¼šæˆ‘ä»¬ç”¨â€œä¸»çº¿/æ€æ¡Œ/è°‹ç•¥/å…»æˆâ€å››è·¯è´¯ç©¿ï¼Œå¹¶æŠŠå‰§æƒ…é€æ—¥å‡çº§
  const main = [
    "ä¸œå®«é€æ±¤èŠ‚ç‚¹ï¼ˆåˆæ¬¡æ”¹å†™ï¼‰","åŸä¸­æš—æµï¼ˆå£ç¢‘/è¯æ®ï¼‰","ä¸œå®«å›å£°ï¼ˆæ­£é¢äº¤é”‹ï¼‰","ä¸ç›¸åºœçº¿äººï¼ˆå–è¯å‡çº§ï¼‰","è´µå¥³èŒ¶ä¼šï¼ˆèˆ†è®ºæˆ˜ï¼‰",
    "å¤ªå­å¤œå¬ï¼ˆæš§æ˜§è¯•æ¢ï¼‰","å…µéƒ¨å¯†æ¡£ï¼ˆæƒè°‹å…¥å£ï¼‰","è‹æ¸…è²åå‡»ï¼ˆå±€ä¸­å±€ï¼‰","å®«å®´äº‰é”‹ï¼ˆåå†Œé£æ³¢ï¼‰","é›¨å¤œåŒä¼ï¼ˆç”œå® çˆ†å‘ï¼‰",
    "è¾¹å†›æ¶ˆæ¯ï¼ˆå°†å†›åºœå±æœºï¼‰","å¤ªå­æŠ¤çŸ­ï¼ˆå…¬å¼€åçˆ±ï¼‰","ä¸ç›¸è½å­ï¼ˆé€¼å©š/æ ½èµƒï¼‰","ä½ è®¾å±€åæ€ï¼ˆè¯æ®æˆé“¾ï¼‰","ä¸œå®«ç§èª“ï¼ˆåŒç›Ÿ/æƒ…æ„Ÿï¼‰",
    "æœå ‚å¯¹å³™ï¼ˆé»‘åŒ–/ç«‹å¨ï¼‰","è‹æ¸…è²å´©ç›˜ï¼ˆç»ˆå±€å‰å¤œï¼‰","å†Œå°ä¸åå™¬ï¼ˆç³»ç»Ÿç–¯ç‹‚ï¼‰","æœ€åä¸€æ—¥å€’è®¡æ—¶ï¼ˆç»ˆæé€‰æ‹©ï¼‰","ç»ˆå±€åˆ¤å®šï¼ˆæ—¥ç»ˆç»“å±€ï¼‰"
  ][i];

  const intro = `ã€${title}ã€‘\nä¸»çº¿ï¼š${main}\n\nä½ åœ¨â€œå¥³é…å‰§æœ¬â€çš„å¤¹ç¼é‡Œæ´»ç€ã€‚\nç³»ç»Ÿè¦ä½ ä¹–ï¼Œä¸œå®«è¦ä½ è·ªï¼Œä¸ç›¸è¦ä½ æ­»ã€‚\n\nè€Œä½ åªæƒ³èµ¢ã€‚`;

  return { day:d, title, main, intro };
});

/* ========= æˆå°± ========= */
const Achievements = [
  {id:"firstBlood", name:"ç¬¬ä¸€æ»´è¡€", desc:"ç¬¬ä¸€æ¬¡é€‰æ‹©ã€æ€æ¡Œã€‘", cond:s=>s.meta.flipCount>=1},
  {id:"ironBody", name:"é“æ‰“çš„å‘½", desc:"å¥åº·æ›¾é™åˆ°â‰¤20åˆæ´»å›æ¥", cond:s=>s.meta.lowHpRecovered},
  {id:"sweet10", name:"ç”œå® é¢„å¤‡å½¹", desc:"å¤ªå­å¥½æ„Ÿâ‰¥50", cond:s=>s.player.princeFavor>=50},
  {id:"schemer", name:"è°‹ç•¥æˆé“¾", desc:"è°‹ç•¥â‰¥90", cond:s=>s.player.strategy>=90},
  {id:"noFear", name:"ç³»ç»Ÿä¸é…", desc:"ç³»ç»Ÿè­¦å‘Šâ‰¥80ä»æœªå€’ä¸‹ï¼ˆå¥åº·>15ï¼‰", cond:s=>s.player.sysWarn>=80 && s.player.hp>15},
  {id:"day20", name:"èµ°åˆ°ç»ˆç‚¹", desc:"è¿›å…¥Day20å¹¶è§¦å‘ç»“å±€", cond:s=>s.day>=20 && s.meta.ended}
];

/* ========= çŠ¶æ€ ========= */
const State = {
  version: "ULTIMATE_D20_v1",
  day: 1,
  phase: "CHOOSE", // CHOOSE -> RESOLVE
  focus: "self", // self/prince/su/system
  player: {
    glamour: 92,
    strategy: 78,
    mind: 74,
    hp: 88,
    flip: 0,
    dev: 0,
    nobleRep: 85,
    clanRep: 95,
    sysWarn: 0,
    princeFavor: 0,
    suSusp: 0
  },
  meta: {
    mainDoneCount: 0,
    flipCount: 0,
    customCount: 0,
    lowHpRecovered: false,
    ended: false,
    lastAction: ""
  },
  unlockedAch: {},
  api: {
    baseUrl: localStorage.getItem("GAME_AI_BASE") || "",
    apiKey: localStorage.getItem("GAME_AI_KEY") || "",
    model: localStorage.getItem("GAME_AI_MODEL") || "gpt-4o-mini"
  }
};

/* ========= ç«‹ç»˜ ========= */
function renderPortrait(){
  const box = $("portraitBox");
  const name = $("portraitName");
  const map = {
    self: {txt:"æŸ³", nm:"æŸ³æ‰¶é£"},
    prince: {txt:"ç©", nm:"å¤ªå­ Â· æ…•å®¹ç©"},
    su: {txt:"è²", nm:"è‹æ¸…è²"},
    system: {txt:"ç³»", nm:"ç³»ç»Ÿç›‘æ§"}
  };
  const p = map[State.focus] || map.self;
  box.textContent = p.txt;
  name.textContent = p.nm;
}

/* ========= UI æ¸²æŸ“ ========= */
function renderSubtitle(){
  const d = Days[State.day-1];
  $("subtitle").innerHTML = `ã€Œ${d.title}ã€<span class="small">ï¼ˆä¸»çº¿ï¼š${d.main}ï¼‰</span>`;
}

function renderStats(){
  const P = State.player;
  const rows = [
    ["é£å", P.glamour], ["è°‹ç•¥", P.strategy], ["å¿ƒæ™º", P.mind], ["å¥åº·", P.hp],
    ["æ€æ¡Œå€¼", P.flip], ["åç¦»åº¦", P.dev], ["è´µå¥³å£°æœ›", P.nobleRep],
    ["å®¶æ—å£°æœ›", P.clanRep], ["ç³»ç»Ÿè­¦å‘Šå€¼", P.sysWarn],
    ["å¤ªå­å¥½æ„Ÿ", P.princeFavor], ["è‹æ¸…è²æ€€ç–‘", P.suSusp]
  ];
  const statBox = $("stats");
  statBox.innerHTML="";
  rows.forEach(([k,v])=>{
    const max = 100;
    const pct = clamp((v/max)*100,0,100);
    const el=document.createElement("div");
    el.className="stat";
    el.innerHTML = `<b>${k}</b><div class="bar"><div class="fill" style="width:${pct}%"></div></div><span class="val">${v}</span>`;
    statBox.appendChild(el);
  });
}

function renderSystem(extra=""){
  const warn = State.player.sysWarn;
  let badge=`<span class="badge badge-ok">ç›‘æ§æ­£å¸¸</span>`;
  if(warn>=70) badge=`<span class="badge badge-bad">é«˜å±</span>`;
  else if(warn>=35) badge=`<span class="badge badge-warn">è­¦æƒ•</span>`;

  const d = Days[State.day-1];
  const done = (State.phase==="RESOLVE" && State.meta.lastAction==="MAIN") ? "âœ…å·²å®Œæˆ" : "âŒæœªå®Œæˆ";

  $("system").innerHTML = `
    <div class="sysRow"><span>ğŸ“… å›åˆ</span><b>Day ${State.day} / 20</b></div>
    <div class="sysRow"><span>ğŸ¯ ä»Šæ—¥ä¸»çº¿</span><span>${done}</span></div>
    <div class="small">${d.main}</div>
    <div class="hr"></div>
    <div class="sysRow"><span>ğŸ‘ è­¦å‘Šç­‰çº§</span>${badge}</div>
    <div class="small">${extra || "ç³»ç»Ÿæ­£åœ¨è®¡ç®—ä½ çš„â€˜äººè®¾ä¸€è‡´æ€§â€™â€¦"}</div>
  `;
}

function applyDelta(delta){
  for(const [k,v] of Object.entries(delta||{})){
    if(!(k in State.player)) continue;
    const before = State.player[k];
    State.player[k] = clamp(before + v, 0, 100);
    const sign = v>0?"+":"";
    tip(`${mapKey(k)} ${sign}${v}`, v>0 ? "good" : (v<0 ? "bad" : "warn"));
  }

  // ä½è¡€å›æ»¡æˆå°±æ ‡è®°
  if(State.player.hp<=20) State.meta._touchedLowHp = true;
  if(State.meta._touchedLowHp && State.player.hp>=60) State.meta.lowHpRecovered = true;
}

function mapKey(k){
  const m = {
    glamour:"é£å", strategy:"è°‹ç•¥", mind:"å¿ƒæ™º", hp:"å¥åº·",
    flip:"æ€æ¡Œå€¼", dev:"åç¦»åº¦", nobleRep:"è´µå¥³å£°æœ›",
    clanRep:"å®¶æ—å£°æœ›", sysWarn:"ç³»ç»Ÿè­¦å‘Šå€¼", princeFavor:"å¤ªå­å¥½æ„Ÿ", suSusp:"è‹æ¸…è²æ€€ç–‘"
  };
  return m[k] || k;
}

/* ========= æƒ©ç½š ========= */
function punish(level=1, reason="åç¦»ä¿®æ­£"){
  const flash = $("flash");
  const cards = [$("cardStory"),$("cardAction"),$("cardStats"),$("cardSystem")];

  flash.classList.add("on");
  cards.forEach(c=>c.classList.add("shake"));
  setTimeout(()=>{
    flash.classList.remove("on");
    cards.forEach(c=>c.classList.remove("shake"));
  }, 520);

  const base = level===1 ? 3 : level===2 ? 7 : 12;
  applyDelta({
    mind: -base,
    hp: -Math.max(1, Math.floor(base/2)),
    sysWarn: +(level===1 ? 12 : level===2 ? 22 : 35)
  });
  tip(`ç³»ç»Ÿæƒ©ç½šï¼š${reason}`, "bad");
}

/* ========= æ¯æ—¥å››å¤§è¡ŒåŠ¨ï¼šä¸»çº¿/æ€æ¡Œ/è°‹ç•¥/å…»æˆ ========= */
function dayText(day, route){
  // route: MAIN/FLIP/SCHEME/REST
  const d = day;
  // æ¯å¤©å››æ¡å‰§æƒ…éƒ½â€œæ¢æ–‡æœ¬â€ï¼Œè¿™æ ·è¡ŒåŠ¨é¢æ¿å°±ä¼šâ€œå˜â€
  const MAIN = [
`ä½ æŒ‰ä½è„¾æ°”ï¼ŒæŠŠâ€œä½“é¢â€å½“ç›¾ã€‚\nå¤ªå­çœ‹ä½ çš„çœ¼ç¥ä»å†·ï¼Œå´å¼€å§‹è®°ä½ä½ ã€‚\nä½ èµ¢äº†ç¬¬ä¸€æ­¥ï¼šä¸è®©ç³»ç»ŸæŠ“åˆ°æŠŠæŸ„ã€‚`,
`ä½ ç¨³ä½å£ç¢‘ï¼Œæ–½èˆä¸ä½“é¢è®©è´µå¥³ä»¬é—­å˜´ã€‚\nä½ åœ¨åŸé‡Œç«‹ä½â€œå°†å†›åºœçš„åˆ†å¯¸â€ã€‚`,
`ä½ åœ¨ä¸œå®«ä¸å‘ä¸äº¢ã€‚\nå¤ªå­ç¬¬ä¸€æ¬¡é—®ä½ ï¼šâ€œä½ æƒ³è¦ä»€ä¹ˆï¼Ÿâ€\nä½ è¯´ï¼šâ€œæˆ‘æƒ³è¦ä¸€ä¸ªä¸å¿…è·ªç€æ´»çš„æœªæ¥ã€‚â€`,
`ä½ ç”¨ç¤¼æ³•åå°†ä¸ç›¸åºœä¸€å†›ã€‚\nè¡¨é¢é€ç¤¼ï¼Œæš—é‡Œé€’åˆ€â€”â€”è¯æ®æ›´è¿‘ä¸€æ­¥ã€‚`,
`ä½ åœ¨èŒ¶ä¼šé‡Œä¸äº‰ä¸åµï¼Œåªè½»è½»ä¸€å¥â€œæˆ‘ä¸è§£é‡Šâ€ã€‚\nè§£é‡Šæ˜¯å¼±è€…çš„å—“éŸ³ï¼Œä½ è¦çš„æ˜¯å¼ºè€…çš„æ²‰é»˜ã€‚`,
`å¤œå¬ä¸œå®«ã€‚\nå¤ªå­æ›¿ä½ æŠ«ä¸ŠæŠ«é£ï¼Œå£°éŸ³å‹å¾—ä½ï¼šâ€œåˆ«å†ç¡¬æ‰›ã€‚â€\nä½ å¿½ç„¶å‘ç°ï¼šä»–å¼€å§‹æŠ¤ä½ äº†ã€‚`,
`å…µéƒ¨å¯†æ¡£åˆ°æ‰‹ã€‚\nä½ ä¸æ€¥ç€çœ‹å®Œï¼Œåªå…ˆè®°ä½è°æœ€æ€•ä½ çœ‹åˆ°ã€‚`,
`è‹æ¸…è²æŠ›å‡ºâ€œæ— å¿ƒä¹‹å¤±â€ï¼Œè¯•å›¾è®©ä½ è·Œå›æ³¥é‡Œã€‚\nä½ å½“ä¼—ç¬‘ç€æ¥ä½â€”â€”ç„¶åè½¬èº«æŠŠå¥¹çš„æ‰‹æŒ‡ä¸€æ ¹æ ¹æ°å¼€ã€‚`,
`å®«å®´ä¸Šåå†Œç¿»åŠ¨ï¼Œä½ çœ‹è§è‡ªå·±çš„åå­—ã€‚\nå¤ªå­åœ¨ä¼—ç›®ç½ç½ä¹‹ä¸‹ï¼ŒæŠŠåå†Œåˆä¸Šï¼šâ€œæŸ³æ‰¶é£ï¼Œä¸å¿…åœ¨å†Œã€‚â€\nå…¨åœºæ­»å¯‚ã€‚`,
`é›¨å¤œåŒä¼ã€‚\nä»–æ‰‹æŒ‡ä¸ç»æ„æ‰£ä½ä½ è…•éª¨ï¼šâ€œåˆ«èµ°å¤ªè¿œã€‚â€\nä½ å¿ƒå£å‘çƒ­ï¼Œå´ä»ç¬‘ï¼šâ€œæ®¿ä¸‹æ€•æˆ‘è·‘ï¼Ÿâ€`,
`è¾¹å†›æ€¥æŠ¥ï¼Œå°†å†›åºœè¦è¢«ç‰µè¿ã€‚\nå¤ªå­æŠŠåœ£æ—¨å‹ä½åŠæ—¥ï¼Œåªç­‰ä½ å¼€å£ã€‚\nä½ ç¬¬ä¸€æ¬¡è½»å£°ï¼šâ€œå¸®æˆ‘ã€‚â€`,
`ä»–å…¬å¼€æŠ¤çŸ­ã€‚\næœå ‚ä¸Šæœ‰äººéª‚ä½ â€œå¦–å¥³â€ï¼Œå¤ªå­å†·å£°ï¼šâ€œå­¤çš„é€‰æ‹©ï¼Œè½®ä¸åˆ°ä½ è¯„ã€‚â€`,
`ä¸ç›¸é€¼å©š/æ ½èµƒé½ä¸‹ã€‚\nå¤ªå­é—®ä½ è¦ä¸è¦é€€ã€‚\nä½ è¯´ï¼šâ€œé€€ä¸€æ­¥ï¼Œæˆ‘å°±ä¼šæ­»ã€‚â€`,
`ä½ æŠŠè¯æ®ä¸²æˆé“¾ã€‚\nè‹æ¸…è²ç¬¬ä¸€æ¬¡è„¸è‰²å‘ç™½ã€‚\nä½ çœ‹ç€å¥¹ï¼Œè½»è½»ä¸€å¥ï¼šâ€œåˆ«æ€¥ï¼Œè¿˜æ²¡åˆ°ä½ å“­çš„æ—¶å€™ã€‚â€`,
`ä¸œå®«ç§èª“ã€‚\nä»–æ¡ä½ä½ çš„æ‰‹ï¼Œåƒåœ¨æ¡ä¸€æŸ„åˆ€ã€‚\nä½ è¯´ï¼šâ€œä»ä»Šå¤©èµ·ï¼Œæˆ‘ä»¬åŒè·¯ã€‚â€`,
`æœå ‚å¯¹å³™ã€‚\nä½ ä¸å†è£…æ¸©æŸ”ï¼Œä½ ç”¨æœ€é”‹åˆ©çš„ç¤¼æ³•åšåˆ€ã€‚\nä½ å¼€å§‹é»‘åŒ–ï¼Œä½†ä½ é»‘å¾—æ¼‚äº®ã€‚`,
`è‹æ¸…è²å´©ç›˜å‰å¤œã€‚\nå¥¹å“­ç€æ±‚ä½ æ”¾è¿‡ã€‚\nä½ ç¬‘ï¼šâ€œæˆ‘å½“å¹´æ±‚è¿‡è°ï¼Ÿâ€`,
`å†Œå°ä¸åå™¬ã€‚\nç³»ç»Ÿå‘ç–¯ä¸€æ ·æ‹‰ä½ å›å‰§æœ¬ã€‚\nå¤ªå­æŒ¡åœ¨ä½ èº«å‰ï¼šâ€œå¥¹ä¸æ˜¯å‰§æƒ…ï¼Œå¥¹æ˜¯äººã€‚â€`,
`å€’è®¡æ—¶ã€‚\nä½ ç«™åœ¨åŸæ¥¼ä¸Šï¼Œé£æŠŠå‘å¸¦å¹å¾—çŒçŒã€‚\nä½ çŸ¥é“æ˜å¤©ä¼šæœ‰ç»“å±€â€”â€”ä½ åªå·®æœ€åä¸€æ¬¡é€‰æ‹©ã€‚`,
`ç»ˆå±€ä¹‹é—¨å¼€å¯ã€‚\nä½ çš„æ¯ä¸€ä¸ªæ•°å€¼ï¼Œéƒ½ä¼šå˜æˆåˆ€å£çš„æ–¹å‘ã€‚`
  ][d-1];

  const FLIP = [
`ä½ å½“ä¼—å€’æ±¤æ€æ¡Œã€‚\nç³»ç»Ÿå°–å«ï¼Œè´µå¥³éœ‡æƒŠã€‚\nä½ ç¬‘ï¼šè¿™åŸé‡Œçš„è§„çŸ©ï¼Œè¯¥æ¢ä¸»äººäº†ã€‚`,
`ä½ åœ¨å¯ºé—¨å£å½“ä¼—é¡¶æ’ç¤¼éƒ¨ã€‚\nâ€œæˆ‘æ‰‹é…¸ï¼Œä¸æ¥å·®äº‹ã€‚â€\nä»–ä»¬æƒ³ç¬‘åˆä¸æ•¢ï¼Œä½ è¦çš„å°±æ˜¯è¿™ä»½éš¾å ªã€‚`,
`ä½ æŠŠåå†Œæ¨å›å»ï¼šâ€œç¾è¾±çš„ä¸æ˜¯æ®¿ä¸‹ï¼Œæ˜¯è§„çŸ©ã€‚â€\nå¤ªå­æ²‰é»˜å¾ˆä¹…ï¼Œå¿½ç„¶ç¬‘ï¼šâ€œä½ çœŸæ•¢ã€‚â€`,
`ä½ å¤œé—¯ä¸ç›¸åºœåé™¢ã€‚\nç¯ç«é‡Œä½ åƒé¬¼ã€‚\nä½ æŠŠè¯æ®å¡è¿›è¢–ä¸­ï¼Œç•™ä¸‹ä¸€å¥ï¼šâ€œæˆ‘æ¥æ”¶è´¦ã€‚â€`,
`ä½ å…¬å¼€ç‚¹åè‹æ¸…è²â€œæ‰‹å¤ªå·§â€ã€‚\nå¥¹ä¸€ç¬é—´ç™½å¾—åƒçº¸ã€‚\nä½ åä¸æ”¶æ‰‹ï¼šä½ è¦å¥¹å½“ä¼—å¤±æ§ã€‚`,
`ä½ åœ¨ä¸œå®«å»äº†ä»–ä¸€ä¸‹ï¼ŒåƒæŒ‘è¡…ã€‚\nå¤ªå­ç³å­”ä¸€ç¼©ï¼šâ€œä½ ç–¯äº†ï¼Ÿâ€\nä½ è¯´ï¼šâ€œæˆ‘åªæ˜¯å†³å®šä¸å¿äº†ã€‚â€`,
`ä½ æŠŠå…µéƒ¨å¯†æ¡£å¤å†™æ•£å‡ºã€‚\næœå ‚ç‚¸é”…ã€‚\nä½ å¾—ç½ªå¾ˆå¤šäººï¼Œä½†ä½ ä¹Ÿæ¡ä½äº†å‘½é—¨ã€‚`,
`ä½ æŠŠè‹æ¸…è²çš„â€œåå‡»â€åå¡å›å¥¹å–‰å’™ã€‚\nå¥¹å“­ç€è¯´ä½ æ¬ºè´Ÿå¥¹ã€‚\nä½ è¯´ï¼šâ€œå¯¹ï¼Œæˆ‘å°±æ˜¯ã€‚â€`,
`å®«å®´ä¸Šä½ ä¸¾æ¯ï¼šâ€œæ•¬æˆ‘ä¸è·ªã€‚â€\nç³»ç»Ÿæƒ©ç½šè½ä¸‹ï¼Œä½ ç¡¬æ‰›ç€ç¬‘ã€‚\nå¤ªå­çœ¼ç¥å½»åº•æ²‰äº†ã€‚`,
`é›¨å¤œä½ æ‹‰ä»–è¿›æªä¸‹ï¼Œè´´å¾—å¾ˆè¿‘ã€‚\nä½ å¬è§ä»–å‘¼å¸ä¹±äº†ã€‚\nä½ ç¬‘ï¼šâ€œæ®¿ä¸‹ä¹Ÿä¼šå¿ƒè™šï¼Ÿâ€`,
`ä½ åœ¨å°†å†›åºœé—¨å£æŒ‚èµ·â€œå†¤â€å­—ç¯ã€‚\nä½ è¦å…¨åŸéƒ½çœ‹è§ã€‚\nä½ ä¸æ±‚æ¸…ç™½ï¼Œä½ æ±‚éœ‡æ…‘ã€‚`,
`ä½ åœ¨æœå ‚ä¸Šå½“ä¼—å›æ€¼ç¾¤è‡£ã€‚\nä»–ä»¬è¯´ä½ ä¸é…ã€‚\nä½ è¯´ï¼šâ€œé‚£å°±è®©ä½ ä»¬é…ç»™æˆ‘çœ‹ã€‚â€`,
`ä½ æŠŠâ€œé€¼å©šâ€æ’•æˆç¢çº¸ã€‚\nä½ å…¬å¼€å®£å‘Šï¼šè°æ•¢é€¼ä½ ï¼Œä½ å°±è®©è°å®¶ç­é—¨ï¼ˆè§„åˆ™å±‚é¢ï¼‰ã€‚`,
`ä½ åæ€åˆ°ä¸ç›¸ä¸å¾—ä¸è®¤è¾“ã€‚\nä½ å¼€å§‹æ”¶ç½‘ï¼šä¸æ˜¯æ€äººï¼Œæ˜¯æ€æƒã€‚`,
`ä½ é€¼å¤ªå­å…¬å¼€ç«™é˜Ÿã€‚\nä»–ç«™äº†ã€‚\nä½ å¬è§ç³»ç»Ÿåƒç»ç’ƒç¢è£‚ã€‚`,
`ä½ é»‘åŒ–åˆ°åº•ã€‚\nä½ ä¸å†è®²é“ç†ï¼Œä½ è®²ç»“æœã€‚\nä½ æˆä¸ºä»–ä»¬å£ä¸­çš„â€œå¦–å¥³â€ï¼Œä½†ä½ æ´»ç€ã€‚`,
`ä½ ç»™è‹æ¸…è²ç•™ä¸€æ¡è·¯ï¼šè·ªã€‚\nå¥¹ä¸è·ªï¼Œä½ å°±è®©å¥¹ä»æ­¤æ²¡æœ‰åå­—ã€‚`,
`å†Œå°å½“å¤©ä½ æŠ¬å¤´çœ‹å¤©ã€‚\nç³»ç»Ÿæƒ©ç½šåƒé›·ã€‚\nä½ ç¬‘ç€è¯´ï¼šâ€œæ‰“å•Šã€‚â€`,
`æœ€åå€’è®¡æ—¶ä½ é€‰æ‹©ï¼šå†æ€ä¸€æ¬¡ï¼Œæ¢æœ€ç»ˆè‡ªç”±ã€‚\nä½ çŸ¥é“è¿™ä¼šå¾ˆç—›ï¼Œä½†ä½ ä¹ŸçŸ¥é“ï¼šä½ å€¼ã€‚`,
`ç»ˆå±€ï¼šä½ æŠŠæ¡Œå­æ€åˆ°ä¸–ç•Œå°½å¤´ã€‚`
  ][d-1];

  const SCHEME = [
`ä½ æ´¾æš—å«ç›¯ä¸ç›¸åºœåé™¢ã€‚\nä½ é—»åˆ°â€œå‰§æœ¬å¤–â€çš„å‘³é“ã€‚\nè¯æ®å¾ˆè–„ï¼Œä½†è–„åˆ€ä¹Ÿèƒ½å‰²å–‰ã€‚`,
`ä½ æ¢å‡ºå…¥å†Œã€æ‹¿æ®‹é¡µç¥¨æ®ã€‚\nä½ ä¸æ€¥ç€æ›å…‰ï¼Œä½ è¦ç­‰å®ƒå˜æˆé“è¯ã€‚`,
`ä½ é€’è¯æ®ç»™å¤ªå­ã€‚\nä½ ä¸è°ˆæƒ…ï¼Œåªè°ˆæ¡ä»¶ã€‚\nå¤ªå­é—®ï¼šâ€œä½ è¦ä»€ä¹ˆï¼Ÿâ€\nä½ ç­”ï¼šâ€œæˆ‘è¦å¥¹çš„æ— å¿ƒå˜æˆæ­»å±€ã€‚â€`,
`ä½ ä»¥ç¤¼æ³•è®¾å±€ï¼ŒæŠŠäººè¯ç‰©è¯ä¸²èµ·ã€‚\nä½ ç¦»â€œåæ€â€åªå·®ä¸€ä¸ªå¼•çˆ†ç‚¹ã€‚`,
`ä½ ç”¨èˆ†è®ºé€¼è‹æ¸…è²éœ²ç ´ç»½ã€‚\nå¥¹è¶Šè£…æ— è¾œï¼Œè¶Šåƒæœ‰ç½ªã€‚`,
`ä½ ç»™å¤ªå­ä¸€ä»½â€œæœ€å®‰å…¨çš„é€‰æ‹©â€ã€‚\nä»–çœ‹æ‡‚äº†ï¼šä½ ä¸æ˜¯æ±‚çˆ±ï¼Œä½ æ˜¯æ±‚ç”Ÿã€‚\nä»–æ›´åŠ¨å¿ƒäº†ã€‚`,
`ä½ åˆ‡å…¥å…µéƒ¨åˆ©ç›Šé“¾ã€‚\nä½ å¼€å§‹çœŸæ­£è§¦ç¢°æƒåŠ›ã€‚\nç³»ç»Ÿå¼€å§‹åŠ å€æƒ©ç½šä½ ã€‚`,
`ä½ é¢„åˆ¤å¥¹åå‡»è·¯çº¿ã€‚\nä½ ç•™å‡ºâ€œçœ‹ä¼¼æ¼æ´â€çš„å…¥å£ã€‚\nå¥¹é’»è¿›æ¥æ—¶ï¼Œä½ åˆä¸Šé—¨ã€‚`,
`å®«å®´ä½ ä¸éœ²é”‹èŠ’ï¼Œåªè®©è¯æ®è‡ªå·±è¯´è¯ã€‚\nå¤ªå­ä¸å¿…æŠ¤ä½ â€”â€”ä»–åªéœ€é¡ºåŠ¿è¸©ä¸‹å»ã€‚`,
`ä½ åœ¨é›¨å¤œæŠŠâ€œæœªæ¥â€æ‘Šå¼€ç»™ä»–çœ‹ã€‚\nä½ è¯´ï¼šâ€œæ®¿ä¸‹è‹¥æƒ³èµ¢ï¼Œå°±åˆ«å’Œæˆ‘å½“æ•Œäººã€‚â€`,
`å°†å†›åºœå±æœºï¼Œä½ æŠŠç«å¼•å‘çœŸæ­£çš„æ•Œäººã€‚\nä½ ä¸æ±‚å¤ªå­æ–½èˆï¼Œä½ è®©å¤ªå­è§‰å¾—ï¼šå¸®ä½ å°±æ˜¯å¸®ä»–è‡ªå·±ã€‚`,
`ä½ æ¨åŠ¨ä¸€åœºâ€œåˆæ³•æ¸…æ´—â€ã€‚\nä½ è®©ä¸ç›¸é˜µè¥å¼€å§‹äº’ç›¸å’¬ã€‚\nè¿™æ‰æ˜¯çœŸæ­£çš„æƒè°‹ã€‚`,
`é€¼å©šæ ½èµƒï¼Œä½ åæ‰‹åšæˆâ€œä¸ç›¸ä¸“æƒâ€çš„è¯æ®ã€‚\nä½ è¦çš„ä¸æ˜¯æ¾„æ¸…ï¼Œæ˜¯æ¸…ç®—ã€‚`,
`è¯æ®æˆé“¾ã€‚\nä½ æŠŠè‹æ¸…è²çš„æ¯ä¸€æ¬¡çœ¼æ³ªï¼Œéƒ½å˜æˆç½ªè¯çš„æ³¨è„šã€‚`,
`ç§èª“ä¸æ˜¯æƒ…è¯ï¼Œæ˜¯åŒç›Ÿå¥‘çº¦ã€‚\nä½ æ‹¿åˆ°å¤ªå­çš„ä¸€åŠæƒæŸ„ã€‚\nä½ ä¹ŸæŠŠè‡ªå·±äº¤åˆ°æ›´å±é™©çš„ä½ç½®ã€‚`,
`æœå ‚å¯¹å³™ï¼Œä½ ç”¨æ¡æ–‡æ€äººä¸è§è¡€ã€‚\nä½ å¼€å§‹äº«å—â€œèµ¢â€ã€‚`,
`è‹æ¸…è²å´©ç›˜ï¼Œä½ ä¸æ€¥ç€æ”¶å°¾ã€‚\nä½ è®©å¥¹ä¸€æ­¥æ­¥èµ°åˆ°ç»è·¯ã€‚\nè¿™å«â€œå®¡åˆ¤â€ã€‚`,
`å†Œå°å‰å¤œç³»ç»Ÿç–¯ç‹‚ã€‚\nä½ å‡†å¤‡æœ€åä¸€å¼ ç‰Œï¼šè®©ç³»ç»Ÿä¹Ÿè¿›ä½ çš„å±€ã€‚`,
`å€’è®¡æ—¶ä½ è®¡ç®—ç»“å±€æ¡ä»¶ã€‚\nä½ è¦æœ€ç¨³çš„èµ¢æ³•ï¼Œæˆ–æœ€çˆ½çš„æ€æ¡Œã€‚\nä½ ä¸¤ç§éƒ½èƒ½é€‰ã€‚`,
`ç»ˆå±€ï¼šè°‹ç•¥ç»“ç®—ï¼Œæ‰€æœ‰è´¦éƒ½è¦è¿˜ã€‚`
  ][d-1];

  const REST = [
`ä½ é—­é—¨è°ƒå…»ã€‚\nä½ æ˜ç™½ï¼šçˆ½æ€æ¡Œè¦ä½“åŠ›ã€‚\nä½ ä¸æ˜¯æ¥é€æ­»çš„ï¼Œä½ æ˜¯æ¥èµ¢çš„ã€‚`,
`ä½ æŠ„å…µä¹¦ï¼Œç»ƒå­—ç»ƒå¿ƒã€‚\nç³»ç»Ÿåµï¼Œä½ å½“è€³æ—é£ã€‚`,
`ä½ ä»¥ç—…ä¸ºç›¾ã€‚\nä¸æ˜¯é€€ç¼©ï¼Œæ˜¯èŠ‚å¥ã€‚\nä½ è¦æŒæ§æˆ˜åœºçš„æ—¶é—´ã€‚`,
`ä½ ä¿®æ•´äººè„‰ã€‚\nä½ æŠŠâ€œå¼±â€æ¼”å¾—åˆšå¥½ã€‚\næ¼”åˆ°ä»–ä»¬ä»¥ä¸ºä½ æ²¡å¨èƒã€‚`,
`ä½ å…»ä¸€ç›ç¯ã€‚\nç¯ä¸‹ä½ æŠŠæ‰€æœ‰äººçš„åå­—å†™æˆä¸€å¼ ç½‘ã€‚\nä½ è¦çš„æ˜¯å…¨å±€ã€‚`,
`ä½ ä¼‘æ¯ï¼Œå´å·å·æŠŠä¸œå®«åŠ¨å‘èƒŒç†Ÿã€‚\nä½ åƒçŒ«ï¼Œé™ï¼Œä½†éšæ—¶èƒ½æ‰‘ã€‚`,
`ä½ é”»ç‚¼ã€å…»æ°”ã€‚\nç³»ç»Ÿæƒ©ç½šæ¥æ—¶ï¼Œä½ èƒ½ç¡¬æ‰›ã€‚\nä½ è¦æ´»å¾—æ¯”å®ƒä¹…ã€‚`,
`ä½ å‡è£…å´©æºƒã€‚\nå¯¹å¤–è½¯ï¼Œå¯¹å†…å†·ã€‚\nä½ æŠŠæƒ…ç»ªå½“æ­¦å™¨ã€‚`,
`å®«å®´å‰ä½ æŠŠç¤¼æœæŒ‘åˆ°æœ€é”‹åˆ©ã€‚\nä¸æ˜¯æ¼‚äº®ï¼Œæ˜¯å‹è¿«ã€‚\nä½ è¦è®©ä»–ä»¬å…ˆèƒ†æ€¯ã€‚`,
`é›¨å¤œåä½ ç¡å¾—å¾ˆæ²‰ã€‚\nå¤ªå­æ´¾äººå®ˆåœ¨é—¨å¤–ã€‚\nä½ ç»ˆäºæœ‰äº†ä¸€ç‚¹â€œè¢«æŠ¤ç€â€çš„æ„Ÿè§‰ã€‚`,
`è¾¹å†›æ¶ˆæ¯ä½ å…ˆç¨³ä½åºœä¸­ã€‚\nä½ è®©å®¶æ—ä¸ä¹±ï¼Œæ‰èƒ½è°ˆåå‡»ã€‚`,
`ä½ å­¦ä¼šæŠŠâ€œå–œæ¬¢â€è—èµ·æ¥ã€‚\nè¶Šå–œæ¬¢è¶Šè¦ç¨³ã€‚\nä½ æ€•çš„ä¸æ˜¯ä»–ä¸çˆ±ï¼Œæ˜¯ä»–çˆ±å¾—ä¸å¤Ÿåšå®šã€‚`,
`ä½ ä»¥é€€ä¸ºè¿›ã€‚\nä½ è®©ä¸ç›¸ä»¥ä¸ºä½ æ€•ã€‚\nç„¶åä½ çªç„¶å‡ºåˆ€ã€‚`,
`ä½ åœ¨æˆ¿é‡Œç£¨åˆ€ã€‚\nåˆ€ä¸æ˜¯é“ï¼Œæ˜¯è¯æ®ï¼Œæ˜¯äººå¿ƒï¼Œæ˜¯è§„åˆ™æ¼æ´ã€‚`,
`ä½ å’Œå¤ªå­çŸ­æš‚æ¸©å­˜ã€‚\nä¸æ˜¯ç”œè…»ï¼Œæ˜¯äº’ç›¸ç¡®è®¤ï¼šä½ ä»¬ç«™åŒä¸€è¾¹ã€‚`,
`ä½ æŠŠé»‘åŒ–æŒ‰åœ¨å¿ƒé‡Œã€‚\nä½ å‘Šè¯‰è‡ªå·±ï¼šç°åœ¨è¿˜ä¸æ˜¯å‘ç–¯çš„æ—¶å€™ã€‚\nè¦ç–¯ï¼Œä¹Ÿå¾—ç–¯å¾—èµ¢ã€‚`,
`ä½ ä¼‘æ¯ä¸€å¤œã€‚\nç¬¬äºŒå¤©ä½ ä¼šæ›´ç‹ ã€‚\nå› ä¸ºä½ å·²ç»ä¸æ€•ç–¼äº†ã€‚`,
`å†Œå°å‰ä½ ç¨³ä½å‘¼å¸ã€‚\nç³»ç»Ÿè¶Šç–¯ï¼Œä½ è¶Šå†·ã€‚\nå†·æ‰èƒ½èµ¢ã€‚`,
`å€’è®¡æ—¶ä½ æ”¶æ‹¾å¥½æ‰€æœ‰é€€è·¯ã€‚\nä½ ä¸å…è®¸è‡ªå·±è¾“ã€‚\nä¸€æ¬¡éƒ½ä¸è¡Œã€‚`,
`ç»ˆå±€å‰å¤œï¼Œä½ å®‰é™å¾—å¯æ€•ã€‚\nä½ çŸ¥é“ï¼šæ˜å¤©è¦ä¹ˆæˆç¥ï¼Œè¦ä¹ˆæˆç°ã€‚`
  ][d-1];

  const map = {MAIN, FLIP, SCHEME, REST};
  return map[route] || "";
}

/* ========= æ„é€ è¡ŒåŠ¨ï¼ˆä¿è¯â€œæ¯å¤©éƒ½ä¼šå˜â€ï¼‰ ========= */
function buildOptions(day, s){
  const P=s.player;
  const d = Days[day-1];

  // æ¯å¤©çš„æ•°å€¼å¥–åŠ±ä¼šâ€œè½»å¾®å˜åŒ–â€ï¼Œè®©é¢æ¿ä¸æ˜¯æ­»çš„
  const drift = (day%3===0) ? 1 : 0;
  const drift2 = (day%4===0) ? 1 : 0;

  return [
    {
      id:"MAIN",
      tag:["ä¸»çº¿","ä½é£é™©"],
      actionKey:"MAIN",
      focus:"prince",
      highlight:false,
      effect:{ princeFavor:+(2+drift), dev:-(1), nobleRep:+(1), sysWarn:-(2) },
      story: dayText(day,"MAIN")
    },
    {
      id:"FLIP",
      tag:["æ€æ¡Œ","é«˜é£é™©"],
      actionKey:"FLIP",
      focus:"self",
      highlight:true,
      effect:{ flip:+(6+drift), dev:+(3+drift2), nobleRep:-(1), sysWarn:+(6), mind:-(1) },
      story: dayText(day,"FLIP")
    },
    {
      id:"SCHEME",
      tag:["è°‹ç•¥","ä¸­é£é™©"],
      actionKey:"SCHEME",
      focus:"system",
      highlight:false,
      effect:{ strategy:+(3), dev:+(1), suSusp:+(3+drift), nobleRep:+(1) },
      story: dayText(day,"SCHEME")
    },
    {
      id:"REST",
      tag:["å…»æˆ","ä½é£é™©"],
      actionKey:"REST",
      focus:"self",
      highlight:false,
      effect:{ mind:+(4), hp:+(4), dev:+(0), sysWarn:-(1) },
      story: dayText(day,"REST")
    }
  ];
}

/* ========= ä¿®å¤ï¼šè¡ŒåŠ¨é¢æ¿ click / touchend å¿…è§¦å‘ ========= */
function renderOptions(){
  const optionBox = $("options");
  optionBox.innerHTML="";
  const ops = buildOptions(State.day, State);

  ops.forEach(op=>{
    const btn=document.createElement("button");
    btn.type="button";
    btn.className="option";
    btn.style.width="100%";
    btn.style.textAlign="left";
    if(op.highlight) btn.classList.add("highlight");

    const tag1 = op.tag?.[0] || "è¡ŒåŠ¨";
    const tag2 = op.tag?.[1] || "æœªçŸ¥";
    const cls1 = tag1==="ä¸»çº¿" ? "tag-main" : (tag1==="æ€æ¡Œ" ? "tag-risk" : "tag-safe");
    const cls2 = tag2.includes("é«˜") ? "tag-risk" : (tag2.includes("ä¸­") ? "tag-warn" : "tag-safe");

    const title = tag1==="ä¸»çº¿" ? "ç¨³ä½å±€é¢ï¼ˆä¸»çº¿/ä½“é¢æ¨è¿›ï¼‰"
                : tag1==="æ€æ¡Œ" ? "æ€æ¡Œå¼€æ€ï¼ˆé«˜é£é™©é«˜æ”¶ç›Šï¼‰"
                : tag1==="è°‹ç•¥" ? "è¯æ®æ¨è¿›ï¼ˆè°‹ç•¥çº¿ï¼‰"
                : "é—­é—¨ä¿®æ•´ï¼ˆå›è¡€ç¨³å¿ƒï¼‰";

    const eff = Object.entries(op.effect||{})
      .map(([k,v])=> `${mapKey(k)}${v>=0?"+":""}${v}`)
      .join(" Â· ");

    btn.innerHTML = `
      <span class="tag ${cls1}">${tag1}</span>
      <span class="tag ${cls2}">${tag2}</span>
      <div style="margin-top:6px;font-weight:900">${title}</div>
      <div class="small" style="margin-top:6px">${eff}</div>
    `;

    const fire = (e)=>{ e.preventDefault(); applyAction(op); };
    btn.addEventListener("click", fire, {passive:false});
    btn.addEventListener("touchend", fire, {passive:false});

    optionBox.appendChild(btn);
  });
}

/* ========= ç»“ç®—/æ¨è¿› ========= */
function applyAction(op){
  try{
    // é˜²æ­¢â€œçœ‹èµ·æ¥æ²¡ååº”â€ï¼šæ°¸è¿œå…è®¸è¦†ç›–é€‰æ‹©
    if(State.phase!=="CHOOSE"){
      tip("ä½ å·²ç»ç»“ç®—è¿‡ï¼šå¯ç›´æ¥ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ï¼ˆä¹Ÿå¯é‡é€‰è¦†ç›–ï¼‰", "warn");
      State.phase="CHOOSE";
    }

    State.phase="RESOLVE";
    State.focus = op.focus || "self";
    State.meta.lastAction = op.actionKey;

    typeText(op.story);
    applyDelta(op.effect);

    if(op.actionKey==="FLIP") State.meta.flipCount++;
    if(op.actionKey==="MAIN") State.meta.mainDoneCount++;

    // ä¸»çº¿æœªé€‰ = æƒ©ç½šï¼ˆéšè­¦å‘Šå‡çº§ï¼‰
    if(op.actionKey!=="MAIN"){
      const warn = State.player.sysWarn;
      const lvl = warn>=85 ? 3 : (warn>=70 ? 2 : 1);
      punish(lvl, "æœªå®Œæˆä¸»çº¿/åç¦»ä¿®æ­£");
    }

    // ç—…å€’ä¿æŠ¤
    if(State.player.hp<=15){
      tip("ä½ ç—…å€’äº†ï¼šç³»ç»Ÿå¼ºåˆ¶ä¼‘å…»ï¼ˆæœ¬å›åˆè§†ä¸ºä¼‘å…»ï¼‰", "bad");
      applyDelta({hp:+8, mind:+6, sysWarn:+4});
    }

    // æˆå°±åˆ·æ–°
    checkAchievements();

    renderAll("ç»“ç®—å®Œæˆã€‚ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ã€‚");
    $("btnEnd").disabled = false;

  }catch(err){
    const msg = String(err && err.message ? err.message : err);
    renderSystem("âŒ å‘ç”ŸJSé”™è¯¯ï¼š" + msg);
    tip("JSé”™è¯¯ï¼š" + msg, "bad");
    State.phase="CHOOSE";
    $("btnEnd").disabled = false;
  }
}

function nextDay(){
  if(State.meta.ended) return;

  if(State.phase!=="RESOLVE"){
    tip("å…ˆé€‰ä¸€é¡¹è¡ŒåŠ¨å†ç»“æŸå›åˆ", "warn");
    return;
  }

  if(State.day>=20){
    // Day20ç»“å±€
    endGame();
    return;
  }

  State.day++;
  State.phase="CHOOSE";
  State.meta.lastAction="";
  State.focus="self";

  // æ¯å¤©è‡ªç„¶æ³¢åŠ¨ï¼šåç¦»è¶Šé«˜ï¼Œè­¦å‘Šè‡ªç„¶ä¸Šå‡ä¸€ç‚¹
  if(State.player.dev>=50) applyDelta({sysWarn:+2});
  if(State.player.dev>=75) applyDelta({sysWarn:+2});

  // Dayæ¨è¿›å‰§æƒ…
  const d = Days[State.day-1];
  typeText(d.intro);

  renderAll("æ–°çš„ä¸€å¤©å¼€å§‹ã€‚é€‰æ‹©ä½ çš„è¡ŒåŠ¨ã€‚");
  $("btnEnd").disabled = true;
}

/* ========= ç»“å±€åˆ¤å®šï¼ˆå¤šç»“å±€ï¼‰ ========= */
function endGame(){
  State.meta.ended = true;

  const P = State.player;

  // ç”œå® æ¡ä»¶ï¼šå¥½æ„Ÿé«˜ + è­¦å‘Šä¸çˆ† + ä½ è¿˜æ´»ç€
  const sweet = (P.princeFavor>=65 && P.sysWarn<=70 && P.hp>20);

  // æƒè°‹é»‘åŒ–ï¼šè°‹ç•¥é«˜ + è­¦å‘Šé«˜ï¼ˆä½ ç¡¬æ‰›ï¼‰+ å£°æœ›/å®¶æ—è‡³å°‘ä¸å´©
  const darkPower = (P.strategy>=85 && P.sysWarn>=55 && P.hp>15 && P.clanRep>=60);

  // è‡ªç”±æ€æ¡Œï¼šæ€æ¡Œå€¼é«˜ + åç¦»é«˜ï¼ˆå®Œå…¨ä¸å›å¤´ï¼‰+ å¿ƒæ™ºè¿˜è¡Œ
  const free = (P.flip>=60 && P.dev>=70 && P.mind>=35);

  // BEï¼šå¥åº·å¤ªä½æˆ–ç³»ç»Ÿçˆ†è¡¨
  const bad1 = (P.hp<=15);
  const bad2 = (P.sysWarn>=90 && P.mind<=25);

  let endingTitle = "";
  let endingText = "";

  if(bad1){
    endingTitle="BE Â· ç—…éª¨æ²‰é¦™";
    endingText=`ä½ æ‰›è¿‡å¤ªå¤šæ¬¡æƒ©ç½šï¼Œèº«ä½“å…ˆå›å˜äº†ã€‚\nç³»ç»Ÿå†·å†°å†°åœ°å®£å¸ƒâ€œä¿®æ­£å®Œæˆâ€ã€‚\nä½ èººåœ¨å¸ä¸­ï¼Œå¬è§å¤–é¢é›ªè½ã€‚\nä½ æ²¡æœ‰è¾“ç»™è°â€”â€”ä½ è¾“ç»™äº†ç–¼ã€‚`;
  }else if(bad2){
    endingTitle="BE Â· ç³»ç»Ÿå°å–‰";
    endingText=`ç³»ç»Ÿè­¦å‘Šå€¼çˆ†è¡¨ã€‚\nå®ƒç»ˆäºä¸è£…äº†ï¼šæƒ©ç½šåƒé“é“¾ä¸€æ ·å‹’ä½ä½ ã€‚\nä½ çœ‹è§å¤ªå­å†²è¿›æ¥ï¼Œå´è¢«â€œè§„åˆ™â€éš”å¼€ã€‚\nä½ ç¬‘ï¼šâ€œåŸæ¥è¿™å°±æ˜¯å‰§æƒ…çš„ç¥ã€‚â€\nç„¶åä½ ç”¨æœ€åä¸€ç‚¹åŠ›æ°”â€”â€”æŠŠé‚£ç¥ä¹Ÿéª‚ç¢ã€‚`;
  }else if(sweet){
    endingTitle="HE Â· ç”œå® å¹¶è‚©";
    endingText=`å¤ªå­åœ¨æœå ‚ä¸Šç‰µèµ·ä½ çš„æ‰‹ã€‚\nä»–ç”¨æœ€å†·çš„å£°éŸ³å®£å¸ƒï¼š\nâ€œå¥¹ä¸æ˜¯æ£‹å­ï¼Œæ˜¯å­¤çš„å¹¶è‚©ã€‚â€\nä½ ç»ˆäºä¸ç”¨è·ªç€æ´»ã€‚\nä½ ä»¬æŠŠæ—¥å­è¿‡æˆä¸€æŠŠåˆ€â€”â€”ä¹Ÿè¿‡æˆä¸€ç›ç¯ã€‚`;
  }else if(darkPower){
    endingTitle="TE Â· æƒè°‹ç™»é¡¶";
    endingText=`ä½ èµ¢äº†ã€‚\nä¸æ˜¯é æ¸©æŸ”ï¼Œæ˜¯é æŠŠæ¯ä¸€æ¡è§„åˆ™éƒ½æ‹†å¼€é‡ç»„ã€‚\nå¤ªå­çœ‹ç€ä½ ï¼Œçœ¼é‡Œæ˜¯çˆ±ï¼Œä¹Ÿæ˜¯ç•ã€‚\nä½ æˆäº†æœå ‚ä¸Šæœ€é”‹åˆ©çš„å½±ã€‚\næœ‰äººè¯´ä½ é»‘åŒ–ã€‚\nä½ ç¬‘ï¼šä¸ï¼Œæˆ‘åªæ˜¯ç»ˆäºå­¦ä¼šäº†â€œå¼ºè€…çš„è¯­è¨€â€ã€‚`;
  }else if(free){
    endingTitle="TE Â· è‡ªç”±æ€æ¡Œ";
    endingText=`ä½ æœ€åä¸€æ¬¡æ€æ¡Œï¼ŒæŠŠâ€œå¥³é…å‘½è¿â€æ€ç©¿ã€‚\nç³»ç»Ÿå´©æºƒï¼Œå‰§æƒ…æ–­è£‚ã€‚\nä½ è½¬èº«ç¦»å¼€ä¸œå®«ï¼Œç¦»å¼€ä¸ç›¸ï¼Œç¦»å¼€æ‰€æœ‰äººçš„å‰§æœ¬ã€‚\nä½ ä¸åšè°çš„å¦»ï¼Œä¸åšè°çš„æ£‹ã€‚\nä½ åšä½ è‡ªå·±ã€‚`;
  }else{
    endingTitle="NE Â· ä»åœ¨è·¯ä¸Š";
    endingText=`ä½ æ²¡æœ‰å½»åº•ç”œï¼Œä¹Ÿæ²¡æœ‰å½»åº•é»‘ã€‚\nä½ åªæ˜¯æ´»ä¸‹æ¥ï¼Œå¹¶ä¸”æŠŠå‘½è¿å¾€ä½ è¿™è¾¹æ‹‰äº†ä¸€ç‚¹ã€‚\nå¤ªå­ä¸ä½ ä¿æŒè·ç¦»ï¼Œå´ä¸å†å†·ã€‚\nè‹æ¸…è²è¢«å‹ä½ï¼Œå´æœªæ­»ã€‚\nä½ çŸ¥é“ï¼šå¦‚æœè¿˜æœ‰Day21ï¼Œä½ ä¼šæ›´ç‹ ï¼Œä¹Ÿä¼šæ›´ä¼šçˆ±ã€‚`;
  }

  typeText(`ã€Day20 Â· ç»ˆå±€åˆ¤å®šã€‘\n\n${endingTitle}\n\n${endingText}\n\nï¼ˆä½ å¯ä»¥æ¸…æ¡£é‡å¼€ï¼Œæˆ–å­˜æ¡£ç•™å¿µï¼‰`);
  checkAchievements();
  renderAll("å·²è§¦å‘ç»“å±€ï¼šä½ å¯ä»¥ã€å­˜æ¡£ã€‘æˆ–ã€æ¸…æ¡£é‡å¼€ã€‘ã€‚");
  $("btnEnd").disabled = true;
}

/* ========= æˆå°± ========= */
function checkAchievements(){
  let got = 0;
  for(const a of Achievements){
    if(State.unlockedAch[a.id]) continue;
    if(a.cond(State)){
      State.unlockedAch[a.id] = true;
      got++;
      tip(`è§£é”æˆå°±ï¼š${a.name}`, "good");
    }
  }
  return got;
}

/* ========= è‡ªå®šä¹‰è¡ŒåŠ¨ ========= */
function customAction(){
  const txt = prompt("è¾“å…¥ä½ çš„è¡ŒåŠ¨ï¼ˆä¼šä½œä¸ºå‰§æƒ…æ–‡å­—è¿½åŠ ï¼›å¹¶ç»™ä¸€ç‚¹éšæœºæ•°å€¼å˜åŒ–ï¼‰");
  if(!txt) return;

  State.meta.customCount++;
  State.phase="RESOLVE";
  State.meta.lastAction="CUSTOM";
  State.focus="self";

  // è½»éšæœºæ•°å€¼ï¼Œè®©è‡ªå®šä¹‰ä¹Ÿæœ‰â€œåŠ¨â€
  const r = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const delta = {
    mind: r(-2,3),
    hp: r(-2,3),
    strategy: r(0,3),
    princeFavor: r(0,2),
    sysWarn: r(0,3),
    dev: r(0,3),
    flip: r(0,3)
  };

  typeText(`ã€è‡ªå®šä¹‰è¡ŒåŠ¨ã€‘\n${txt}\n\nä½ æŠŠâ€œå‰§æœ¬â€æŒ‰åœ¨åœ°ä¸Šæ‘©æ“¦äº†ä¸€ä¸‹ã€‚\nç³»ç»ŸçŸ­æš‚å¤±è¯­ã€‚`);
  applyDelta(delta);
  checkAchievements();
  renderAll("ç»“ç®—å®Œæˆã€‚ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ã€‚");
  $("btnEnd").disabled = false;
}

/* ========= AI ç»­å†™ï¼ˆå¯é€‰ï¼‰ =========
   é‡è¦æé†’ï¼šæŠŠ API Key æ”¾æµè§ˆå™¨=ä¼šæš´éœ²ï¼
   å¦‚æœä½ åªæ˜¯è‡ªå·±ç©å¯ç”¨ï¼›å…¬å¼€ç«™ç‚¹ä¸å»ºè®®ã€‚
*/
async function aiContinue(){
  const hint = $("aiHint");
  if(!State.api.baseUrl || !State.api.apiKey){
    tip("å…ˆç‚¹ã€è®¾ç½®AIå¯†é’¥ã€‘", "warn");
    return;
  }

  const promptText =
`ä½ æ˜¯ä¸­æ–‡äº’åŠ¨æ–‡å­—æ¸¸æˆå†™æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹çŠ¶æ€ç»§ç»­å†™â€œä¸‹ä¸€æ®µå‰§æƒ…â€ï¼ˆ200-400å­—ï¼‰ï¼Œå¹¶ç»™å‡º 3 ä¸ªå¯é€‰è¡ŒåŠ¨ï¼ˆæ¯ä¸ªè¡ŒåŠ¨ä¸€å¥è¯ï¼‰ã€‚
è¦æ±‚ï¼šç”œå® ä¸æƒè°‹éƒ½å¯å‡ºç°ï¼Œè¯­æ°”å¸¦ä¸€ç‚¹çˆ½æ–‡æ€æ¡Œæ„Ÿï¼Œä¸è¦å‡ºç°ç°ä»£å˜é‡æœ¯è¯­ã€‚
â€”â€”
Day=${State.day}
ä¸»çº¿=${Days[State.day-1].main}
æ•°å€¼ï¼šé£å${State.player.glamour} è°‹ç•¥${State.player.strategy} å¿ƒæ™º${State.player.mind} å¥åº·${State.player.hp} æ€æ¡Œ${State.player.flip} åç¦»${State.player.dev} å£°æœ›${State.player.nobleRep} å®¶æ—${State.player.clanRep} è­¦å‘Š${State.player.sysWarn} å¥½æ„Ÿ${State.player.princeFavor} æ€€ç–‘${State.player.suSusp}
ä¸Šä¸€åŠ¨ä½œ=${State.meta.lastAction}
â€”â€”
è¯·è¾“å‡ºï¼š
ã€å‰§æƒ…ã€‘
...
ã€é€‰é¡¹ã€‘
1) ...
2) ...
3) ...
`;

  hint.textContent = "AIè¯·æ±‚ä¸­â€¦";

  try{
    // å…¼å®¹ OpenAI é£æ ¼ /v1/chat/completions
    const url = State.api.baseUrl.replace(/\/$/,"") + "/v1/chat/completions";

    const res = await fetch(url, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + State.api.apiKey
      },
      body: JSON.stringify({
        model: State.api.model || "gpt-4o-mini",
        messages: [
          {role:"system", content:"ä½ æ˜¯äº’åŠ¨æ–‡å­—æ¸¸æˆå¼•æ“çš„å‰§æƒ…å†™æ‰‹ã€‚"},
          {role:"user", content: promptText}
        ],
        temperature: 0.85
      })
    });

    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status} ${t.slice(0,200)}`);
    }

    const data = await res.json();
    const text = data?.choices?.[0]?.message?.content || "";
    if(!text) throw new Error("è¿”å›ä¸ºç©º");

    // æŠŠ AI æ–‡æœ¬å¡è¿›å‰§æƒ…
    typeText(text);
    hint.textContent = "AIæˆåŠŸè¿”å›ï¼šä½ å¯ä»¥ç»§ç»­æ‰‹åŠ¨é€‰æ‹©å››å¤§è¡ŒåŠ¨ï¼Œæˆ–ç”¨è‡ªå®šä¹‰è¡ŒåŠ¨å†™è¿›çŠ¶æ€ã€‚";
    tip("AIç»­å†™æˆåŠŸ", "good");

  }catch(e){
    hint.textContent = "AIè¯·æ±‚å¼‚å¸¸ï¼š" + String(e.message || e);
    tip("AIè¯·æ±‚å¼‚å¸¸ï¼ˆçœ‹å³ä¾§æç¤ºï¼‰", "bad");
  }
}

function setApi(){
  const base = prompt("è¾“å…¥ Base URLï¼ˆä¾‹ï¼šhttps://api.xxx.com ï¼‰\næ³¨æ„å¿…é¡»æ”¯æŒ /v1/chat/completions", State.api.baseUrl || "");
  if(base===null) return;

  const key = prompt("è¾“å…¥ API Keyï¼ˆæ³¨æ„ï¼šæ”¾ç½‘é¡µä¼šæš´éœ²ï¼Œå…¬å¼€ç«™ç‚¹ä¸å»ºè®®ï¼‰", State.api.apiKey || "");
  if(key===null) return;

  const model = prompt("è¾“å…¥æ¨¡å‹åï¼ˆä¾‹å¦‚ gpt-4o-mini / gpt-4o ç­‰ï¼‰", State.api.model || "gpt-4o-mini");
  if(model===null) return;

  State.api.baseUrl = base.trim();
  State.api.apiKey = key.trim();
  State.api.model = model.trim() || "gpt-4o-mini";

  localStorage.setItem("GAME_AI_BASE", State.api.baseUrl);
  localStorage.setItem("GAME_AI_KEY", State.api.apiKey);
  localStorage.setItem("GAME_AI_MODEL", State.api.model);

  $("aiHint").textContent = State.api.baseUrl ? `å·²è®¾ç½®ï¼š${State.api.baseUrl}ï¼ˆæ¨¡å‹ï¼š${State.api.model}ï¼‰` : "";
  tip("AIé…ç½®å·²ä¿å­˜ï¼ˆæœ¬æœºæµè§ˆå™¨ï¼‰", "good");
}

/* ========= å­˜æ¡£/è¯»æ¡£/æ¸…æ¡£ ========= */
function saveGame(){
  localStorage.setItem("GAME_SAVE_ULT", JSON.stringify(State));
  tip("å­˜æ¡£æˆåŠŸï¼ˆlocalStorageï¼‰", "good");
}
function loadGame(){
  const raw = localStorage.getItem("GAME_SAVE_ULT");
  if(!raw){ tip("æ²¡æœ‰å­˜æ¡£", "warn"); return; }
  try{
    const obj = JSON.parse(raw);
    // ç®€å•å…¼å®¹
    Object.assign(State, obj);
    tip("è¯»æ¡£æˆåŠŸ", "good");
    renderAll("è¯»æ¡£å®Œæˆã€‚");
    typeText(Days[State.day-1].intro);
  }catch(e){
    tip("è¯»æ¡£å¤±è´¥ï¼š" + String(e.message||e), "bad");
  }
}
function resetGame(){
  if(!confirm("ç¡®å®šæ¸…æ¡£é‡å¼€ï¼Ÿ")) return;
  localStorage.removeItem("GAME_SAVE_ULT");
  location.reload();
}

/* ========= æˆå°±çª—å£ ========= */
function openAchievements(){
  openModal(
    "ğŸ† æˆå°±ç³»ç»Ÿ",
    "è§£é”ä¼šè‡ªåŠ¨ä¿å­˜è¿›å­˜æ¡£ï¼ˆè¯»æ¡£ä¹Ÿä¼šæ¢å¤ï¼‰",
    ()=>{
      const list = Achievements.map(a=>{
        const ok = !!State.unlockedAch[a.id];
        return `
          <div class="item">
            <h4>${ok?"âœ…":"â¬œï¸"} ${a.name}</h4>
            <div class="desc">${a.desc}</div>
            <div class="meta"><span class="badge2">ID: ${a.id}</span><span>${ok?"å·²è§£é”":"æœªè§£é”"}</span></div>
          </div>
        `;
      }).join("");
      return `<div class="grid">${list}</div>`;
    }
  );
}

/* ========= é€šç”¨ Modal ========= */
function openModal(title, sub, bodyFn){
  $("modalTitle").textContent = title;
  $("modalSub").textContent = sub;
  $("modalBody").innerHTML = (typeof bodyFn==="function") ? bodyFn() : String(bodyFn||"");
  $("mask").classList.add("show");
}
function closeModal(){ $("mask").classList.remove("show"); }

/* ========= æ€»æ¸²æŸ“ ========= */
function renderAll(extra=""){
  renderPortrait();
  renderSubtitle();
  renderOptions();
  renderStats();
  renderSystem(extra);

  // AIæç¤º
  const hint = $("aiHint");
  if(State.api.baseUrl && State.api.apiKey){
    hint.textContent = `AIå·²é…ç½®ï¼š${State.api.baseUrl}ï¼ˆæ¨¡å‹ï¼š${State.api.model}ï¼‰`;
  }else{
    hint.textContent = "AIæœªé…ç½®ï¼šç‚¹ã€è®¾ç½®AIå¯†é’¥ã€‘ï¼ˆæ³¨æ„å…¬å¼€ç«™ç‚¹ä¸å»ºè®®æŠŠKeyæ”¾å‰ç«¯ï¼‰";
  }
}

/* ========= æŒ‰é’®ç»‘å®š ========= */
$("btnEnd").onclick = nextDay;
$("btnCustom").onclick = customAction;
$("btnAI").onclick = aiContinue;
$("btnApi").onclick = setApi;
$("btnSave").onclick = saveGame;
$("btnLoad").onclick = loadGame;
$("btnReset").onclick = resetGame;
$("btnAch").onclick = openAchievements;
$("btnClose").onclick = closeModal;
$("mask").addEventListener("click", (e)=>{ if(e.target.id==="mask") closeModal(); });

$("btnJump20").onclick = ()=>{
  if(!confirm("ç¡®å®šè·³åˆ°Day20å¹¶è§¦å‘ç»“å±€åˆ¤å®šï¼Ÿ")) return;
  State.day = 20;
  State.phase = "RESOLVE";
  State.focus = "system";
  typeText(Days[19].intro);
  renderAll("å·²è·³è½¬åˆ°Day20ï¼šç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è§¦å‘ç»“å±€ã€‚");
  $("btnEnd").disabled = false;
};

/* ========= åˆå§‹åŒ– ========= */
(function init(){
  renderAll("åˆå§‹åŒ–å®Œæˆã€‚é€‰æ‹©ä½ çš„è¡ŒåŠ¨ã€‚");

  // è¿›å…¥ Day1 intro
  typeText(Days[0].intro);

  // å…³é”®ï¼šå¼€å§‹æ—¶å¿…é¡»â€œå…ˆé€‰åç»“æŸâ€ï¼Œæ‰€ä»¥ç¦ç”¨ç»“æŸæŒ‰é’®
  $("btnEnd").disabled = true;
})();
</script>
</body>
</html>
