<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¿®ä»™å®—é—¨ç³»ç»ŸÂ·ä¸–ç•Œå¹´è¡¨è‡ªåŠ¨æ¨è¿›ç‰ˆï¼ˆæ‹çˆ±/èƒŒå›/æƒè°‹/AIå›åˆï¼‰</title>
  <style>    :root{      --bg:#0b0f17;      --panel:rgba(255,255,255,.06);      --panel2:rgba(255,255,255,.09);      --border:rgba(255,255,255,.12);      --border2:rgba(255,255,255,.18);      --text:rgba(255,255,255,.92);      --muted:rgba(255,255,255,.68);      --muted2:rgba(255,255,255,.54);      --good:#57ffb6;      --bad:#ff5d7a;      --warn:#ffd36a;      --accent:#7aa7ff;      --accent2:#b18cff;      --shadow:0 18px 60px rgba(0,0,0,.45);      --radius:18px;      --radius2:14px;      --gap:14px;      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;      --sans:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,"Noto Sans CJK SC",sans-serif;    }    *{ box-sizing:border-box; }    html,body{ height:100%; }    body{      margin:0;      font-family:var(--sans);      background:        radial-gradient(900px 500px at 20% 10%, rgba(122,167,255,.22), transparent 55%),        radial-gradient(800px 450px at 80% 20%, rgba(177,140,255,.18), transparent 55%),        radial-gradient(900px 650px at 50% 90%, rgba(87,255,182,.10), transparent 55%),        var(--bg);      color:var(--text);      overflow-x:hidden;    }    header{      padding:18px 16px 10px;      max-width:1200px;      margin:0 auto;      display:flex;      gap:14px;      align-items:center;      justify-content:space-between;      flex-wrap:wrap;    }    .brand{ display:flex; gap:12px; align-items:center; min-width:0; }    .logo{      width:44px;height:44px;border-radius:16px;      background:linear-gradient(135deg, rgba(122,167,255,.9), rgba(177,140,255,.85));      box-shadow:var(--shadow);      border:1px solid rgba(255,255,255,.2);      position:relative;    }    .logo:after{ content:"âœ¦"; position:absolute; inset:0; display:grid; place-items:center; font-size:18px; opacity:.9; }    .titlewrap{ min-width:0; }    .title{      font-size:16px; font-weight:900; letter-spacing:.2px; line-height:1.1;      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;    }    .subtitle{      margin-top:2px;      font-size:12px; color:var(--muted);      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;    }    .top-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }    button, .chip{      border:1px solid var(--border);      background:rgba(255,255,255,.06);      color:var(--text);      padding:10px 12px;      border-radius:999px;      cursor:pointer;      transition:transform .08s ease,border-color .12s ease,background .12s ease;      user-select:none;      font-weight:800;      letter-spacing:.2px;    }    button:hover{ transform:translateY(-1px); border-color:var(--border2); background:rgba(255,255,255,.08); }    button:active{ transform:translateY(0) scale(.99); }    .chip{ cursor:default; display:inline-flex; gap:8px; align-items:center; padding:9px 12px; font-weight:900; }    .dot{ width:8px; height:8px; border-radius:99px; background:var(--accent); box-shadow:0 0 0 4px rgba(122,167,255,.12); }    main{ max-width:1200px; margin:0 auto; padding:10px 16px 22px; }    .grid{      display:grid;      grid-template-columns: 1.35fr .95fr;      grid-template-rows: 1fr 1fr;      gap:var(--gap);      min-height:calc(100vh - 120px);    }    @media (max-width: 980px){      .grid{ grid-template-columns:1fr; grid-template-rows:auto; }    }    .card{      background:linear-gradient(180deg, var(--panel), rgba(255,255,255,.03));      border:1px solid var(--border);      border-radius:var(--radius);      box-shadow:var(--shadow);      overflow:hidden;      position:relative;    }    .card .head{      padding:14px 14px 10px;      display:flex;      align-items:flex-start;      justify-content:space-between;      gap:10px;      border-bottom:1px solid rgba(255,255,255,.08);      background:rgba(255,255,255,.03);      flex-wrap:wrap;    }    .card h2{      margin:0;      font-size:14px;      letter-spacing:.3px;      font-weight:950;      display:flex;      align-items:center;      gap:10px;    }    .tag{      font-size:11px;      color:var(--muted);      font-weight:900;      padding:4px 10px;      border-radius:999px;      border:1px solid rgba(255,255,255,.12);      background:rgba(0,0,0,.15);      white-space:nowrap;    }    .card .body{ padding:14px; height:100%; }    /* Story */    .story{      font-size:14px;      line-height:1.75;      color:rgba(255,255,255,.9);      white-space:pre-wrap;      min-height:230px;    }    .typing-caret{      display:inline-block;      width:8px;height:1em;      transform:translateY(2px);      margin-left:2px;      border-right:2px solid rgba(255,255,255,.75);      animation:blink 1s steps(2,end) infinite;    }    @keyframes blink { 50%{ opacity:.1; } }    /* Stats */    .stats{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }    .stat{      border:1px solid rgba(255,255,255,.10);      border-radius:var(--radius2);      padding:10px 10px;      background:rgba(0,0,0,.12);      overflow:hidden;    }    .stat .k{ font-size:11px; color:var(--muted2); font-weight:950; letter-spacing:.3px; }    .stat .v{ margin-top:6px; font-family:var(--mono); font-size:13px; font-weight:950; letter-spacing:.2px; }    .bar{ height:8px; margin-top:10px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.08); }    .bar > i{ display:block; height:100%; width:50%; background:linear-gradient(90deg, rgba(122,167,255,.95), rgba(87,255,182,.9)); border-radius:999px; }    /* Options */    .options{ display:flex; flex-direction:column; gap:10px; }    .opt{      display:flex; gap:10px; align-items:flex-start;      border:1px solid rgba(255,255,255,.12);      background:rgba(0,0,0,.12);      padding:10px 12px;      border-radius:var(--radius2);      cursor:pointer;      transition:transform .08s ease,border-color .12s ease,background .12s ease;    }    .opt:hover{ transform:translateY(-1px); border-color:rgba(255,255,255,.20); background:rgba(0,0,0,.18); }    .opt:active{ transform:translateY(0) scale(.995); }    .badge{      min-width:30px;height:30px;border-radius:12px;      display:grid;place-items:center;      font-weight:1000;      background:linear-gradient(135deg, rgba(122,167,255,.9), rgba(177,140,255,.65));      border:1px solid rgba(255,255,255,.16);      box-shadow:0 10px 30px rgba(0,0,0,.25);    }    .opt .t{ font-weight:950; font-size:13px; letter-spacing:.2px; }    .opt .d{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.55; }    .opt.key{      border-color:rgba(255,211,106,.45);      background:linear-gradient(180deg, rgba(255,211,106,.12), rgba(0,0,0,.14));    }    .opt.key .badge{ background:linear-gradient(135deg, rgba(255,211,106,.95), rgba(122,167,255,.7)); }    /* Free input */    .free-input{      display:flex; gap:10px; align-items:center;      margin-top:10px;      padding:10px;      border-radius:var(--radius2);      border:1px dashed rgba(255,255,255,.16);      background:rgba(0,0,0,.10);      flex-wrap:wrap;    }    .free-input input{      flex:1;      min-width:180px;      background:rgba(255,255,255,.06);      border:1px solid rgba(255,255,255,.12);      color:var(--text);      border-radius:12px;      padding:10px 12px;      outline:none;      font-weight:800;    }    .free-input input::placeholder{ color:rgba(255,255,255,.35); font-weight:800; }    .free-input button{      padding:10px 14px;      border-radius:12px;      border:1px solid rgba(255,255,255,.16);      background:rgba(122,167,255,.18);    }    /* Log */    .log{ display:flex; flex-direction:column; gap:10px; height:100%; }    .loglist{ flex:1; overflow:auto; padding-right:6px; }    .logitem{      border:1px solid rgba(255,255,255,.10);      background:rgba(0,0,0,.10);      padding:10px 12px;      border-radius:var(--radius2);      margin-bottom:10px;    }    .logitem .time{ font-family:var(--mono); font-size:11px; color:var(--muted2); font-weight:900; letter-spacing:.2px; }    .logitem .msg{ margin-top:6px; font-size:12px; color:rgba(255,255,255,.85); line-height:1.55; white-space:pre-wrap; }    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }    .pill{      padding:6px 10px;      border-radius:999px;      border:1px solid rgba(255,255,255,.12);      background:rgba(255,255,255,.05);      color:var(--muted);      font-size:11px;      font-weight:900;      letter-spacing:.2px;    }    /* Float */    .float{      position:fixed; z-index:9999;      padding:8px 10px; border-radius:12px;      border:1px solid rgba(255,255,255,.18);      background:rgba(0,0,0,.55);      box-shadow:var(--shadow);      font-family:var(--mono);      font-weight:1000; font-size:12px;      pointer-events:none;      transform:translate(-50%,-50%);      animation:floatUp 1.05s ease forwards;    }    .float.good{ color:var(--good); }    .float.bad{ color:var(--bad); }    .float.warn{ color:var(--warn); }    @keyframes floatUp{      0%{ opacity:0; transform:translate(-50%,-50%) translateY(6px) scale(.98); }      15%{ opacity:1; }      100%{ opacity:0; transform:translate(-50%,-50%) translateY(-34px) scale(1.02); }    }    /* AI panel */    .ai-panel{      display:grid;      gap:10px;      border:1px solid rgba(255,255,255,.10);      background:rgba(0,0,0,.12);      padding:10px;      border-radius:var(--radius2);      margin-top:10px;    }    .ai-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }    .ai-row input, .ai-row select, .ai-row textarea{      background:rgba(255,255,255,.06);      border:1px solid rgba(255,255,255,.12);      color:var(--text);      border-radius:12px;      padding:10px 12px;      outline:none;      font-weight:800;      font-family:var(--sans);    }    .ai-row textarea{ width:100%; min-height:90px; resize:vertical; font-family:var(--mono); font-weight:800; font-size:12px; }    .ai-row .w1{ flex:1; min-width:180px; }    .ai-row .w2{ flex:2; min-width:220px; }    .ai-help{ color:var(--muted); font-size:12px; line-height:1.6; }    footer{      max-width:1200px;      margin:0 auto;      padding:0 16px 18px;      color:var(--muted2);      font-size:12px;      line-height:1.6;    }    .kbd{      font-family:var(--mono);      padding:2px 7px;      border-radius:9px;      border:1px solid rgba(255,255,255,.14);      background:rgba(0,0,0,.22);      color:rgba(255,255,255,.8);      font-weight:900;    }  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div class="titlewrap">
      <div class="title">ä¿®ä»™å®—é—¨ç³»ç»ŸÂ·ä¸–ç•Œå¹´è¡¨è‡ªåŠ¨æ¨è¿›ç‰ˆï¼ˆæ‹çˆ± / èƒŒå› / æƒè°‹ / AIå›åˆï¼‰</div>
      <div class="subtitle">ä¸–ç•Œæ—¶é—´è‡ªåŠ¨æ¨è¿› Â· NPCå¥½æ„Ÿ/ä¿¡ä»»/é‡å¿ƒ/é»‘åŒ– Â· å®—é—¨å†…æ”¿&å®¶æ—åŠ¿åŠ› Â· ä¸–ç•Œäº‹ä»¶æ—¶é—´çº¿ Â· åæ´¾é˜µè¥</div>
    </div>
  </div>

  <div class="top-actions">
    <span class="chip"><span class="dot"></span><span id="chipRound">å›åˆï¼š1</span></span>
    <span class="chip"><span class="dot" style="background:var(--accent2)"></span><span id="chipSeed">ä¸–ç•Œçº¿ï¼šseed</span></span>
    <span class="chip"><span class="dot" style="background:var(--good)"></span><span id="chipDate">æ—¶é—´ï¼š1å¹´æ˜¥Â·1æ—¥</span></span>
    <button id="btnSave">ä¿å­˜</button>
    <button id="btnLoad">è¯»å–</button>
    <button id="btnReset">é‡å¼€</button>
  </div>
</header>

<main>
  <section class="grid">
    <!-- å‰§æƒ… -->
    <article class="card">
      <div class="head">
        <h2>ğŸ“œ å‰§æƒ…æ¨è¿› <span class="tag" id="tagPhase">å¼€å±€</span></h2>
        <span class="tag" id="tagPlace">å‡¡å°˜</span>
      </div>
      <div class="body">
        <div class="story" id="story"></div>

        <div class="ai-panel">
          <div class="ai-row">
            <label class="tag" title="å¼€å¯åï¼Œæ¯å›åˆä¼šä¼˜å…ˆè°ƒç”¨AIç”Ÿæˆå‰§æƒ…å’Œé€‰é¡¹">AI</label>
            <select id="aiMode" class="w1">
              <option value="off">å…³é—­ï¼ˆæœ¬åœ°ä¸–ç•Œå¼•æ“ï¼‰</option>
              <option value="gemini">Geminiï¼ˆgenerateContentï¼‰</option>
              <option value="openai">OpenAIå…¼å®¹ï¼ˆ/v1/chat/completionsï¼‰</option>
              <option value="custom">è‡ªå®šä¹‰HTTPæ¥å£</option>
            </select>
            <input id="aiEndpoint" class="w2" placeholder="Endpointï¼Œä¾‹å¦‚ï¼šhttps://.../v1/chat/completions æˆ– https://...:generateContent" />
          </div>

          <div class="ai-row">
            <input id="aiKey" class="w2" placeholder="API Keyï¼ˆä»…ä¿å­˜åœ¨æœ¬æœº localStorageï¼‰" />
            <button id="btnAiTest">æµ‹è¯•AI</button>
            <button id="btnAiSave">ä¿å­˜AIé…ç½®</button>
          </div>

          <div class="ai-row">
            <textarea id="aiTemplate" placeholder="å¯é€‰ï¼šè‡ªå®šä¹‰è¯·æ±‚æ¨¡æ¿ï¼ˆJSONï¼‰ã€‚ç•™ç©º=å†…ç½®æ¨¡æ¿ã€‚å˜é‡ï¼š{{prompt}} {{seed}} {{state}}"></textarea>
          </div>

          <div class="ai-help">
            AIå›åˆè¦æ±‚ï¼šè¿”å› JSONï¼ˆstory/options/effectsï¼‰ã€‚ç³»ç»Ÿä¼šåšå®¹é”™ï¼šJSONè§£æå¤±è´¥åˆ™å›é€€åˆ°æœ¬åœ°ä¸–ç•Œå¼•æ“ã€‚<br/>
            å°è´´å£«ï¼šæŠŠæ¨¡å‹æ¸©åº¦è°ƒä½ï¼ˆ0.6å·¦å³ï¼‰æ›´ç¨³å®šï¼›æƒ³æ›´æˆå‰§å°±è°ƒé«˜ï¼ˆ0.9~1.1ï¼‰ã€‚
          </div>
        </div>
      </div>
    </article>

    <!-- çŠ¶æ€ -->
    <article class="card">
      <div class="head">
        <h2>ğŸ§­ çŠ¶æ€é¢æ¿ <span class="tag" id="tagSect">æ•£ä¿®</span></h2>
        <span class="tag" id="tagLinggen">çµæ ¹ï¼šæœªæµ‹</span>
      </div>
      <div class="body">
        <div class="stats" id="stats"></div>
      </div>
    </article>

    <!-- é€‰é¡¹ -->
    <article class="card">
      <div class="head">
        <h2>ğŸ—ï¸ å†³ç­– <span class="tag" id="tagHint">è¯·é€‰æ‹©</span></h2>
        <span class="tag" id="tagNPC">NPCï¼šæœªç™»åœº</span>
      </div>
      <div class="body">
        <div class="options" id="options"></div>
        <div class="free-input">
          <input id="freeText" placeholder="ç¬¬6é¡¹ï¼šè‡ªå®šä¹‰å¯¹ç­–ï¼ˆä¾‹å¦‚ï¼šå‘æŒé—¨å‘Šå¯†ã€æš—ä¸­ç»“ç›Ÿã€å¤œæ¢åº“æˆ¿ã€åˆºæ¢å†…é¬¼ï¼‰" />
          <button id="btnFree">æ‰§è¡Œ</button>
        </div>
      </div>
    </article>

    <!-- æ—¥å¿— -->
    <article class="card">
      <div class="head">
        <h2>ğŸ—‚ï¸ äº‹ä»¶ Â· ä¸–ç•Œå¹´è¡¨ Â· æƒè°‹çº¿</h2>
        <span class="tag">è®°å½•</span>
      </div>
      <div class="body">
        <div class="log">
          <div class="loglist" id="loglist"></div>
          <div class="pillrow" id="pillrow"></div>
        </div>
      </div>
    </article>
  </section>
</main>

<footer>
  ç©æ³•ï¼šæ¯å›åˆè‡ªåŠ¨æ¨è¿›â€œä¸–ç•Œæ—¶é—´â€ï¼Œä¸–ç•Œäº‹ä»¶ä¼šæŒ‰å¹´è¡¨/æ¦‚ç‡è§¦å‘ã€‚NPCæœ‰å¥½æ„Ÿ/ä¿¡ä»»/é‡å¿ƒ/é»‘åŒ–ï¼Œå¯èƒ½æ‹çˆ±ä¹Ÿå¯èƒ½èƒŒå›ã€‚<br/>
  å­˜æ¡£ï¼šä¿å­˜/è¯»å–ä½¿ç”¨ <span class="kbd">localStorage</span>ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨â€œè‡ªå®šä¹‰å¯¹ç­–â€é‡Œå†™ä»»ä½•è¡ŒåŠ¨ï¼ŒAI/æœ¬åœ°å¼•æ“éƒ½ä¼šæ¥ä½å¹¶ç”Ÿæˆä¸‹ä¸€å›åˆã€‚<br/>
</footer>

<script type="module">
/* ===========================
  ä¿®ä»™å®—é—¨ç³»ç»ŸÂ·ä¸–ç•Œå¹´è¡¨è‡ªåŠ¨æ¨è¿›ç‰ˆ
  - ä¿®å¤åŸæ–‡ä»¶çš„è„šæœ¬åµŒå¥—/æœªé—­åˆå¯¼è‡´çš„â€œé€‰é¡¹ä¸åŠ¨/æ— æ³•è¿›ç¬¬äºŒå¤©â€é—®é¢˜
  - åŠ å…¥ä¸–ç•Œå¹´è¡¨ã€æ‹çˆ±èƒŒå›æ”¿æ²»æ–—äº‰ã€NPCå…³ç³»ã€å®—é—¨å†…æ”¿ã€å®¶æ—åŠ¿åŠ›ã€åæ´¾é˜µè¥
  - AIæ¯å›åˆè‡ªåŠ¨ç”Ÿæˆå‰§æƒ…ä¸é€‰é¡¹ï¼ˆå¸¦Promptä¼˜åŒ–ï¼‰
=========================== */

/** ---------- Utils ---------- */
function xmur3(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=(h<<13)|(h>>>19);} return function(){ h=Math.imul(h^(h>>>16),2246822507); h=Math.imul(h^(h>>>13),3266489909); return (h^=h>>>16)>>>0; }; }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; }; }
function makeRng(seedStr){ const seedFn=xmur3(seedStr); return mulberry32(seedFn()); }
function randInt(rng,a,b){ return Math.floor(rng()*(b-a+1))+a; }
function pick(rng,arr){ return arr[randInt(rng,0,arr.length-1)]; }
function clamp01(x){ return Math.max(0,Math.min(1,x)); }
function nowTime(){ const d=new Date(); return d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit",second:"2-digit"}); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

/** ---------- World Data ---------- */
const WORLD = {
  seasons:["æ˜¥","å¤","ç§‹","å†¬"],
  phases:{
    START:{ name:"å¼€å±€Â·å…¥å±€", place:"å‡¡å°˜Â·æµ‹çµå°" },
    SECT:{ name:"å®—é—¨Â·å†…æ”¿ä¸å¤§æ¯”", place:"å±±é—¨Â·å®—åŠ¡å ‚" },
    POLITICS:{ name:"æƒè°‹Â·è”å§»ä¸æš—çº¿", place:"ä¿®çœŸç•ŒÂ·è¯¸åŸŸ" },
    SECRET:{ name:"ç§˜å¢ƒÂ·æœºç¼˜ä¸æ€å±€", place:"æ´å¤©Â·è£‚éš™" },
    OPEN:{ name:"é£èµ·äº‘æ¶Œ", place:"å¤©ä¸‹æ£‹å±€" }
  },
  linggen:{
    elements:["é‡‘","æœ¨","æ°´","ç«","åœŸ"],
    variants:["å†°","é›·","é£","å…‰","æš—","æ¯’"],
    grades:["å‡¡å“","ä¸‹å“","ä¸­å“","ä¸Šå“","æå“","å¤©çµæ ¹"],
    gradeWeights:[8,18,30,26,14,4]
  },
  factions:[
    {id:"orthodox", name:"æ­£é“è¯¸å®—"},
    {id:"imperial", name:"çš‡æƒæœå»·"},
    {id:"families", name:"ä¸–å®¶é—¨é˜€"},
    {id:"demon", name:"é­”é“è¯¸è„‰"},
    {id:"alliance", name:"ä»™ç›Ÿ"}
  ],
  villains:[
    {id:"v_mozun", name:"é­”å°ŠÂ·å¤œæ— çƒ¬", role:"ç»ˆå±€åæ´¾", faction:"demon", vibe:"ä»¥å¤©ä¸‹ä¸ºç‚‰ï¼Œç‚¼äººå¿ƒä¸ºç«", agenda:"ä»¥ç§˜å¢ƒè£‚éš™å¼•é­”æ½®ï¼Œé€¼æ­£é“å†…æ–—è‡ªæ¯"},
    {id:"v_neigui", name:"å¸è¾°ä»¤Â·é—»äººç­–", role:"ä»™ç›Ÿå†…é¬¼", faction:"alliance", vibe:"å†·é™ã€è®²ç§©åºï¼Œå´æœ€æ“…æ”¹ç§©åº", agenda:"æš—ä¸­æ‰¶æŒé­”é“ï¼Œä»¥æˆ˜äº‰é‡å¡‘ä»™ç›ŸæƒæŸ„"},
    {id:"v_shijia", name:"ä¸–å®¶ä¸»æ¯Â·å§œå‡éœœ", role:"æ”¿æ²»åæ´¾", faction:"families", vibe:"æ¸©æŸ”åˆ€ï¼Œåˆ€åˆ€è§è¡€", agenda:"è”å§»åå¹¶å®—é—¨èµ„æºï¼Œæ‰¶å®¶æ—ç™»é¡¶"}
  ],
  npcSeeds:[
    {id:"n_head", name:"æŒé—¨Â·é¡¾ç„éœ„", role:"æŒé—¨", faction:"orthodox", vibe:"æ¸…å†·å¯¡è¨€ï¼Œæœ€é‡è§„çŸ©", hook:"åªè®¤èƒ½æ‰›äº‹çš„å¼Ÿå­"},
    {id:"n_elder1", name:"æ‰§æ³•é•¿è€Â·æ²ˆæ— å’", role:"æ‰§æ³•", faction:"orthodox", vibe:"é“é¢æ— ç§", hook:"ä½ è¶ŠçŸ©ä¸€æ¬¡ï¼Œä»–è®°ä¸€ç¬”"},
    {id:"n_elder2", name:"ä¼ åŠŸé•¿è€Â·é™†å½’é¸¿", role:"ä¼ åŠŸ", faction:"orthodox", vibe:"è¨€å°‘ä½†æŠ¤çŸ­", hook:"æŠ¤çŸ­çš„å‰ææ˜¯ä½ å€¼å¾—"},
    {id:"n_peer1", name:"åŒé—¨Â·æŸ³ç…§å½±", role:"åŒé—¨å¤©éª„", faction:"orthodox", vibe:"ç¬‘æ„æµ…ï¼Œå¿ƒæœºæ·±", hook:"å¥¹ä¼šå¸®ä½ ï¼Œä¹Ÿä¼šåˆ©ç”¨ä½ "},
    {id:"n_peer2", name:"åŒé—¨Â·èŠ±ç»›é›ª", role:"åŒé—¨/æš§æ˜§", faction:"orthodox", vibe:"æ’©æ‹¨äººå¿ƒï¼Œå±é™©åˆè¿·äºº", hook:"ä½ è¶Šæ¸…é†’ï¼Œå¥¹è¶Šæƒ³è®©ä½ å¤±æ§"},
    {id:"n_envoy", name:"æœå»·ä½¿è€…Â·è£´è§‚æ˜Ÿ", role:"é’¦ä½¿", faction:"imperial", vibe:"è¨€è¾å¾—ä½“ï¼Œçœ¼ç¥å´åƒåœ¨ä¼°ä»·", hook:"ä»–ä¸è°ˆæ„Ÿæƒ…ï¼Œåªè°ˆç­¹ç "}
  ],
  timeline:[
    { y:1, m:1, d:3, title:"å®—é—¨æ”¶å¾’é£æ³¢", desc:"åé¢è¢«ä¸–å®¶æ’æ‰‹ï¼Œå¼•å‘å†…æ–—è‹—å¤´", type:"sect" },
    { y:1, m:1, d:8, title:"æœå»·èµ¦ä»¤", desc:"çš‡æƒè¦æ±‚å®—é—¨äº¤ç¨/äº¤äººï¼Œæ”¿æ²»å‹åŠ›ä¸Šå‡", type:"politics" },
    { y:1, m:2, d:6, title:"ç§˜å¢ƒè£‚éš™åˆç°", desc:"å¦–é­”æ°”æ¯æ¸—å‡ºï¼Œé­”é“è¯•æ¢", type:"demon" },
    { y:1, m:3, d:1, title:"è¯¸æ´¾ä¼šç›Ÿ", desc:"ä»™ç›Ÿå¬é›†å„å®—ï¼Œæš—çº¿åŠ¿åŠ›æ¸—é€", type:"alliance" },
    { y:1, m:4, d:10, title:"å®—é—¨å¤§æ¯”", desc:"èƒœè´Ÿä¹‹å¤–ï¼Œå¼€å§‹å‡ºç°â€˜è¢«å®‰æ’â€™çš„å¯¹å±€", type:"sect" },
    { y:2, m:1, d:1, title:"åŒ—å¢ƒå‘Šæ€¥", desc:"ç„å†¥å¼‚åŠ¨/é­”æ½®è¾¹ç¼˜æˆ˜çˆ†å‘", type:"war" }
  ],
  localPrompts:{
    openers:[
      "æ™¨é›¾åœ¨æµ‹çµå°ä¸Šç¿»æ¶Œï¼Œä½ å¬è§ç‰çŸ³é‡Œæœ‰ç»†ç¢çš„å›å“ã€‚",
      "ä½ è¸å…¥å®—åŠ¡å ‚ï¼Œä¼—é•¿è€çš„ç›®å…‰åƒä¸€æŠŠæŠŠå°ºï¼Œé‡ä½ çš„éª¨ã€é‡ä½ çš„å¿ƒã€‚",
      "ç¯ç«ç…§ç€åå†Œï¼ŒæŸäº›åå­—è¢«åœˆçº¢â€”â€”é‚£æ˜¯â€˜è¯¥æ­»â€™çš„äººã€‚"
    ],
    politics:[
      "å®´å¸­ä¸Šçš„ç¬‘éƒ½å¸¦åˆƒã€‚ä½ ç«¯æ¯çš„ä¸€ç¬ï¼Œå·²æœ‰äººåœ¨ç›˜ç®—ä½ è¯¥ç«™å“ªä¸€è¾¹ã€‚",
      "æŸä½ä½¿è€…é€’æ¥ä¸€å°å¯†å‡½ï¼šåªè¦ä½ ç‚¹å¤´ï¼Œå®—é—¨å°±ä¼šå°‘ä¸€ä¸ªæ•Œäººâ€”â€”ä¹Ÿä¼šå¤šä¸€ä¸ªå€ºã€‚"
    ],
    romance:[
      "ä»–/å¥¹é å¾—å¤ªè¿‘ï¼Œè¿‘åˆ°ä½ èƒ½å¬è§å‘¼å¸é‡Œçš„é¢¤ã€‚å¯ä½ æ›´æ¸…æ¥šï¼šè¶Šæ˜¯æ¸©æŸ”ï¼Œè¶Šå¯èƒ½æ˜¯åˆ€ã€‚",
      "ä½ ä»¥ä¸ºé‚£æ˜¯ä¸€å¥æƒ…è¯ï¼Œå¯ç»†æƒ³æ‰æ‡‚ï¼Œé‚£æ˜¯å æœ‰æ¬²å†™æˆçš„å¥‘çº¦ã€‚"
    ]
  }
};

/** ---------- Prompt Optimizer ---------- */
function buildOptimizedPrompt(state, lastAction){
  const s = {
    time: state.time,
    phase: state.phase,
    place: WORLD.phases[state.phase]?.place,
    sect: state.sect?.name || "æ•£ä¿®",
    family: state.family,
    world: state.world,
    stats: state.stats,
    linggen: state.linggen,
    topNPC: Object.values(state.npcs).slice(0,8).map(n=>({
      id:n.id, name:n.name, role:n.role, faction:n.faction,
      favor:n.favor, trust:n.trust, ambition:n.ambition, corruption:n.corruption,
      flags:n.flags
    })),
    threats: state.worldline,
    lastEvents: state.logs.slice(0,4).map(x=>x.title+":"+x.msg).join(" | "),
  };

  return `
ä½ æ˜¯â€œä¿®ä»™+æƒè°‹+æ‹çˆ±+èƒŒå›â€çš„å›åˆåˆ¶å‰§æƒ…å¼•æ“ã€‚è¯·ä¸¥æ ¼æŒ‰JSONè¾“å‡ºï¼Œä¸è¦è¾“å‡ºå¤šä½™æ–‡å­—ã€‚

ã€ä¸–ç•Œè§„åˆ™ã€‘
- æ—¶é—´æ¯å¤©æ¨è¿›ï¼›å¯èƒ½è§¦å‘å¹´è¡¨äº‹ä»¶/éšæœºäº‹ä»¶ã€‚
- NPCæœ‰ï¼šfavorå¥½æ„Ÿ(0-100)ã€trustä¿¡ä»»(0-100)ã€ambitioné‡å¿ƒ(0-100)ã€corruptioné»‘åŒ–(0-100)ã€‚
- å½“ trust<30 ä¸” (ambition>70 æˆ– corruption>80) æ—¶ï¼Œå¯ä»¥è§¦å‘èƒŒå›/é˜´è°‹äº‹ä»¶ï¼ˆå¿…é¡»åˆç†ä¼ç¬”ï¼‰ã€‚
- å¿…é¡»åŒ…å«ï¼šæƒ…ç»ªã€å¯¹è¯ã€æƒè°‹ç®—è®¡ã€å…³ç³»å˜åŒ–ã€ä¼ç¬”ã€‚
- å¿…é¡»æä¾› 3~5 ä¸ªé€‰é¡¹ã€‚æ¯ä¸ªé€‰é¡¹å¿…é¡»å¸¦ effectsï¼ˆstats/relations/world/sect/family ä»»æ„ç»„åˆï¼‰ã€‚

ã€ä¸»è§’çŠ¶æ€(JSON)ã€‘
${JSON.stringify(s, null, 2)}

ã€ç©å®¶ä¸Šä¸€æ­¥è¡ŒåŠ¨ã€‘
${lastAction ? lastAction : "æ— ï¼ˆå¼€å±€ï¼‰"}

ã€è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼JSONï¼‰ã€‘
{
  "story": "æœ¬å›åˆå‰§æƒ…ï¼ˆä¸­æ–‡ï¼Œå¸¦å¿ƒç†+å¯¹è¯+æƒè°‹/æƒ…æ„Ÿï¼‰",
  "tags": {"phase":"...", "place":"...", "npcTag":"..."},
  "options": [
    {"title":"...", "desc":"...", "effects": {
      "stats": {"rep": 0, "luck": 0},
      "relations": {"npcId": {"favor": 0, "trust": 0, "ambition": 0, "corruption": 0}},
      "sect": {"stability":0, "treasury":0, "elderInfluence": {"n_elder1":0}},
      "family": {"prestige":0, "wealth":0, "power":0},
      "world": {"imperialStability":0, "demonPressure":0}
    }}
  ],
  "timeline_add": [{"y":1,"m":1,"d":1,"title":"...","desc":"..."}]
}

æ³¨æ„ï¼šeffects æ•°å€¼æ˜¯å°å¹…å¢å‡ï¼ˆ-10~+10ä¸ºä¸»ï¼‰ï¼Œä¸è¦ä¸€å›åˆçˆ†ç‚¸ã€‚
`.trim();
}

/** ---------- Model ---------- */
const STAT_META = [
  { key:"luck", label:"æ°”è¿", type:"number", min:0, max:100, init:62 },
  { key:"insight", label:"æ‚Ÿæ€§", type:"number", min:0, max:100, init:58 },
  { key:"will", label:"å¿ƒæ€§", type:"number", min:-100, max:100, init:6 },
  { key:"health", label:"å¥åº·", type:"number", min:0, max:100, init:72 },
  { key:"sense", label:"ç¥è¯†", type:"number", min:0, max:100, init:55 },
  { key:"rep", label:"å£°æœ›", type:"number", min:0, max:100, init:10 },
  { key:"cp", label:"è´¡çŒ®ç‚¹", type:"number", min:0, max:9999, init:0 },
  { key:"stash", label:"ç§è—çµçŸ³", type:"number", min:0, max:999999, init:30 },
  { key:"realm", label:"å¢ƒç•Œ", type:"text", init:"ç‚¼æ°”ä¸€å±‚" },
  { key:"favor", label:"ä»™ç›Ÿå¥½æ„Ÿ", type:"number", min:0, max:100, init:20 },
  { key:"karma", label:"å› æœ", type:"number", min:-100, max:100, init:0 },
  { key:"artifact", label:"æœ¬å‘½ç‰©", type:"text", init:"æ— " }
];

class GameModel{
  constructor(){ this.reset(); }

  reset(seedStr){
    const seed = seedStr || `wl_${Date.now()}_${Math.floor(Math.random()*1e9)}`;
    this.seed = seed;
    this.rng = makeRng(seed);

    this.round = 1;
    this.phase = "START";

    this.time = { y:1, m:1, d:1 };
    this.sect = null;

    this.worldline = {
      mainThreat: pick(this.rng, [
        "é‚ªä¿®æ¸—é€ä»™ç›Ÿï¼Œè¯¸æ´¾ä¼šç›Ÿæš—è—è¡€é˜µ",
        "ç§˜å¢ƒè£‚éš™æ‰©å¤§ï¼Œå¦–æ½®å°†è‡³",
        "ä¸–å®¶ä»¥è”å§»åå¹¶å®—é—¨èµ„æºï¼Œå†…æ–—åŠ å‰§",
        "é­”å°Šåœ¨æš—å¤„å¸ƒç‚‰ï¼Œæ¬²ç‚¼å¤©ä¸‹äººå¿ƒ"
      ]),
      hiddenFaction: pick(this.rng, ["ä»™ç›Ÿå†…é¬¼","éšä¸–å®¶æ—","é­”é“è¯¸è„‰","å¤©å¤–æ¥å®¢"]),
      keyTwist: pick(this.rng, ["ä½ èº«ä¸Šæœ‰è¢«å°çš„ç¬¬äºŒçµæ ¹","ä½ æ•‘ä¸‹çš„äººå°†æ¥ä¼šåå™¬ä½ ","ä½ èµ¢çš„é‚£ä¸€å±€å…¶å®è¢«åšäº†å±€","ä½ çš„æ°”è¿è¢«å¤ç‰©ç»‘å®š"])
    };

    this.stats={};
    for(const m of STAT_META) this.stats[m.key] = (m.type==="number") ? Number(m.init) : m.init;

    this.linggen={ element:null, variant:null, grade:null, purity:null, awakened:false };

    this.family={ name:"èŒƒæ°æ—æ”¯", prestige:10, wealth:12, power:8, allies:[], enemies:[] };

    this.sectGov={ stability:50, treasury:40, elderInfluence:{ n_elder1:30, n_elder2:25 } };

    this.world={ imperialStability:55, demonPressure:30, publicFear:20 };

    this.npcs={};
    for(const base of WORLD.npcSeeds.concat(WORLD.villains)) {
      this.npcs[base.id] = {
        id:base.id, name:base.name, role:base.role,
        faction:base.faction, vibe:base.vibe, hook:base.hook || base.agenda || "",
        favor: randInt(this.rng, 20, 55),
        trust: randInt(this.rng, 25, 60),
        ambition: randInt(this.rng, 25, 70),
        corruption: base.faction==="demon" ? randInt(this.rng, 70, 95) : randInt(this.rng, 5, 35),
        flags: []
      };
    }

    this.timeline = deepClone(WORLD.timeline);
    for(const ev of this.timeline) {
      if(ev.type==="alliance" || ev.type==="politics") ev.d = Math.max(1, ev.d + randInt(this.rng, -1, 2));
    }

    this.logs=[];
    this.pills=[];

    this._pushLog("ç³»ç»Ÿ", [
      pick(this.rng, WORLD.localPrompts.openers),
      "",
      `ã€ä¸–ç•Œçº¿ã€‘ä¸»å±æœºï¼š${this.worldline.mainThreat}`,
      `ã€æš—çº¿åŠ¿åŠ›ã€‘${this.worldline.hiddenFaction}`,
      `ã€å…³é”®åè½¬ã€‘${this.worldline.keyTwist}`,
      "",
      "æç¤ºï¼šæ¯å›åˆæ—¶é—´ä¼šæ¨è¿›ï¼›å¹´è¡¨äº‹ä»¶å¯èƒ½è§¦å‘ï¼›NPCå…³ç³»ä¼šè‡ªç„¶æ³¢åŠ¨ã€‚"
    ].join("\n"));

    this.addPill(`ä¸–ç•Œçº¿ï¼š${this.seed.slice(0,10)}â€¦`);
  }

  _pushLog(title,msg){ this.logs.unshift({t:nowTime(), title, msg}); this.logs=this.logs.slice(0,120); }
  addPill(text){ this.pills.unshift(text); this.pills=[...new Set(this.pills)].slice(0,16); }

  toJSON(){ return {
    seed:this.seed, round:this.round, phase:this.phase,
    time:this.time, sect:this.sect, worldline:this.worldline,
    stats:this.stats, linggen:this.linggen,
    family:this.family, sectGov:this.sectGov, world:this.world,
    npcs:this.npcs, timeline:this.timeline,
    logs:this.logs, pills:this.pills
  }; }

  fromJSON(obj){ Object.assign(this, obj); this.rng=makeRng(this.seed); }

  formatDate() {
    const season = WORLD.seasons[((this.time.m-1)%4+4)%4] || "æ˜¥";
    return `${this.time.y}å¹´${season}Â·${this.time.m}æœˆ${this.time.d}æ—¥`;
  }

  advanceDay() {
    this.time.d += 1;
    if(this.time.d > 30) { this.time.d = 1; this.time.m += 1; }
    if(this.time.m > 4) { this.time.m = 1; this.time.y += 1; }
  }

  dueTimelineEvents() {
    return this.timeline.filter(ev=>ev.y===this.time.y && ev.m===this.time.m && ev.d===this.time.d);
  }
}

/** ---------- View ---------- */
class GameView{
  constructor(){
    this.$story=document.querySelector("#story");
    this.$stats=document.querySelector("#stats");
    this.$options=document.querySelector("#options");
    this.$loglist=document.querySelector("#loglist");
    this.$pillrow=document.querySelector("#pillrow");
    this.$chipRound=document.querySelector("#chipRound");
    this.$chipSeed=document.querySelector("#chipSeed");
    this.$chipDate=document.querySelector("#chipDate");
    this.$tagPhase=document.querySelector("#tagPhase");
    this.$tagPlace=document.querySelector("#tagPlace");
    this.$tagSect=document.querySelector("#tagSect");
    this.$tagLinggen=document.querySelector("#tagLinggen");
    this.$tagHint=document.querySelector("#tagHint");
    this.$tagNPC=document.querySelector("#tagNPC");
  }

  setTopTags(m){
    this.$chipRound.textContent = `å›åˆï¼š${m.round}`;
    this.$chipSeed.textContent = `ä¸–ç•Œçº¿ï¼š${m.seed.slice(0,12)}â€¦`;
    this.$chipDate.textContent = `æ—¶é—´ï¼š${m.formatDate()}`;

    const p=WORLD.phases[m.phase] || WORLD.phases.OPEN;
    this.$tagPhase.textContent = p.name;
    this.$tagPlace.textContent = p.place;

    this.$tagSect.textContent = m.sect?.name || "æ•£ä¿®";
    if(m.linggen.element){
      const vv=m.linggen.variant?`Â·å˜å¼‚(${m.linggen.variant})`:"";
      const aw=m.linggen.awakened?"Â·å·²è§‰é†’":"";
      this.$tagLinggen.textContent = `çµæ ¹ï¼š${m.linggen.grade}Â·${m.linggen.element}${vv}Â·çº¯åº¦${m.linggen.purity}%${aw}`;
    } else this.$tagLinggen.textContent="çµæ ¹ï¼šæœªæµ‹";
  }

  renderStats(m){
    const s=m.stats;
    const cards=[
      {k:"å¢ƒç•Œ",v:s.realm,bar:null},
      {k:"æ—¶é—´",v:m.formatDate(),bar:null},
      {k:"æ°”è¿",v:s.luck,bar:clamp01(s.luck/100)},
      {k:"æ‚Ÿæ€§",v:s.insight,bar:clamp01(s.insight/100)},
      {k:"å¿ƒæ€§",v:s.will,bar:clamp01((Number(s.will)+100)/200)},
      {k:"å¥åº·",v:s.health,bar:clamp01(s.health/100)},
      {k:"ç¥è¯†",v:s.sense,bar:clamp01(s.sense/100)},
      {k:"å£°æœ›",v:s.rep,bar:clamp01(s.rep/100)},
      {k:"å®¶æ—å£°åŠ¿",v:`${m.family.prestige} / ${m.family.wealth} / ${m.family.power}`,bar:clamp01(m.family.prestige/100)},
      {k:"å®—é—¨ç¨³å®š",v:`${m.sectGov.stability}ï¼ˆåº“ï¼š${m.sectGov.treasury}ï¼‰`,bar:clamp01(m.sectGov.stability/100)},
      {k:"æœå»·ç¨³å®š",v:m.world.imperialStability,bar:clamp01(m.world.imperialStability/100)},
      {k:"é­”æ½®å‹åŠ›",v:m.world.demonPressure,bar:clamp01(m.world.demonPressure/100)},
      {k:"çµçŸ³",v:s.stash,bar:clamp01(Math.min(200,Number(s.stash))/200)},
      {k:"è´¡çŒ®ç‚¹",v:s.cp,bar:clamp01(Math.min(100,Number(s.cp))/100)},
      {k:"ä»™ç›Ÿå¥½æ„Ÿ",v:s.favor,bar:clamp01(s.favor/100)},
      {k:"å› æœ",v:s.karma,bar:clamp01((Number(s.karma)+100)/200)},
      {k:"æœ¬å‘½ç‰©",v:s.artifact,bar:null}
    ];
    this.$stats.innerHTML = cards.map(c=>{
      const bar=(c.bar==null)?"":`<div class="bar"><i style="width:${Math.round(c.bar*100)}%"></i></div>`;
      return `<div class="stat"><div class="k">${escapeHTML(c.k)}</div><div class="v">${escapeHTML(String(c.v))}</div>${bar}</div>`;
    }).join("");
  }

  renderLog(m){
    this.$loglist.innerHTML = m.logs.map(it=>`
      <div class="logitem">
        <div class="time">${escapeHTML(it.t)} Â· <b>${escapeHTML(it.title)}</b></div>
        <div class="msg">${escapeHTML(it.msg)}</div>
      </div>`).join("");
    this.$pillrow.innerHTML = m.pills.map(p=>`<span class="pill">${escapeHTML(p)}</span>`).join("");
  }

  renderOptions(options, hint){
    this.$tagHint.textContent = hint || "è¯·é€‰æ‹©";
    this.$options.innerHTML = options.map((o,idx)=>`
      <div class="opt ${o.key ? "key":""}" data-idx="${idx}">
        <div class="badge">${idx+1}</div>
        <div class="txt">
          <div class="t">${escapeHTML(o.title)}</div>
          <div class="d">${escapeHTML(o.desc || "")}</div>
        </div>
      </div>`).join("");
  }

  setNpcTag(text){ this.$tagNPC.textContent=text || "NPCï¼šæœªç™»åœº"; }

  async typeStory(text){
    this.$story.textContent="";
    const caret=document.createElement("span");
    caret.className="typing-caret";
    for(let i=0;i<text.length;i++){
      this.$story.textContent += text[i];
      if(i%3===0){ this.$story.appendChild(caret); await sleep(10); caret.remove(); }
    }
    this.$story.appendChild(caret);
    await sleep(120);
    caret.remove();
  }

  floatChange(x,y,txt,kind="good"){
    const el=document.createElement("div");
    el.className=`float ${kind}`;
    el.style.left=`${x}px`; el.style.top=`${y}px`;
    el.textContent=txt;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),1100);
  }
}

/** ---------- AI Client ---------- */
function loadAiConfig(){
  return {
    mode: localStorage.getItem("x_ai_mode") || "off",
    endpoint: localStorage.getItem("x_ai_endpoint") || "",
    key: localStorage.getItem("x_ai_key") || "",
    template: localStorage.getItem("x_ai_template") || ""
  };
}
function saveAiConfig(cfg){
  localStorage.setItem("x_ai_mode", cfg.mode);
  localStorage.setItem("x_ai_endpoint", cfg.endpoint);
  localStorage.setItem("x_ai_key", cfg.key);
  localStorage.setItem("x_ai_template", cfg.template);
}
function renderCfgToUI(cfg){
  document.querySelector("#aiMode").value = cfg.mode;
  document.querySelector("#aiEndpoint").value = cfg.endpoint;
  document.querySelector("#aiKey").value = cfg.key;
  document.querySelector("#aiTemplate").value = cfg.template;
}
function uiCfg(){
  return {
    mode: document.querySelector("#aiMode").value,
    endpoint: document.querySelector("#aiEndpoint").value.trim(),
    key: document.querySelector("#aiKey").value.trim(),
    template: document.querySelector("#aiTemplate").value.trim()
  };
}
function applyTemplate(template, vars){
  let s = template;
  for(const [k,v] of Object.entries(vars)) s = s.replaceAll(`{{${k}}}`, v);
  return s;
}

async function callAI(cfg, prompt, stateObj){
  if(!cfg.endpoint) throw new Error("AI endpoint ä¸ºç©º");
  const vars = {
    prompt,
    seed: stateObj.seed,
    state: JSON.stringify(stateObj)
  };

  if(cfg.template){
    const bodyStr = applyTemplate(cfg.template, vars);
    const res = await fetch(cfg.endpoint, {
      method:"POST",
      headers: {
        "Content-Type":"application/json",
        ...(cfg.key ? {"Authorization":`Bearer ${cfg.key}`} : {})
      },
      body: bodyStr
    });
    const txt = await res.text();
    return txt;
  }

  if(cfg.mode==="gemini"){
    const url = cfg.endpoint.includes("key=") ? cfg.endpoint : (cfg.endpoint + (cfg.endpoint.includes("?")?"&":"?") + `key=${encodeURIComponent(cfg.key)}`);
    const body = {
      contents:[{parts:[{text:prompt}]}],
      generationConfig:{temperature:0.9, maxOutputTokens:900}
    };
    const res = await fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body) });
    const j = await res.json();
    const out = j?.candidates?.[0]?.content?.parts?.map(p=>p.text).join("") ?? JSON.stringify(j);
    return out;
  }

  // OpenAI compatible OR custom
  const body = {
    model: "gpt-4o-mini",
    temperature: 0.9,
    messages: [
      {role:"system", content:"ä½ å¿…é¡»åªè¾“å‡ºJSONï¼Œä¸è¦è¾“å‡ºå¤šä½™æ–‡å­—ã€‚"},
      {role:"user", content: prompt}
    ]
  };
  const res = await fetch(cfg.endpoint, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      ...(cfg.key ? {"Authorization":`Bearer ${cfg.key}`} : {})
    },
    body: JSON.stringify(body)
  });
  const j = await res.json();
  const out = j?.choices?.[0]?.message?.content ?? JSON.stringify(j);
  return out;
}

function extractJSON(text){
  try { return JSON.parse(text); } catch(_){}
  const first = text.indexOf("{");
  const last = text.lastIndexOf("}");
  if(first>=0 && last>first){
    const candidate = text.slice(first, last+1);
    try { return JSON.parse(candidate); } catch(_){}
  }
  const m = text.match(/```json\s*([\s\S]*?)\s*```/i);
  if(m){ try { return JSON.parse(m[1]); } catch(_){} }
  throw new Error("AIè¿”å›æ— æ³•è§£æä¸ºJSON");
}

/** ---------- Controller ---------- */
class GameController{
  constructor(m,v){
    this.m=m; this.v=v;
    this.currentOptions=[];
    this.lastAction="";

    document.querySelector("#btnSave").addEventListener("click", ()=>this.save());
    document.querySelector("#btnLoad").addEventListener("click", ()=>this.load());
    document.querySelector("#btnReset").addEventListener("click", ()=>{ this.m.reset(); this.lastAction=""; this.refresh(true); });

    document.querySelector("#btnFree").addEventListener("click", async ()=>{
      const txt=document.querySelector("#freeText").value.trim();
      if(!txt) return;
      document.querySelector("#freeText").value="";
      await this.runTurn(`è‡ªå®šä¹‰ï¼š${txt}`, null, null, txt);
    });

    // âœ… ä¿®å¤â€œé€‰é¡¹ä¸åŠ¨â€ï¼šåªç»‘å®šä¸€æ¬¡ï¼ŒcurrentOptionsç»Ÿä¸€æ¥æº
    document.querySelector("#options").addEventListener("click", async (e)=>{
      const opt=e.target.closest(".opt");
      if(!opt) return;
      const idx=Number(opt.dataset.idx);
      const rect=opt.getBoundingClientRect();
      await this.choose(idx, rect.left+rect.width*0.5, rect.top+8);
    });

    document.querySelector("#btnAiSave").addEventListener("click", ()=>{
      const cfg=uiCfg();
      saveAiConfig(cfg);
      this.m._pushLog("AIé…ç½®", "å·²ä¿å­˜AIé…ç½®åˆ°æœ¬æœºã€‚");
      this.refresh(false);
    });
    document.querySelector("#btnAiTest").addEventListener("click", async ()=>this.testAI());

    renderCfgToUI(loadAiConfig());
    this.refresh(true);
  }

  save(){
    localStorage.setItem("xianxia_world_save", JSON.stringify(this.m.toJSON()));
    this.m._pushLog("å­˜æ¡£","å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆlocalStorageï¼‰ã€‚");
    this.m.addPill("å·²å­˜æ¡£");
    this.refresh(false);
  }
  load(){
    const raw=localStorage.getItem("xianxia_world_save");
    if(!raw){ this.m._pushLog("è¯»å–å¤±è´¥","æœ¬åœ°æ²¡æœ‰å­˜æ¡£ã€‚"); return this.refresh(false); }
    try {
      this.m.fromJSON(JSON.parse(raw));
      this.m._pushLog("è¯»æ¡£","å·²ä»æœ¬åœ°è¯»å–å­˜æ¡£ã€‚");
      this.m.addPill("å·²è¯»æ¡£");
      this.refresh(true);
    } catch(e) {
      this.m._pushLog("è¯»å–å¤±è´¥","å­˜æ¡£æŸåæˆ–ç‰ˆæœ¬ä¸å…¼å®¹ã€‚");
      this.refresh(false);
    }
  }

  async testAI(){
    const cfg=uiCfg();
    const prompt='{"story":"æµ‹è¯•æˆåŠŸ","tags":{"phase":"SECT","place":"æµ‹è¯•","npcTag":"æµ‹è¯•NPC"},"options":[{"title":"ç»§ç»­","desc":"æµ‹è¯•","effects":{"stats":{"luck":1}}}]}';
    try {
      const txt=await callAI(cfg, prompt, this.m.toJSON());
      const obj=extractJSON(txt);
      this.m._pushLog("AIæµ‹è¯•","æˆåŠŸè§£æJSONï¼ŒAIå¯ç”¨ã€‚");
      this.m.addPill("AIå¯ç”¨");
      await this.renderTurnFromResult(obj, true);
    } catch(e) {
      this.m._pushLog("AIæµ‹è¯•å¤±è´¥", String(e.message || e));
      this.m.addPill("AIä¸å¯ç”¨");
      this.refresh(false);
    }
  }

  applyEffects(effects, x, y){
    if(!effects) return;
    const float = (txt, kind)=> this.v.floatChange(x||window.innerWidth*0.5, y||120, txt, kind);

    if(effects.stats){
      for(const [k,delta] of Object.entries(effects.stats)){
        if(typeof delta !== "number") continue;
        if(typeof this.m.stats[k] === "number"){
          this.m.stats[k] += delta;
          if(["luck","insight","health","sense","rep","favor"].includes(k)) this.m.stats[k] = Math.max(0, Math.min(100, this.m.stats[k]));
          if(["will","karma"].includes(k)) this.m.stats[k] = Math.max(-100, Math.min(100, this.m.stats[k]));
          float(`${k} ${delta>0?"+":""}${delta}`, delta>=0?"good":"bad");
        }
      }
    }

    if(effects.relations){
      for(const [id,deltaObj] of Object.entries(effects.relations)){
        const n=this.m.npcs[id];
        if(!n) continue;
        for(const [rk,rv] of Object.entries(deltaObj||{})){
          if(typeof rv !== "number") continue;
          if(rk in n){
            n[rk]+=rv;
            if(["favor","trust","ambition","corruption"].includes(rk)) n[rk]=Math.max(0,Math.min(100,n[rk]));
          }
        }
      }
    }

    if(effects.sect){
      if(typeof effects.sect.stability==="number") this.m.sectGov.stability = Math.max(0,Math.min(100,this.m.sectGov.stability + effects.sect.stability));
      if(typeof effects.sect.treasury==="number") this.m.sectGov.treasury = Math.max(0,Math.min(999,this.m.sectGov.treasury + effects.sect.treasury));
      if(effects.sect.elderInfluence){
        for(const [eid,dd] of Object.entries(effects.sect.elderInfluence)){
          if(typeof dd!=="number") continue;
          this.m.sectGov.elderInfluence[eid] = Math.max(0,Math.min(100,(this.m.sectGov.elderInfluence[eid]||0)+dd));
        }
      }
    }

    if(effects.family){
      if(typeof effects.family.prestige==="number") this.m.family.prestige = Math.max(0,Math.min(100,this.m.family.prestige + effects.family.prestige));
      if(typeof effects.family.wealth==="number") this.m.family.wealth = Math.max(0,Math.min(100,this.m.family.wealth + effects.family.wealth));
      if(typeof effects.family.power==="number") this.m.family.power = Math.max(0,Math.min(100,this.m.family.power + effects.family.power));
    }

    if(effects.world){
      if(typeof effects.world.imperialStability==="number") this.m.world.imperialStability = Math.max(0,Math.min(100,this.m.world.imperialStability + effects.world.imperialStability));
      if(typeof effects.world.demonPressure==="number") this.m.world.demonPressure = Math.max(0,Math.min(100,this.m.world.demonPressure + effects.world.demonPressure));
      if(typeof effects.world.publicFear==="number") this.m.world.publicFear = Math.max(0,Math.min(100,this.m.world.publicFear + effects.world.publicFear));
    }
  }

  checkBetrayals(){
    const rng=this.m.rng;
    for(const npc of Object.values(this.m.npcs)){
      if(npc.flags.includes("betrayed")) continue;
      const danger = (npc.trust<30) && (npc.ambition>70 || npc.corruption>80);
      if(!danger) continue;
      const p = 0.12 + (70-npc.trust)/200 + (npc.ambition)/500;
      if(rng() < Math.min(0.35, p)){
        npc.flags.push("betrayed");
        this.m._pushLog("èƒŒå›", `${npc.name}éœ²å‡ºå¦ä¸€å¼ è„¸ï¼šä»–/å¥¹åœ¨æš—å¤„æ¨åŠ¨ä¸€æ¡©é’ˆå¯¹ä½ çš„å±€ã€‚`);
        this.m.addPill(`èƒŒå›ï¼š${npc.name}`);
        this.m.world.publicFear = Math.min(100, this.m.world.publicFear + 4);
        this.m.stats.karma = Math.max(-100, Math.min(100, this.m.stats.karma + 3));
      }
    }
  }

  applyTimelineEvents(){
    const events = this.m.dueTimelineEvents();
    for(const ev of events){
      this.m._pushLog("å¹´è¡¨äº‹ä»¶", `ã€${this.m.formatDate()}ã€‘${ev.title}ï¼š${ev.desc}`);
      this.m.addPill(ev.title);
      if(ev.type==="politics") this.m.world.imperialStability = Math.max(0, this.m.world.imperialStability - 2);
      if(ev.type==="demon") this.m.world.demonPressure = Math.min(100, this.m.world.demonPressure + 3);
      if(ev.type==="sect") this.m.sectGov.stability = Math.max(0, this.m.sectGov.stability - 1);
      if(ev.type==="war") { this.m.world.demonPressure = Math.min(100,this.m.world.demonPressure+6); this.m.world.imperialStability=Math.max(0,this.m.world.imperialStability-4); }
    }
  }

  maybeLocalTurn(lastAction){
    const rng=this.m.rng;
    const romanceNpc = pick(rng, [this.m.npcs["n_peer1"], this.m.npcs["n_peer2"]]);
    const villain = pick(rng, [this.m.npcs["v_neigui"], this.m.npcs["v_shijia"], this.m.npcs["v_mozun"]]);

    const beats=[];
    beats.push(pick(rng, WORLD.localPrompts.openers));
    if(rng()<0.55) beats.push(pick(rng, WORLD.localPrompts.politics));
    if(rng()<0.55) beats.push(pick(rng, WORLD.localPrompts.romance));
    beats.push("");
    beats.push(`ä½ æƒ³åˆ°ä¸Šä¸€æ­¥ï¼š${lastAction || "æ— "}`);
    beats.push(`ä½ éšçº¦æ„Ÿè§‰ï¼š${this.m.worldline.mainThreat}ã€‚`);
    beats.push("");
    beats.push(`ã€äººç‰©ã€‘${romanceNpc.name}æœ›å‘ä½ ï¼Œåƒåœ¨ç­‰ä½ ç»™ä¸€ä¸ªä¿¡å·ï¼›è€Œ${villain.name}çš„å½±å­ï¼Œå´åƒä»ç¯ç«èƒŒé¢æŠ•æ¥ã€‚`);

    const story = beats.join("\n");

    const options = [
      {
        title:"å…¬å¼€ç¤ºå¥½ï¼šæŠŠå…³ç³»æ‘†åˆ°å°é¢",
        desc:`å¯¹${romanceNpc.name}æ›´è¿›ä¸€æ­¥ï¼Œä½†ä¼šè¢«äººç›¯ä¸Šã€‚`,
        effects: {
          relations: { [romanceNpc.id]: {favor:+8, trust:+5}, [villain.id]: {ambition:+2} },
          stats: {rep:+2, karma:+1},
          sect: {stability:-1}
        }
      },
      {
        title:"æš—ä¸­ç»“ç›Ÿï¼šä¸äººè°ˆç­¹ç ",
        desc:"æ‹‰æ‹¢æœå»·/ä»™ç›Ÿ/ä¸–å®¶çš„ä¸€æ–¹ï¼Œæ¢èµ„æºä¸ä¿æŠ¤ã€‚",
        effects: {
          stats: {stash:+6, favor:+3, karma:+2},
          world: {imperialStability:-1},
          family: {prestige:+3, wealth:+2}
        }
      },
      {
        title:"å…ˆä¸‹æ‰‹ä¸ºå¼ºï¼šæŸ¥å†…é¬¼/æ€æ¡Œ",
        desc:"é«˜é£é™©ã€‚å¯èƒ½ç›´æ¥æ’ä¸Šåæ´¾çº¿ã€‚",
        effects: {
          stats: {will:+2, rep:+1, health:-3},
          relations: { [villain.id]: {trust:-8, corruption:+3} },
          world: {publicFear:+4}
        }
      },
      {
        title:"ç¨³ä½å®—é—¨ï¼šå¤„ç†å®—åŠ¡ä¸äººå¿ƒ",
        desc:"æå‡å®—é—¨ç¨³å®šï¼Œé¡ºä¾¿åˆ·é•¿è€å½±å“ã€‚",
        effects: {
          sect: {stability:+4, treasury:+2, elderInfluence:{n_elder1:+2}},
          stats: {cp:+4}
        }
      }
    ];

    return {
      story,
      tags: { phase: (this.m.phase==="START" ? "SECT" : this.m.phase), place: WORLD.phases[this.m.phase]?.place || "ä¿®çœŸç•Œ", npcTag: `NPCï¼š${romanceNpc.name} / ${villain.name}` },
      options
    };
  }

  async runTurn(actionTitle, effects, x, y, rawActionText){
    if(effects) this.applyEffects(effects, x, y);

    this.m.advanceDay();
    this.m.round += 1;

    this.applyTimelineEvents();
    this.checkBetrayals();

    if(this.m.world.demonPressure > 60 && this.m.rng() < 0.25){
      this.m._pushLog("è¾¹å¢ƒæ¥ä¿¡","åŒ—å¢ƒä¼ æ¥æ€¥æŠ¥ï¼šé­”æ½®å‹åŠ›ä¸Šå‡ï¼Œå®—é—¨è¢«è¦æ±‚æ”¯æ´ã€‚");
      this.m.world.imperialStability = Math.max(0, this.m.world.imperialStability - 1);
      this.m.stats.karma = Math.max(-100, Math.min(100, this.m.stats.karma + 1));
    }

    this.lastAction = rawActionText || actionTitle || "è¡ŒåŠ¨";

    const cfg = uiCfg();
    let result=null;

    if(cfg.mode !== "off"){
      try {
        const prompt = buildOptimizedPrompt(this.m.toJSON(), this.lastAction);
        const txt = await callAI(cfg, prompt, this.m.toJSON());
        const obj = extractJSON(txt);
        result = obj;

        if(Array.isArray(obj.timeline_add)){
          for(const ev of obj.timeline_add){
            if(!ev || typeof ev.y!=="number") continue;
            this.m.timeline.push({
              y: ev.y, m: ev.m||1, d: ev.d||1,
              title: String(ev.title||"æ–°äº‹ä»¶"),
              desc: String(ev.desc||""),
              type: "dynamic"
            });
          }
          this.m.addPill("æ–°å¢å¹´è¡¨");
        }
      } catch(e) {
        this.m._pushLog("AIå›åˆå¤±è´¥", `å·²å›é€€æœ¬åœ°å¼•æ“ï¼š${String(e.message||e)}`);
        result = this.maybeLocalTurn(this.lastAction);
      }
    } else {
      result = this.maybeLocalTurn(this.lastAction);
    }

    this.m._pushLog("å›åˆæ¨è¿›", `ä½ é€‰æ‹©ï¼š${this.lastAction}`);
    await this.renderTurnFromResult(result, true);
  }

  async renderTurnFromResult(result, retype){
    if(result?.tags?.phase && WORLD.phases[result.tags.phase]) this.m.phase = result.tags.phase;
    else if(this.m.phase==="START") this.m.phase="SECT";

    const story = String(result.story || "ï¼ˆæœ¬å›åˆæ— å†…å®¹ï¼‰");
    const options = Array.isArray(result.options) ? result.options.slice(0,5) : [];
    this.currentOptions = options;

    this.v.setTopTags(this.m);
    this.v.renderStats(this.m);
    this.v.renderLog(this.m);
    this.v.renderOptions(options.map(o=>({title:o.title||"ï¼ˆæ— æ ‡é¢˜ï¼‰",desc:o.desc||"",key:false})), "è¯·é€‰æ‹©è¡ŒåŠ¨");
    this.v.setNpcTag(result?.tags?.npcTag || "NPCï¼šæœªç™»åœº");

    if(retype) await this.v.typeStory(story);
    else this.v.$story.textContent = story;
  }

  async choose(idx, x, y){
    const opt = this.currentOptions[idx];
    if(!opt) return;
    const eff = opt.effects || null;
    const actionText = opt.title || `é€‰é¡¹${idx+1}`;
    await this.runTurn(actionText, eff, x, y, actionText);
  }

  async refresh(retype){
    if(!this.m.linggen.element){
      remembered_init(this.m);
    }

    const starter = {
      story: [
        pick(this.m.rng, WORLD.localPrompts.openers),
        "",
        "ä½ è¸å…¥å®—é—¨æ£‹å±€ï¼Œæ‰€æœ‰äººçš„ç¬‘éƒ½å¸¦ç€ç®—è®¡ã€‚",
        `ã€ä¸–ç•Œçº¿ã€‘${this.m.worldline.mainThreat}`,
        "",
        "è¿™ä¸€å›åˆå¼€å§‹ï¼šä¸–ç•Œæ—¶é—´ä¼šè‡ªåŠ¨æ¨è¿›ï¼Œæ‹çˆ±ä¸èƒŒå›ä¼šåŒæ—¶å‘èŠ½ã€‚"
      ].join("\n"),
      tags: {
        phase: "SECT",
        place: WORLD.phases.SECT.place,
        npcTag: "NPCï¼šæŒé—¨Â·é¡¾ç„éœ„ / æ‰§æ³•é•¿è€Â·æ²ˆæ— å’"
      },
      options: [
        { title:"å…ˆç¨³å®—é—¨ï¼šå¤„ç†å®—åŠ¡ä¸è€ƒæ ¸", desc:"æå‡å®—é—¨ç¨³å®šï¼Œè·å¾—èµ„æºä¸ä¿¡ä»»ã€‚", effects: { sect: {stability:+4, treasury:+2}, stats: {cp:+4, rep:+1} } },
        { title:"å»è§åŒé—¨å¤©éª„ï¼šè¯•æ¢æš§æ˜§ä¸åŒç›Ÿ", desc:"æ¨è¿›æ‹çˆ±çº¿/ç›Ÿå‹çº¿ï¼Œä½†ä¼šè¢«äººå…³æ³¨ã€‚", effects: { relations: { n_peer1: {favor:+6, trust:+3}, n_peer2: {favor:+4} }, stats: {karma:+1} } },
        { title:"æš—æŸ¥ï¼šä»™ç›Ÿæ¥ä¿¡ä¸å†…é¬¼ä¼ é—»", desc:"æ¨è¿›æ”¿æ²»æ–—äº‰ä¸åæ´¾çº¿ã€‚", effects: { relations: { v_neigui: {trust:-3, ambition:+2} }, stats: {insight:+2, karma:+2}, world: {publicFear:+2} } },
        { title:"å…»ç²¾è“„é”ï¼šé—­å…³ä¸€æ—¥", desc:"ç¨³ä½èº«ä½“ä¸å¿ƒæ€§ï¼Œé™ä½è¢«ç®—è®¡çš„æ¦‚ç‡ã€‚", effects: { stats: {health:+3, will:+2, sense:+2} } }
      ]
    };

    await this.renderTurnFromResult(starter, retype);
  }
}

function remembered_init(m){
  const rng=m.rng;
  const grades=WORLD.linggen.grades;
  const weights=WORLD.linggen.gradeWeights;
  let total=weights.reduce((a,b)=>a+b,0);
  let r=rng()*total;
  let grade=grades[0];
  for(let i=0;i<grades.length;i++){ r-=weights[i]; if(r<=0){ grade=grades[i]; break; } }
  m.linggen.element = pick(rng, WORLD.linggen.elements);
  m.linggen.variant = (rng()<0.18) ? pick(rng, WORLD.linggen.variants) : null;
  m.linggen.grade = grade;
  m.linggen.purity = randInt(rng, 55, 92);

  m.sect = { id:"tianjian", name:"å¤©å‰‘å®—", style:"å‰‘ä¿®æ¸…å†·ã€ä¸€è‡´æ€§å¼º" };
  m._pushLog("æµ‹çµæ ¹", `ä½ æµ‹å¾—ï¼š${m.linggen.grade}Â·${m.linggen.element}${m.linggen.variant?("Â·å˜å¼‚("+m.linggen.variant+")"):""}Â·çº¯åº¦${m.linggen.purity}%ã€‚`);
  m.addPill("çµæ ¹å·²å®š");
}

// boot
const model = new GameModel();
const view  = new GameView();
const ctrl  = new GameController(model, view);
</script>

</body>
</html>
