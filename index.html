<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ€¨ç§å¥³é…æ€æ¡Œå½• Â· ç»ˆæå®Œæ•´ç‰ˆ Day1â€“Day20</title>
<style>
:root{
  --bg:#0f1220;
  --card:#1b1f3a;
  --card2:#14182e;
  --text:#eaeaff;
  --muted:#b7b9ff;
  --border:#3b3f7a;
  --accent:#ff6aa2;
  --good:#7cffb2;
  --warn:#ffd36b;
  --bad:#ff5b5b;
  --glow:#ff6aa288;
  --shadow:0 0 12px #0007;
  --r:14px;
}
*{box-sizing:border-box}
body{
  margin:0;
  color:var(--text);
  font-family:"PingFang SC","Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background: radial-gradient(1200px 800px at 20% 0%, #1a1f44 0%, var(--bg) 55%, #0b0d18 100%);
}
.container{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  padding:12px;
}
.card{
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:14px;
  box-shadow:var(--shadow);
  position:relative;
  overflow:hidden;
}
h3{margin:0 0 10px; color:var(--accent); font-size:16px; letter-spacing:.4px;}
.small{font-size:12px;color:var(--muted);line-height:1.55}
.hr{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:10px 0;}
@media(max-width:820px){.container{grid-template-columns:1fr;}}

/* story */
#story{height:300px;overflow:auto;line-height:1.78;font-size:14px;padding-right:6px;white-space:pre-wrap;}
#story::-webkit-scrollbar{width:8px}
#story::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

/* options */
.option{
  background:#242a62;
  border:1px solid #2f3578;
  padding:10px;
  margin:8px 0;
  border-radius:12px;
  cursor:pointer;
  transition:.15s;
  user-select:none;
}
.option:hover{transform:translateY(-1px); border-color:var(--accent); box-shadow:0 0 10px var(--glow);}
.option.selected{border-color:var(--accent); box-shadow:0 0 16px var(--glow);}
.tag{
  display:inline-block;
  font-size:12px;
  padding:2px 8px;
  border-radius:999px;
  margin-right:8px;
  border:1px solid #ffffff22;
  opacity:.95;
}
.tag-main{color:var(--accent);background:#ff6aa214;border-color:#ff6aa244;}
.tag-safe{color:var(--good);background:#7cffb214;border-color:#7cffb255;}
.tag-risk{color:var(--bad);background:#ff5b5b14;border-color:#ff5b5b66;}
.tag-warn{color:var(--warn);background:#ffd36b14;border-color:#ffd36b66;}

/* stats */
.stat{display:flex;align-items:center;gap:10px;margin:6px 0;font-size:13px;}
.stat b{width:98px;color:#fff;font-weight:600}
.bar{flex:1;height:8px;background:#00000033;border:1px solid #ffffff12;border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,#7cffb2,#ffd36b,#ff6aa2);width:50%}
.val{width:46px;text-align:right}

/* system */
.sysRow{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0;font-size:13px;}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ffffff22;}
.badge-ok{color:var(--good);border-color:#7cffb266;background:#7cffb214;}
.badge-warn{color:var(--warn);border-color:#ffd36b66;background:#ffd36b12;}
.badge-bad{color:var(--bad);border-color:#ff5b5b66;background:#ff5b5b14;}

.btn{
  cursor:pointer;
  border-radius:12px;
  padding:9px 12px;
  border:1px solid #ffffff22;
  background:#20245a;
  color:var(--text);
  transition:.15s;
  font-size:13px;
}
.btn:hover{transform:translateY(-1px);border-color:var(--accent);box-shadow:0 0 10px var(--glow);}
.btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

.float{
  position:fixed; right:14px; top:14px; z-index:9999;
  padding:8px 10px; border-radius:12px;
  border:1px solid #ffffff22; background:#12152aee; box-shadow:var(--shadow);
  animation: floatUp 1.4s ease-out forwards; font-size:13px;
}
.float.good{color:var(--good);border-color:#7cffb255}
.float.bad{color:var(--bad);border-color:#ff5b5b66}
.float.warn{color:var(--warn);border-color:#ffd36b66}
@keyframes floatUp{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-40px)}}

.flash{position:fixed;inset:0;background:radial-gradient(900px 400px at 50% 20%, #ff5b5b33, transparent 70%);opacity:0;pointer-events:none;z-index:9998;}
.flash.on{animation:flash .55s ease-in-out;}
@keyframes flash{0%{opacity:0}35%{opacity:1}100%{opacity:0}}
.shake{animation:shake .42s linear}
@keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}100%{transform:translateX(0)}}

/* modal */
.mask{position:fixed;inset:0;background:#00000088;display:none;align-items:center;justify-content:center;z-index:10000;}
.mask.show{display:flex}
.modal{
  width:min(880px, 92vw);
  max-height:84vh;
  overflow:auto;
  background:linear-gradient(180deg,#1b1f3a 0%, #14182e 100%);
  border:1px solid var(--border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:14px;
}
.modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px;}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px;}
@media(max-width:680px){.grid2{grid-template-columns:1fr}}
.item{border:1px solid #ffffff1a;background:#10132a66;border-radius:12px;padding:10px;}
.item h4{margin:0 0 6px;color:#fff;font-size:14px;}
.meta{display:flex;gap:8px;align-items:center;margin:6px 0;font-size:12px;color:var(--muted);flex-wrap:wrap}
.price{color:var(--accent);border:1px solid #ff6aa244;background:#ff6aa214;border-radius:999px;padding:2px 8px;}
.desc{font-size:12px;line-height:1.55;color:#d7d9ff;}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
.inp{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #ffffff22;
  background:#0e1030;
  color:var(--text);
  outline:none;
}
.kbd{font-size:12px;color:#cfd1ff;border:1px solid #ffffff22;background:#00000022;border-radius:8px;padding:2px 8px;}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #ffffff22;border-radius:999px;background:#00000022}

/* portraits */
.portraitRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.portrait{
  width:56px;height:56px;border-radius:16px;
  border:1px solid #ffffff22;
  background:linear-gradient(180deg,#2a2f66,#15183a);
  display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#fff;
  box-shadow:0 0 10px #0006;
}
.portraitName{font-weight:800}
.portraitSub{font-size:12px;color:var(--muted)}
.portraitBtn{padding:6px 10px;border-radius:999px}
</style>
</head>

<body>
<div class="flash" id="flash"></div>

<div class="container">

  <div class="card" id="cardStory">
    <h3>ğŸ“œ å½“å‰å‰§æƒ…</h3>
    <div class="portraitRow">
      <div class="portrait" id="portraitBox">æŸ³</div>
      <div>
        <div class="portraitName" id="portraitName">æŸ³æ‰¶é£</div>
        <div class="portraitSub" id="subtitle"></div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn portraitBtn" id="btnPortrait">åˆ‡æ¢ç«‹ç»˜</button>
        <span class="pill"><span class="kbd">Day</span> <b id="dayBadge">1</b></span>
      </div>
    </div>
    <div class="hr"></div>
    <div id="story"></div>
  </div>

  <div class="card" id="cardAction">
    <h3>ğŸ¯ è¡ŒåŠ¨é¢æ¿</h3>
    <div class="small">æ¯å›åˆï¼šå…ˆç‚¹ 1 ä¸ªè¡ŒåŠ¨ï¼ˆä¼šé«˜äº®ï¼‰ï¼Œå†ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ã€‚<br>é«˜äº®/æ€æ¡Œ=é«˜é£é™©é«˜æ”¶ç›Šã€‚</div>
    <div class="hr"></div>
    <div id="options"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnCustom">âœï¸ è‡ªå®šä¹‰è¡ŒåŠ¨</button>
      <button class="btn" id="btnAI">ğŸ¤– AIç»­å†™</button>
      <button class="btn" id="btnEnd">â© ç»“æŸæœ¬å›åˆ</button>
      <button class="btn" id="btnSkip">â© ç›´æ¥åˆ°Day20ç»“å±€</button>
    </div>
  </div>

  <div class="card" id="cardStats">
    <h3>ğŸ“Š è§’è‰²çŠ¶æ€</h3>
    <div class="small">è­¦å‘Šå€¼â‰¥70ä¼šè§¦å‘æ›´å¼ºæƒ©ç½šï¼›å¥åº·â‰¤15å¯èƒ½â€œç—…å€’â€ã€‚Day20è‡ªåŠ¨ç»“å±€åˆ¤å®šã€‚</div>
    <div class="hr"></div>
    <div id="stats"></div>
  </div>

  <div class="card" id="cardSystem">
    <h3>âš™ ç³»ç»Ÿç›‘æ§</h3>
    <div id="system"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnShop">ğŸ›’ ç³»ç»Ÿå•†åŸ</button>
      <button class="btn" id="btnAch">ğŸ† æˆå°±</button>
      <button class="btn" id="btnSave">ğŸ’¾ å­˜æ¡£</button>
      <button class="btn" id="btnLoad">ğŸ“¥ è¯»æ¡£</button>
      <button class="btn" id="btnReset">ğŸ§¨ æ¸…æ¡£é‡å¼€</button>
      <button class="btn" id="btnAPI">ğŸ”‘ è®¾ç½®AIå¯†é’¥</button>
    </div>
  </div>

</div>

<!-- Shop Modal -->
<div class="mask" id="shopMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ›’ ç³»ç»Ÿå•†åŸ</div>
        <div class="small">è´§å¸=æ€æ¡Œå€¼ã€‚ä¹°æŠ€èƒ½ä¼šè®©ä½ æ›´å®¹æ˜“éª—è¿‡ç³»ç»Ÿã€‚</div>
      </div>
      <button class="btn" id="btnCloseShop">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div class="small" id="shopMoney"></div>
    <div class="grid2" id="shopGrid"></div>
  </div>
</div>

<!-- Achievements Modal -->
<div class="mask" id="achMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ† æˆå°±ç³»ç»Ÿ</div>
        <div class="small">æ»¡è¶³æ¡ä»¶ä¼šè‡ªåŠ¨è§£é”ï¼ˆå­˜æ¡£ä¿å­˜ï¼‰ã€‚</div>
      </div>
      <button class="btn" id="btnCloseAch">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div id="achList" class="grid2"></div>
  </div>
</div>

<!-- API Modal -->
<div class="mask" id="apiMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ”‘ AIè®¾ç½®ï¼ˆOpenAIå…¼å®¹ï¼‰</div>
        <div class="small">æŠŠä½ çš„ Key å¡«è¿™é‡Œï¼Œå­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰ã€‚ä¸æäº¤åˆ°GitHubã€‚</div>
      </div>
      <button class="btn" id="btnCloseAPI">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div class="small">æ¥å£åœ°å€ï¼ˆbaseURLï¼‰</div>
    <input class="inp" id="apiBase" placeholder="ä¾‹å¦‚ï¼šhttps://api.gemai.cc/v1" />
    <div style="height:10px"></div>
    <div class="small">æ¨¡å‹åï¼ˆmodelï¼‰</div>
    <input class="inp" id="apiModel" placeholder="ä¾‹å¦‚ï¼šgpt-4o-mini / gpt-4.1-mini / ä½ çš„ç«™ç‚¹æ”¯æŒçš„æ¨¡å‹" />
    <div style="height:10px"></div>
    <div class="small">API Keyï¼ˆä¸è¦å¸¦å¼•å·ï¼‰</div>
    <input class="inp" id="apiKey" placeholder="sk-..." />
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnSaveAPI">ä¿å­˜</button>
      <button class="btn" id="btnTestAPI">æµ‹è¯•è¯·æ±‚</button>
      <button class="btn" id="btnClearAPI">æ¸…ç©º</button>
    </div>
    <div class="hr"></div>
    <div class="small" id="apiHint">æç¤ºï¼šå¦‚æœâ€œAIè¯·æ±‚å¼‚å¸¸â€ï¼Œ99% æ˜¯ baseURL æˆ– model ä¸å¯¹ï¼Œæˆ–ç«™ç‚¹ä¸æ”¯æŒæµè§ˆå™¨è·¨åŸŸï¼ˆCORSï¼‰ã€‚</div>
  </div>
</div>

<script>
/* =========================
   ç»ˆæç‰ˆæ ¸å¿ƒä¿®å¤ç‚¹ï¼š
   âœ… å½»åº•ç¦æ­¢ç”¨ i å½“â€œé€‰é¡¹/å¤©æ•°/å¾ªç¯ç´¢å¼•â€
   âœ… ç”¨ selectedIndex å•ç‹¬ä¿å­˜â€œä½ ç‚¹äº†å“ªä¸ªè¡ŒåŠ¨â€
   âœ… endTurn() æ‰æ¨è¿› day
   ========================= */

/* ======= å¯æ”¹ï¼šä½ çš„AIæ¥å£é»˜è®¤å€¼ ======= */
const AI_DEFAULT = {
  baseURL: localStorage.getItem("boli_ai_base") || "https://api.gemai.cc/v1",
  model:  localStorage.getItem("boli_ai_model") || "gpt-4o-mini",
  key:    localStorage.getItem("boli_ai_key") || ""
};

/* ========= å•†åŸ ========= */
const Shop = [
  {id:"shield", name:"å±è”½ç¬¦", price:10, desc:"ä¸‹ä¸€æ¬¡å…ç³»ç»Ÿæƒ©ç½šï¼ˆä¸€æ¬¡æ€§ï¼‰ã€‚", apply:s=>s.buffs.noPunishOnce=true},
  {id:"actor", name:"æ¼”æŠ€å¤§å¸ˆ", price:40, desc:"è¢«åŠ¨ï¼šæƒ©ç½šè§¦å‘æ¦‚ç‡-35%ï¼ˆæ›´å®¹æ˜“éª—è¿‡ç³»ç»Ÿï¼‰ã€‚", apply:s=>s.buffs.actor=true},
  {id:"iron", name:"é“è¡€å¿ƒé˜²", price:30, desc:"è¢«åŠ¨ï¼šç³»ç»Ÿæƒ©ç½šå¯¹å¿ƒæ™º/å¥åº·çš„ä¼¤å®³-1ã€‚", apply:s=>s.buffs.iron=true},
  {id:"intel", name:"æƒ…æŠ¥çº¿äºº", price:25, desc:"ä¸€æ¬¡æ€§ï¼šä¸‹ä¸€å›åˆè°‹ç•¥+3ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰ã€‚", apply:s=>{s.buffs.nextIntelBoost=true}},
  {id:"lux", name:"ç²ç‘äººè„‰", price:35, desc:"è¢«åŠ¨ï¼šç¤¾äº¤/ä½“é¢è·¯çº¿é¢å¤–+2å£°æœ›ã€‚", apply:s=>s.buffs.lux=true},
];

/* ========= æˆå°± ========= */
const Achievements = [
  {id:"a1", name:"ç¬¬ä¸€æ¡Œ", desc:"æ€æ¡Œå€¼ â‰¥ 6", check:s=>s.player["æ€æ¡Œå€¼"]>=6},
  {id:"a2", name:"ä¸å½“æ€¨ç§", desc:"åç¦»åº¦ â‰¥ 20", check:s=>s.player["åç¦»åº¦"]>=20},
  {id:"a3", name:"è¯æ®é“¾", desc:"è¯æ®å€¼ â‰¥ 12", check:s=>s.player["è¯æ®å€¼"]>=12},
  {id:"a4", name:"å¤ªå­åœ¨æ„", desc:"å¤ªå­å¥½æ„Ÿ â‰¥ 18", check:s=>s.player["å¤ªå­å¥½æ„Ÿ"]>=18},
  {id:"a5", name:"é»‘åŒ–è¾¹ç¼˜", desc:"é»‘åŒ–å€¼ â‰¥ 16", check:s=>s.player["é»‘åŒ–å€¼"]>=16},
  {id:"a6", name:"ä½“é¢äºº", desc:"è´µå¥³å£°æœ› â‰¥ 92", check:s=>s.player["è´µå¥³å£°æœ›"]>=92},
  {id:"a7", name:"ç¡¬æŠ—ç³»ç»Ÿ", desc:"ç³»ç»Ÿè­¦å‘Šå€¼ â‰¥ 70ï¼ˆä»æœªå´©ç›˜ï¼‰", check:s=>s.player["ç³»ç»Ÿè­¦å‘Šå€¼"]>=70 && s.player["å¥åº·"]>0},
  {id:"a8", name:"æ´»åˆ°ç»“å±€", desc:"æ¥åˆ° Day20", check:s=>s.day>=20},
];

/* ========= ç«‹ç»˜åˆ‡æ¢ ========= */
const Portraits = [
  {key:"mc", glyph:"æŸ³", name:"æŸ³æ‰¶é£", sub:"ä½  Â· å°†å†›åºœå«¡å¥³ï¼ˆç©¿ä¹¦å¥³é…ï¼‰"},
  {key:"prince", glyph:"ç©", name:"å¤ªå­ Â· æ…•å®¹ç©", sub:"å†·é¢æƒæŸ„ Â· ä¸œå®«ä¹‹ä¸»"},
  {key:"su", glyph:"è²", name:"è‹æ¸…è²", sub:"ç™½è²çš®ç›¸ Â· æš—çº¿æ“ç›˜"},
];

/* ========= å¼•æ“çŠ¶æ€ ========= */
function freshState(){
  return {
    version: "boli-ultimate-v1",
    day: 1,
    selectedIndex: null,     // âœ… å…³é”®ï¼šåªç”¨äºâ€œä½ é€‰äº†å“ªä¸ªè¡ŒåŠ¨â€
    resolvedToday: false,    // âœ… æ˜¯å¦å·²ç»“ç®—ï¼ˆé˜²é‡å¤ç»“ç®—ï¼‰
    portraitIndex: 0,
    player: {
      é£å: 92,
      è°‹ç•¥: 78,
      å¿ƒæ™º: 74,
      å¥åº·: 88,
      æ€æ¡Œå€¼: 0,
      åç¦»åº¦: 0,
      è´µå¥³å£°æœ›: 85,
      å®¶æ—å£°æœ›: 95,
      ç³»ç»Ÿè­¦å‘Šå€¼: 0,
      "å¤ªå­å¥½æ„Ÿ": 0,
      "è‹æ¸…è²æ€€ç–‘": 0,
      "è¯æ®å€¼": 0,
      "é»‘åŒ–å€¼": 0,
      "ç”œåº¦å€¼": 0,
    },
    buffs: {
      noPunishOnce:false,
      actor:false,
      iron:false,
      nextIntelBoost:false,
      lux:false,
    },
    flags: {
      evidenceGot: false,
      princeTrust: false,
      suExposed: false,
      romanceLocked: false,
      powerLocked: false,
    },
    unlocked: {},   // achievements
    log: [],        // äº‹ä»¶æ—¥å¿—
    lastStory: ""   // ä¸Šæ¬¡å‰§æƒ…ï¼ˆç”¨äºAIç»­å†™ä¸Šä¸‹æ–‡ï¼‰
  };
}
let State = loadAuto() || freshState();

/* ========= DOM ========= */
const $ = id => document.getElementById(id);
const storyBox = $("story");
const subtitle = $("subtitle");
const dayBadge = $("dayBadge");
const optionBox = $("options");
const statBox = $("stats");
const systemBox = $("system");
const flash = $("flash");
const cards = [$("cardStory"),$("cardAction"),$("cardStats"),$("cardSystem")];

const shopMask = $("shopMask");
const shopGrid = $("shopGrid");
const shopMoney = $("shopMoney");

const achMask = $("achMask");
const achList = $("achList");

const apiMask = $("apiMask");
const apiBase = $("apiBase");
const apiModel = $("apiModel");
const apiKey = $("apiKey");
const apiHint = $("apiHint");

const portraitBox = $("portraitBox");
const portraitName = $("portraitName");

/* ========= util ========= */
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
function tip(text, kind="good"){
  const d=document.createElement("div");
  d.className=`float ${kind}`;
  d.innerText=text;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1400);
}
function setStory(text){
  storyBox.textContent = text;
  storyBox.scrollTop = 0;
  State.lastStory = text;
}
function applyDelta(delta){
  Object.entries(delta).forEach(([k,v])=>{
    if(!(k in State.player)) return;
    const before=State.player[k];
    State.player[k]=clamp(before+v,0,100);
    if(v!==0){
      const sign=v>0?"+":"";
      tip(`${k} ${sign}${v}`, v>0 ? "good" : "bad");
    }
  });
}
function shakePunish(){
  flash.classList.add("on");
  cards.forEach(c=>c.classList.add("shake"));
  setTimeout(()=>{
    flash.classList.remove("on");
    cards.forEach(c=>c.classList.remove("shake"));
  }, 520);
}

/* ========= ç”Ÿæˆ Day1-20 å‰§æƒ…ï¼ˆæ¯ä¸€å¤©å››é€‰é¡¹éƒ½ä¸åŒæ–‡å­—ï¼‰ ========= */
function dayTitle(d){
  const map = {
    1:"ç¬¬ä¸€æ—¥ Â· å°†å†›åºœ",
    2:"ç¬¬äºŒæ—¥ Â· åŸä¸­æš—æµ",
    3:"ç¬¬ä¸‰æ—¥ Â· ä¸œå®«å›å£°",
    4:"ç¬¬å››æ—¥ Â· èµèŠ±å®´åˆ€å…‰",
    5:"ç¬¬äº”æ—¥ Â· ä¸ç›¸åºœåé—¨",
    6:"ç¬¬å…­æ—¥ Â· å¤ªåŒ»ä¸æ¯’",
    7:"ç¬¬ä¸ƒæ—¥ Â· å¤œé›¨åŒä¼",
    8:"ç¬¬å…«æ—¥ Â· å®«å®´æŒ‘è¡…",
    9:"ç¬¬ä¹æ—¥ Â· çº¿äººå¤±è¸ª",
    10:"ç¬¬åæ—¥ Â· å…µæƒé£å£",
    11:"ç¬¬åä¸€æ—¥ Â· è‹è²ç¿»ç›˜",
    12:"ç¬¬åäºŒæ—¥ Â· ä¸œå®«å¯†è°ˆ",
    13:"ç¬¬åä¸‰æ—¥ Â· æ°‘å¿ƒä¸é“¶é’±",
    14:"ç¬¬åå››æ—¥ Â· ç‰¢ç‹±ç«æ˜Ÿ",
    15:"ç¬¬åäº”æ—¥ Â· æ–­æƒ…æˆ–æ›´æ·±æƒ…",
    16:"ç¬¬åå…­æ—¥ Â· çš‡åè¯•æ¢",
    17:"ç¬¬åä¸ƒæ—¥ Â· çœŸè¯æ®è½åœ°",
    18:"ç¬¬åå…«æ—¥ Â· é€¼å®«å‰å¤œ",
    19:"ç¬¬åä¹æ—¥ Â· ç»ˆå±€å¯¹å±€",
    20:"ç¬¬äºŒåæ—¥ Â· ç»“å±€åˆ¤å®š",
  };
  return map[d] || `ç¬¬${d}æ—¥`;
}
function dayMainTask(d){
  const map = {
    1:"ä¸»çº¿ï¼šä¸œå®«é€æ±¤èŠ‚ç‚¹ï¼ˆåˆæ¬¡æ”¹å†™ï¼‰",
    2:"ä¸»çº¿ï¼šç¨³å£°æœ›æˆ–æ¨è¿›è¯æ®",
    3:"ä¸»çº¿ï¼šä¸å¤ªå­æ­£é¢äº¤é”‹/ç§ä¸‹å¯¹è¯",
    4:"ä¸»çº¿ï¼šå®´ä¸Šä¿ä½“é¢/æ’•ç ´è„¸",
    5:"ä¸»çº¿ï¼šè¿½åˆ°ä¸ç›¸åºœæš—çº¿",
    6:"ä¸»çº¿ï¼šæŸ¥â€œå‚æ±¤â€èƒŒåçœŸæ¯’",
    7:"ä¸»çº¿ï¼šå¤ªå­æ€åº¦åˆ†åŒ–ï¼ˆç”œå® /æƒè°‹åˆ†å²”ï¼‰",
    8:"ä¸»çº¿ï¼šå®«å®´ç«‹å¨æˆ–ç¿»è½¦",
    9:"ä¸»çº¿ï¼šçº¿äººå±æœºï¼ˆæ•‘æˆ–å¼ƒï¼‰",
    10:"ä¸»çº¿ï¼šå…µæƒä¸å®¶æ—å‘½è„‰",
    11:"ä¸»çº¿ï¼šè‹æ¸…è²åå’¬ï¼ˆä½ è¦æ€ä¹ˆæ¥ï¼‰",
    12:"ä¸»çº¿ï¼šä¸œå®«å¯†è°ˆå®šåˆä½œ",
    13:"ä¸»çº¿ï¼šæ°‘å¿ƒè·¯çº¿/é“¶é’±è·¯çº¿",
    14:"ä¸»çº¿ï¼šç‰¢ç‹±çœŸç›¸ï¼ˆè¯æ®é“¾è¡¥é½ï¼‰",
    15:"ä¸»çº¿ï¼šæƒ…æ„Ÿç¡®è®¤ or é»‘åŒ–åŠ é€Ÿ",
    16:"ä¸»çº¿ï¼šçš‡åè¯•æ¢ä½ åº•ç‰Œ",
    17:"ä¸»çº¿ï¼šçœŸè¯æ®è½åœ°ï¼Œèƒ½å¦å®šç½ª",
    18:"ä¸»çº¿ï¼šé€¼å®«å‰å¤œç«™é˜Ÿ",
    19:"ä¸»çº¿ï¼šç»ˆå±€å¯¹å±€â€”â€”ä½ äº²è‡ªè½å­",
    20:"ä¸»çº¿ï¼šè‡ªåŠ¨ç»“å±€åˆ¤å®šï¼ˆå¤šç»“å±€ï¼‰",
  };
  return map[d] || "ä¸»çº¿æ¨è¿›";
}

/* æ¯å¤©å››æ¡è¡ŒåŠ¨æ–‡æœ¬ï¼šä¸»çº¿ / æ€æ¡Œ / è°‹ç•¥ / å…»æˆ */
function getActionsForDay(d){
  const P = State.player;
  const warn = P["ç³»ç»Ÿè­¦å‘Šå€¼"];
  const high = warn >= 70;

  // ç”œå® /é»‘åŒ–å€¾å‘å½±å“æ–‡æ¡ˆä¸€ç‚¹ç‚¹
  const sweet = P["ç”œåº¦å€¼"] >= 14;
  const dark  = P["é»‘åŒ–å€¼"] >= 14;

  const mainText = [
`ä½ æŒ‰ä½è„¾æ°”ï¼ŒæŠŠâ€œä½“é¢â€å½“ç›¾ã€‚å¤ªå­çœ‹ä½ çš„çœ¼ç¥ä»å†·ï¼Œå´å¼€å§‹è®°ä½ä½ ã€‚ä½ èµ¢äº†ç¬¬ä¸€æ­¥ï¼šä¸è®©ç³»ç»ŸæŠ“åˆ°æŠŠæŸ„ã€‚`,
`ä½ åœ¨åŸé‡Œåšäº†ä»¶ä½“é¢äº‹ï¼šæ•‘ä¸‹è¢«åˆéš¾çš„å•†å¥³ï¼Œé¡ºæ‰‹æé¦™ç«ã€‚å£ç¢‘ç¨³ä½ï¼Œç³»ç»Ÿä¹ŸçŸ­æš‚å®‰é™ã€‚`,
`ä¸œå®«å»Šä¸‹ï¼Œä½ ä¸å‘ä¸äº¢ã€‚å¤ªå­é—®ä½ â€œä¸ºä½•å˜äº†â€ã€‚ä½ è¯´ï¼šæˆ‘åªæ˜¯ç»ˆäºä¸æ¼”äº†ã€‚`,
`èµèŠ±å®´ä¸Šï¼Œä½ æ›¿ä¸€ä½è¢«ç¾è¾±çš„å§‘å¨˜æŒ¡å›å»ã€‚ä¼—äººç¬¬ä¸€æ¬¡æ„è¯†åˆ°ï¼šå°†å†›åºœè¿™ä½ï¼Œä¸å¥½æ‹¿æã€‚`,
`ä½ æŠŠâ€œåé—¨æ¥å¾€â€çš„äººåè®°å…¨äº†ã€‚è¯æ®ä¸å¤Ÿç¡¬ï¼Œä½†ä½ å·²ç»æ‘¸åˆ°è„‰ã€‚`,
`å¤ªåŒ»ä¸€å¥â€œå‚æ±¤æœ‰å¼‚â€ï¼Œä½ å¿ƒåº•ä¸€æ²‰ã€‚åŸè‘—é‚£åœºâ€œç¬‘è¯â€ï¼Œå¯èƒ½ä»æ¥ä¸æ˜¯ç¬‘è¯ï¼Œè€Œæ˜¯è¯•æ¯’ã€‚`,
`å¤œé›¨åŒä¼ï¼Œå¤ªå­æŠŠä¼åå‘ä½ ã€‚${sweet? "ä½ å¿ƒå£å‘çƒ­â€”â€”æ˜¯ç”œã€‚":"ä½ å¿ƒå£å‘å†·â€”â€”æ˜¯ç­¹ç ã€‚"}`,
`å®«å®´ä¸Šä½ ç¨³ä½å±€é¢ï¼Œæ—¢ä¸è·ªèˆ”ä¹Ÿä¸è½æ’ã€‚ä½ è®©â€œä½“é¢â€å˜æˆåˆ€æŸ„ã€‚`,
`çº¿äººå¤±è¸ªï¼Œä½ æ²¡æ…Œã€‚ä½ ç”¨æ›´å†·é™çš„æ–¹æ³•æŠŠäººæå‡ºæ¥ï¼šç•™ä¸‹æ´»å£ï¼Œæ¢å›çœŸçº¿ç´¢ã€‚`,
`å…µæƒé£å£ï¼Œä½ å…ˆç¨³ä½å°†å†›åºœã€‚ä½ è®©çˆ¶äº²çœ‹åˆ°ï¼šä½ ä¸æ˜¯æƒ…çˆ±å¥³é…ï¼Œä½ èƒ½æŠ¤å®¶ã€‚`,
`è‹æ¸…è²å½“ä¼—åå’¬ä½ â€œå¿ƒæœ¯ä¸æ­£â€ã€‚ä½ ç¬‘ç€æŠŠå¥¹çš„â€œè¯è¯æ¼æ´â€ä¸€ç‚¹ç‚¹æ‹†å¼€ã€‚`,
`ä¸œå®«å¯†è°ˆï¼Œä½ åªè°ˆåˆ©ç›Šï¼šè¯æ®ã€å…µæƒã€æœªæ¥ã€‚å¤ªå­ç¬¬ä¸€æ¬¡è¯´ï¼šä½ å¯ä»¥ä¿¡æˆ‘ä¸€æ¬¡ã€‚`,
`ä½ æŠŠé“¶é’±æŠ•å‘ç™¾å§“ï¼šç²®ä»·ã€è¯é“ºã€å†¬è¡£ã€‚æ°‘å¿ƒè¢«ä½ ä¸€ç‚¹ç‚¹æ”¥ä½ã€‚`,
`ç‰¢ç‹±é‡Œï¼Œä½ æ‰¾åˆ°å…³é”®å£ä¾›ã€‚ä½ æ²¡æ•‘æ‰€æœ‰äººï¼Œä½†ä½ æ•‘äº†èƒ½æŠŠè‹æ¸…è²é’‰æ­»çš„é‚£ä¸€ä¸ªã€‚`,
`ä½ ä¸å¤ªå­è°ˆâ€œä»¥åâ€ã€‚${sweet?"ä½ è¦çš„æ˜¯å¹¶è‚©ä¸åçˆ±ã€‚":"ä½ è¦çš„æ˜¯ç›Ÿçº¦ä¸æƒæŸ„ã€‚"}`,
`çš‡åè¯•æ¢ä½ ï¼Œä½ ä¸è·ªä¹Ÿä¸é¡¶â€”â€”ä½ æŠŠè¯è¯´å¾—æ»´æ°´ä¸æ¼ï¼šè®©å¥¹ä»¥ä¸ºä½ å¼±ï¼Œå®é™…ä½ åœ¨è—åˆ€ã€‚`,
`çœŸè¯æ®è½åœ°ï¼Œä½ æŠŠè´¦æœ¬æ‘Šåœ¨æ¡ˆä¸Šã€‚è‹æ¸…è²ç¬¬ä¸€æ¬¡è„¸è‰²å‘ç™½ï¼šå¥¹çŸ¥é“ï¼Œæ£‹è¦ç¿»äº†ã€‚`,
`é€¼å®«å‰å¤œï¼Œå¤ªå­é—®ä½ ç«™å“ªè¾¹ã€‚ä½ è¯´ï¼šæˆ‘ç«™èµ¢çš„ä¸€è¾¹â€”â€”ä½†èµ¢æ³•ç”±æˆ‘å®šã€‚`,
`ç»ˆå±€å¯¹å±€ï¼Œä½ äº²è‡ªè½å­ã€‚ä½ ä¸å†ç­‰ä»»ä½•äººæ•‘ä½ ï¼Œä½ å°±æ˜¯æ•‘ä½ çš„äººã€‚`,
`Day20ï¼šç³»ç»Ÿåœæ­¢æ’­æŠ¥ï¼Œä¸–ç•Œå®‰é™å¾—å¯æ€•ã€‚ä½ ç»ˆäºè¦é¢å¯¹â€œä½ è‡ªå·±é€‰å‡ºæ¥çš„ç»“å±€â€ã€‚`
  ][d-1];

  const flipText = [
`ä½ å½“ä¼—æŠŠæ±¤å€’è¿›èŠ±æ± ã€‚ç³»ç»Ÿå°–å«ï¼Œè´µå¥³éœ‡åŠ¨ã€‚ä½ ç¬‘å¾—æ— è¾œåˆç‹ ï¼šåˆ«æ‹¿æˆ‘å½“ç¬‘è¯ã€‚`,
`ä½ æŠŠç¤¼éƒ¨å·®äº‹æ¨å›å»ï¼šâ€œå†Œå­å¤ªåšï¼Œæˆ‘æ€•æ‰‹é…¸ã€‚â€å…¨åŸç¬¬ä¸€æ¬¡ä¸ºä½ å“‘ç«ã€‚`,
`ä½ æŠŠå¤ªå­å¦ƒåå†Œæ¨å›å»ï¼šâ€œæˆ‘ç¾è¾±çš„ä¸æ˜¯ä½ ï¼Œæ˜¯è¿™å¥—è§„çŸ©ã€‚â€`,
`èµèŠ±å®´ï¼Œä½ æŠŠæœ€æ¯’çš„æµè¨€æ€å›å»â€”â€”å½“ä¼—ç‚¹åâ€œè°ä¼ çš„å°±ç«™å‡ºæ¥â€ã€‚`,
`ä½ ç›´æ¥é—¯åé—¨ï¼ŒæŒ‰ä½å¬·å¬·çš„æ‰‹ï¼šâ€œç°åœ¨å°±å†™ä¾›çŠ¶ã€‚â€`,
`ä½ å½“ä¼—ç‚¹ç ´ï¼šå‚æ±¤æ˜¯è¯•æ¯’ã€‚å…¨åœºé™å¾—åƒåŸã€‚`,
`ä½ æŠŠä¼æŸ„å¤ºè¿‡æ¥ï¼šâ€œæ®¿ä¸‹åˆ«è£…ä½“è´´ï¼Œç»™æˆ‘ä¸€ä¸ªæ‰¿è¯ºã€‚â€`,
`å®«å®´ä¸Šä½ åæ‰‹è®©è‹æ¸…è²å‡ºä¸‘ï¼šè®©å¥¹åœ¨æ»¡æ®¿æƒè´µé¢å‰å¤±æ€ã€‚`,
`çº¿äººå¤±è¸ªï¼Ÿä½ ç›´æ¥å°è¡—æŸ¥äººï¼Œé€¼å¾—æš—çº¿ç‹—æ€¥è·³å¢™ã€‚`,
`å…µæƒé£å£ä½ ä¸é€€ï¼šä½ è¦æŠŠå°†å†›åºœå…µç¬¦æ¡è¿›è‡ªå·±æ‰‹é‡Œã€‚`,
`è‹æ¸…è²åå’¬ï¼Ÿä½ å½“ä¼—ç”©å‡ºâ€œå¥¹å‰åçŸ›ç›¾â€çš„ä¸‰å¤„è¯è¯ã€‚`,
`å¯†è°ˆä½ ä¸è®©æ­¥ï¼šä½ è¦çš„æ˜¯â€œä¸œå®«æŠ¤ä½ â€ï¼Œä¸æ˜¯ä¸€å¥â€œå­¤ä¼šè€ƒè™‘â€ã€‚`,
`ä½ æ”¾ç«çƒ§æ‰ä¸ç›¸åºœçš„è´¦æˆ¿â€”â€”ä¸æ˜¯æ¯è¯æ®ï¼Œæ˜¯é€¼çœŸè¯æ®ç°èº«ã€‚`,
`ç‰¢ç‹±é‡Œä½ ç»™ç‹±å’å¡é“¶å­ï¼šä¸æ˜¯æ±‚æƒ…ï¼Œæ˜¯ä¹°å‘½ã€ä¹°å£ä¾›ã€‚`,
`ä½ å½“ä¼—å®£å‘Šï¼šä»ä»Šå¤©èµ·ï¼Œä½ ä¸å†â€œç­‰èµå©šâ€ã€‚ä½ è¦è‡ªå·±é€‰ã€‚`,
`çš‡åä¸€å¥â€œå¥³å­å½“å®ˆç¤¼â€ï¼Œä½ å›ï¼šâ€œç¤¼è‹¥è¦æˆ‘æ­»ï¼Œé‚£ç¤¼è¯¥æ”¹ã€‚â€`,
`ä½ æŠŠè‹æ¸…è²çš„â€œç§è´¦â€å…¬å¼€ç»™æ»¡æœã€‚å¥¹çš„ç™½è²çš®ç›¸ç¢äº†ä¸€åœ°ã€‚`,
`é€¼å®«å‰å¤œä½ é€¼å¤ªå­ç«‹èª“ï¼šè‹¥èµ¢ï¼Œä½ è¦æƒï¼›è‹¥è¾“ï¼Œä½ é™ªæˆ‘æ­»ã€‚`,
`ç»ˆå±€å¯¹å±€ä½ ç›´æ¥è®©å¯¹æ‰‹å¤±å»é€€è·¯ï¼šä½ è¦çš„ä¸æ˜¯ä½“é¢èƒœåˆ©ï¼Œæ˜¯ç»å¯¹èƒœåˆ©ã€‚`,
`Day20ï¼šä½ æŠ¬æ‰‹æŠŠç³»ç»Ÿé¢æ¿å…³æ‰ã€‚ä½ çŸ¥é“â€”â€”ä½ å·²ç»ä¸éœ€è¦å®ƒã€‚`
  ][d-1];

  const stratText = [
`ä½ ä¸æ€æ¡Œï¼Œä½ åŸ‹çº¿ï¼šç›¯ä¸ç›¸åºœåé™¢ï¼Œé”å®šä¸ä¸œå®«å†…ä¾å¾€æ¥ã€‚`,
`ä½ æ¢è´¦æœ¬æ®‹é¡µï¼Œçœ‹åˆ°â€œä¸œå®«å°è®°â€ã€‚è¯æ®è–„ï¼Œä½†è–„åˆ€ä¹Ÿèƒ½å‰²å–‰ã€‚`,
`ä½ é€’è¯æ®è°ˆæ¡ä»¶ï¼šä½ è¦å¥¹çš„â€œæ— å¿ƒä¹‹å¤±â€å˜æˆé“è¯ã€‚`,
`ä½ è®©æš—å«ä¼ªé€ ä¸€æ¬¡â€œè¯¯ä¼ â€ï¼Œçœ‹è°æœ€æ€¥â€”â€”æ€¥çš„äººæœ€æœ‰é¬¼ã€‚`,
`ä½ æŠ“åˆ°â€œåé—¨è½¦å¤«â€çš„å£ä¾›ï¼šæœ‰äººé•¿æœŸè¿â€œç¤¼â€ã€‚`,
`ä½ ä»¥å¤ªåŒ»ä¹‹åæŸ¥è¯ææ¥æºï¼šä¸€æ¡ä¾›åº”é“¾ç‰µå‡ºä¸‰ä¸ªäººã€‚`,
`ä½ ç”¨ä¸€å°çœ‹ä¼¼æŸ”è½¯çš„ä¿¡ï¼Œé€¼å¤ªå­éœ²åº•ï¼šä»–åˆ°åº•æŠ¤ä¸æŠ¤ä½ ã€‚`,
`ä½ æŠŠå®«å®´åº§æ¬¡å½“æ£‹ç›˜ï¼šä½ è®©æ•Œäººååˆ°æœ€ä¸è¯¥åçš„ä½ç½®ã€‚`,
`ä½ æ•‘çº¿äººåŒæ—¶æ”¾å‡ºå‡çº¿ç´¢ï¼šè®©å¯¹æ–¹ä»¥ä¸ºä½ åœ¨è¿½é”™äººã€‚`,
`ä½ æŠŠå…µç¬¦ä¸ç²®è‰è´¦å¯¹ç…§ï¼šæœ‰äººåœ¨æŒªå†›é¥·ã€‚`,
`ä½ ç”¨â€œè¯äººä¿æŠ¤â€æ¢å£ä¾›ï¼šä½ å¼€å§‹åƒçœŸæ­£çš„æ“ç›˜æ‰‹ã€‚`,
`ä½ å’Œå¤ªå­åˆ¶å®šâ€œäº¤æ¢æ¸…å•â€ï¼šè¯æ®æ¢æŠ¤çŸ­ï¼ŒæŠ¤çŸ­æ¢å…µæƒæ”¯æŒã€‚`,
`ä½ å¼€è¯é“ºã€ç¨³ç²®ä»·ï¼Œé¡ºæ‰‹å»ºç«‹è‡ªå·±çš„â€œæ°‘é—´çº¿äººç½‘â€ã€‚`,
`ä½ è®©ç‰¢ç‹±é‡Œé‚£ä¸ªäººâ€œæ´»ç€å‡ºç‹±â€ï¼Œç„¶åè®©ä»–åœ¨æœå ‚ä¸Šå¼€å£ã€‚`,
`ä½ ç»™å¤ªå­ç•™ä¸€æ¡é€€è·¯ï¼šè¿™æ¡é€€è·¯è®©ä»–æ›´æ„¿æ„ç«™åœ¨ä½ è¿™è¾¹ã€‚`,
`ä½ å¯¹çš‡åç¤ºå¼±ä¸€æ¬¡ï¼šç¤ºå¼±æ˜¯ä¸ºäº†è®©å¥¹ä½ä¼°ä½ ã€‚`,
`ä½ æŠŠè¯æ®é“¾è¡¥æˆé—­ç¯ï¼šäººè¯+ç‰©è¯+æ—¶åºï¼Œç¼ºä¸€ä¸å¯ã€‚`,
`ä½ å¸ƒç½®ä¸‰æ¡æ’¤ç¦»è·¯ï¼šé€¼å®«è¿™ç§å±€ï¼Œè¾“ä¸èµ·ã€‚`,
`ä½ æŠŠå¯¹æ‰‹æœ€ä¿¡çš„é‚£ä¸ªäººæ‹‰åˆ°è‡ªå·±é˜µè¥ï¼šæ£‹å°±è¯¥ä»å†…éƒ¨ç¢ã€‚`,
`Day20ï¼šä½ æŠŠæ‰€æœ‰è´¦æœ¬æŒ‰æ—¥æœŸé“ºå¼€ã€‚ç»“å±€ï¼Œå°±æŒ‰äº‹å®æ¥åˆ¤ã€‚`
  ][d-1];

  const restText = [
`ä½ é—­é—¨ä¿®æ•´ã€‚ä½ çŸ¥é“çˆ½å¾ˆçŸ­ï¼Œèƒ½æ‰›æ‰é•¿ã€‚`,
`ä½ æŠ„å…µä¹¦ä¸€é¡µï¼Œç»ƒæ°”æ¯ä¸€åˆ»ã€‚ä½ ä¸åšâ€œæ·±æƒ…å¥³é…â€ï¼Œä½ åšâ€œä¼šèµ¢çš„äººâ€ã€‚`,
`ä½ ä»¥ç—…ä¸ºç›¾ï¼Œæš‚é¿é”‹èŠ’ã€‚ç³»ç»Ÿä¸æ»¡ï¼Œä½†æ‹¿ä½ æ²¡åŠæ³•ã€‚`,
`ä½ å­¦ç¤¼ä¸è°ˆåï¼ŒæŠŠâ€œä½“é¢â€ç»ƒæˆåˆ€é˜ã€‚`,
`ä½ ç»ƒå¼“ã€‚å¼“å¼¦æ‹‰æ»¡æ—¶ï¼Œä½ å¿ƒä¹Ÿæ›´ç¨³ã€‚`,
`ä½ è°ƒè¯è†³ã€‚ä½ è¦çš„æ˜¯ï¼šæ‰›å¾—ä½æ¯’ï¼Œæ‰›å¾—ä½å±€ã€‚`,
`ä½ å†™ä¸‹â€œåº•çº¿æ¸…å•â€ï¼šä»¥åè°è¸©çº¿ï¼Œä½ å°±è¸©å›å»ã€‚`,
`ä½ æ•´ç†äººè„‰ï¼šè°å¯ç”¨ï¼Œè°å¯å¼ƒï¼Œä¸€ç›®äº†ç„¶ã€‚`,
`ä½ ç¡è¶³ä¸€è§‰ã€‚ä½ ä¸é æ¿€æƒ…èµ¢ï¼Œä½ é ç»­èˆªèµ¢ã€‚`,
`ä½ ä¸çˆ¶äº²å¯¹è¯ï¼šä½ è¦ä»–ä¿¡ä½ ä¸€æ¬¡ã€‚`,
`ä½ æ”¶é›†åŸä¸­æµè¨€æ¥æºã€‚ä½ è¦æ§åˆ¶é£å‘ï¼Œä¸è¢«é£å‘æ§åˆ¶ã€‚`,
`ä½ ç»ƒâ€œæ¼”æˆâ€ï¼šçœ¼æ³ªè¦åœ¨è¯¥è½çš„æ—¶å€™è½ï¼Œç¬‘è¦åœ¨è¯¥å†·çš„æ—¶å€™å†·ã€‚`,
`ä½ å·¡è¡—æ–½ç²¥ã€‚ä½ è¦è®©äººè®°ä½ï¼šä½ ä¸æ˜¯ä¼ é—»ï¼Œä½ æ˜¯å®åœ¨ã€‚`,
`ä½ æŠŠè¯æ®æŠ„ä¸¤ä»½ã€‚çœŸæ­£çš„èµ¢å®¶ï¼Œä»ä¸èµŒä¸€æ¬¡æ€§ã€‚`,
`ä½ æŠŠæ„Ÿæƒ…æ”¾è¿›ç›’å­é‡Œï¼šéœ€è¦æ—¶æ‰“å¼€ï¼Œä¸éœ€è¦æ—¶é”ä¸Šã€‚`,
`ä½ ç»ƒä¸€å¥è¯ï¼šä¸è§£é‡Šï¼Œä¸è¾©è§£ï¼Œåªè®©ç»“æœè¯´è¯ã€‚`,
`ä½ æŠŠæ‰€æœ‰çº¿äººé‡æ–°åˆ†çº§ï¼šèƒ½æ´»ç€çš„ï¼Œæ‰æœ‰ä»·å€¼ã€‚`,
`ä½ æå‰å†™é—ä¹¦ï¼šä¸æ˜¯è®¤è¾“ï¼Œæ˜¯è®©è‡ªå·±æ›´ä¸æ€•ã€‚`,
`ä½ åœ¨é•œå‰ç»ƒæœ€åä¸€ç¬‘ï¼šèµ¢çš„æ—¶å€™è¦ç¬‘ï¼Œè¾“çš„æ—¶å€™ä¹Ÿè¦ç¬‘ã€‚`,
`Day20ï¼šä½ æ·±å‘¼å¸ã€‚ä½ ç»ˆäºèƒ½è¯´ï¼šæˆ‘ä¸æ€•ä»»ä½•ç»“å±€ã€‚`
  ][d-1];

  const actions = [
    {
      id:`D${d}-main`,
      name:"ç¨³ä½å±€é¢ï¼ˆä¸»çº¿/ä½“é¢æ¨è¿›ï¼‰",
      tags:["ä¸»çº¿","ä½é£é™©"],
      highlight:false,
      delta:{ "å¤ªå­å¥½æ„Ÿ":+2, "åç¦»åº¦":-1, "è´µå¥³å£°æœ›":+1, "ç³»ç»Ÿè­¦å‘Šå€¼":-2, "ç”œåº¦å€¼": sweet? +1 : 0 },
      story:`ã€${dayTitle(d)}ã€‘\nï¼ˆä¸»çº¿æ¨è¿›ï¼‰\n\n${mainText}`,
      mainDone:true,
      route:"main"
    },
    {
      id:`D${d}-flip`,
      name:"æ€æ¡Œå¼€æ€ï¼ˆé«˜é£é™©é«˜æ”¶ç›Šï¼‰",
      tags:["æ€æ¡Œ","é«˜é£é™©"],
      highlight:true,
      delta:{ "æ€æ¡Œå€¼":+6, "åç¦»åº¦":+3, "ç³»ç»Ÿè­¦å‘Šå€¼":+6, "è´µå¥³å£°æœ›":-1, "é»‘åŒ–å€¼":+2, "å¤ªå­å¥½æ„Ÿ": (sweet? +1 : 0) },
      story:`ã€${dayTitle(d)}ã€‘\nï¼ˆæ€æ¡Œï¼‰\n\n${flipText}\n\nç³»ç»Ÿæç¤ºï¼šåç¦»ä¸Šå‡ï¼Œæƒ©ç½šæ¦‚ç‡å¢åŠ ã€‚`,
      mainDone:false,
      route:"flip"
    },
    {
      id:`D${d}-strat`,
      name:"è¯æ®æ¨è¿›ï¼ˆè°‹ç•¥çº¿ï¼‰",
      tags:["è°‹ç•¥","ä¸­é£é™©"],
      highlight:false,
      delta:{ "è°‹ç•¥":+3, "åç¦»åº¦":+1, "è‹æ¸…è²æ€€ç–‘":+4, "è¯æ®å€¼":+3, "ç³»ç»Ÿè­¦å‘Šå€¼":+1, "å¤ªå­å¥½æ„Ÿ": +1 },
      story:`ã€${dayTitle(d)}ã€‘\nï¼ˆè°‹ç•¥çº¿ï¼‰\n\n${stratText}\n\nä½ ç¦»â€œé“è¯â€æ›´è¿‘äº†ä¸€æ­¥ã€‚`,
      mainDone:true,
      route:"strat"
    },
    {
      id:`D${d}-rest`,
      name:"é—­é—¨ä¿®æ•´ï¼ˆå›è¡€ç¨³å¿ƒï¼‰",
      tags:["å…»æˆ","ä½é£é™©"],
      highlight:false,
      delta:{ "å¿ƒæ™º":+4, "å¥åº·":+4, "åç¦»åº¦":0, "ç³»ç»Ÿè­¦å‘Šå€¼":-1, "ç”œåº¦å€¼": (sweet? +1 : 0) },
      story:`ã€${dayTitle(d)}ã€‘\nï¼ˆä¿®æ•´ï¼‰\n\n${restText}`,
      mainDone:true,
      route:"rest"
    }
  ];

  // é«˜å±æ—¶ï¼šä¸»çº¿æ›´â€œç¡¬â€ï¼Œæ€æ¡Œæ›´â€œç—›â€
  if(high){
    actions[1].delta["å¿ƒæ™º"] = -2;
    actions[1].delta["å¥åº·"] = -1;
    actions[1].story += `\n\nã€é«˜å±æƒ©ç½šé¢„è­¦ã€‘ç³»ç»Ÿå·²è¿›å…¥â€œå¼ºåˆ¶ä¿®æ­£æ¨¡å¼â€ã€‚`;
  }
  if(dark){
    actions[1].delta["é»‘åŒ–å€¼"] = +3;
  }
  return actions;
}

/* ========= æƒ©ç½š/å±æœº ========= */
function punish(level=1, reason="åç¦»ä¸»çº¿"){
  if(State.buffs.noPunishOnce){
    State.buffs.noPunishOnce=false;
    tip("å±è”½ç¬¦ç”Ÿæ•ˆï¼šå…ä¸€æ¬¡æƒ©ç½š", "warn");
    return;
  }

  // æ¼”æŠ€å¤§å¸ˆï¼šæ¦‚ç‡éª—è¿‡
  if(State.buffs.actor){
    if(Math.random() < 0.35){
      tip("æ¼”æŠ€å¤§å¸ˆï¼šä½ éª—è¿‡ç³»ç»Ÿä¸€æ¬¡", "warn");
      return;
    }
  }

  shakePunish();

  let base = level===1 ? 3 : level===2 ? 7 : 12;
  if(State.buffs.iron) base = Math.max(1, base-1);

  applyDelta({
    "å¿ƒæ™º": -base,
    "å¥åº·": -Math.max(1, Math.floor(base/2)),
    "ç³»ç»Ÿè­¦å‘Šå€¼": +(level===1 ? 10 : level===2 ? 20 : 35),
  });
  tip(`ç³»ç»Ÿæƒ©ç½šï¼š${reason}`, "bad");
}
function crisisMaybe(){
  const dev = State.player["åç¦»åº¦"];
  const warn = State.player["ç³»ç»Ÿè­¦å‘Šå€¼"];
  const p = clamp((dev/100)*0.45 + (warn/100)*0.35, 0, 0.75);
  if(Math.random() < p){
    const pool = [
      {
        title:"éšæœºå±æœºï¼šæµè¨€åå™¬",
        story:`ã€éšæœºå±æœºï¼šæµè¨€åå™¬ã€‘\n\nåŸé‡Œæµè¨€æ¢äº†æ–¹å‘ï¼š\nâ€œæŸ³æ‰¶é£ç–¯äº†â€â€œå°†å†›åºœå¤±æ•™â€ã€‚\n\nä½ å¬ç€åªç¬‘ï¼šæµè¨€åƒç‹—ï¼Œè°æ€•è°å°±è¿½è°ã€‚\nä½†ä½ ä¹Ÿæ˜ç™½ï¼šè¯¥åå‡»äº†ã€‚`,
        delta:{"è´µå¥³å£°æœ›":-3, "å®¶æ—å£°æœ›":-2, "ç³»ç»Ÿè­¦å‘Šå€¼":+5}
      },
      {
        title:"éšæœºå±æœºï¼šæš—æ¢è·Ÿè¸ª",
        story:`ã€éšæœºå±æœºï¼šæš—æ¢è·Ÿè¸ªã€‘\n\nå¤œé‡Œå··å£æœ‰è„šæ­¥å£°è·Ÿç€ä½ ã€‚\nä½ ä¸å›å¤´ï¼Œç›´æ¥æ‹è¿›ç¯ç«æœ€äº®çš„é“ºå­â€”â€”è®©å¯¹æ–¹ä¸æ•¢åŠ¨æ‰‹ã€‚\n\nä½ ç¨³ä½äº†å±€é¢ï¼Œä½†å¿ƒé‡Œæ›´å†·ã€‚`,
        delta:{"å¿ƒæ™º":-2, "è°‹ç•¥":+1, "ç³»ç»Ÿè­¦å‘Šå€¼":+4}
      },
      {
        title:"éšæœºå±æœºï¼šè‹æ¸…è²è¯•æ¢",
        story:`ã€éšæœºå±æœºï¼šè‹æ¸…è²è¯•æ¢ã€‘\n\nè‹æ¸…è²é€’æ¥ä¸€å°â€œå…³å¿ƒâ€çš„å¸–ã€‚\nå­—å­—æ¸©æŸ”ï¼Œå¥å¥åƒé’©å­ã€‚\n\nä½ æŠŠå¸–æ”¾åœ¨çƒ›ç«ä¸Šï¼Œæ…¢æ…¢çƒ§å®Œã€‚\næœ‰äº›æ¸©æŸ”ï¼Œå¾—ç”¨ç«å›ç¤¼ã€‚`,
        delta:{"è‹æ¸…è²æ€€ç–‘":+2, "åç¦»åº¦":+1, "æ€æ¡Œå€¼":+2}
      }
    ];
    const ev = pool[Math.floor(Math.random()*pool.length)];
    State.log.push({day:State.day, type:"crisis", title:ev.title});
    setStory(ev.story);
    applyDelta(ev.delta);
    renderAll();
    return true;
  }
  return false;
}

/* ========= æˆå°±åˆ¤å®š ========= */
function checkAchievements(){
  let unlockedNow = 0;
  Achievements.forEach(a=>{
    if(State.unlocked[a.id]) return;
    if(a.check(State)){
      State.unlocked[a.id] = true;
      unlockedNow++;
      tip(`è§£é”æˆå°±ï¼š${a.name}`, "warn");
    }
  });
  if(unlockedNow) autoSave();
}
function renderAchievements(){
  achList.innerHTML = "";
  Achievements.forEach(a=>{
    const got = !!State.unlocked[a.id];
    const el = document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <h4>${got ? "âœ…" : "ğŸ”’"} ${a.name}</h4>
      <div class="desc">${a.desc}</div>
      <div class="meta">${got ? "<span class='badge badge-ok'>å·²è§£é”</span>" : "<span class='badge badge-warn'>æœªè§£é”</span>"}</div>
    `;
    achList.appendChild(el);
  });
}

/* ========= ç»“å±€åˆ¤å®šï¼ˆå¤šç»“å±€ï¼‰ ========= */
function judgeEnding(){
  const P = State.player;
  const love = P["å¤ªå­å¥½æ„Ÿ"];
  const dark = P["é»‘åŒ–å€¼"];
  const ev   = P["è¯æ®å€¼"];
  const rep  = P["è´µå¥³å£°æœ›"];
  const warn = P["ç³»ç»Ÿè­¦å‘Šå€¼"];
  const hp   = P["å¥åº·"];
  const mind = P["å¿ƒæ™º"];

  // å´©ç›˜çº¿
  if(hp<=0 || mind<=0){
    return {
      title:"BEï¼šç—…å€’é€€åœº",
      text:`ä½ ç»ˆäºæ‰›ä¸ä½ã€‚\nç³»ç»Ÿå†·å†°å†°åœ°å®£å¸ƒâ€œä¿®æ­£æˆåŠŸâ€ã€‚\n\nä½ è¢«è¿«é€€å‡ºæ£‹å±€â€”â€”ä¸æ˜¯è¾“ç»™è‹æ¸…è²ï¼Œä¹Ÿä¸æ˜¯è¾“ç»™å¤ªå­ï¼Œè€Œæ˜¯è¾“ç»™â€œæŒç»­æ¶ˆè€—â€ã€‚\n\nï¼ˆæç¤ºï¼šå¤šç”¨ä¿®æ•´/å•†åŸ/é™ä½è­¦å‘Šå€¼å¯é¿å…ã€‚ï¼‰`
    };
  }

  // è¯æ®è¶³å¤Ÿå®šç½ª + å¤ªå­ä¿¡ä»»
  if(ev>=18 && love>=16 && dark<18){
    return {
      title:"HEï¼šå¹¶è‚©ä¸œå®«ï¼ˆç”œå® æƒè°‹åŒèµ¢ï¼‰",
      text:`ä½ æŠŠè¯æ®é“¾é“ºåˆ°æœ€åä¸€ç¯ã€‚\nè‹æ¸…è²çš„ç™½è²çš®ç›¸åœ¨æœå ‚ç¢æˆç²‰ã€‚\n\nå¤ªå­å½“ä¼—æŠ¤ä½ â€”â€”ä¸æ˜¯æ€œæ‚¯ï¼Œæ˜¯æ‰¿è®¤ã€‚\nä»–ä½å£°è¯´ï¼šâ€œä»¥åï¼Œä½ ä¸å¿…å†ä¸€ä¸ªäººæ‰›ã€‚â€\n\nä½ ç¬‘ï¼šâ€œé‚£æ®¿ä¸‹ä¹Ÿåˆ«æƒ³ä¸€ä¸ªäººèµ¢ã€‚â€\n\nä½ ä»¬å¹¶è‚©ç«™åœ¨æ›´é«˜å¤„ï¼Œä¸–äººåªçœ‹è§é£å…‰ï¼Œå´ä¸çŸ¥é“â€”â€”ä½ æ›¾ç»æ€è¿‡æ¡Œã€‚`
    };
  }

  // é»‘åŒ–é«˜ + æ€æ¡Œé«˜ï¼šå¥³å¸/æ‘„æ”¿è·¯çº¿
  if(dark>=18 && P["æ€æ¡Œå€¼"]>=20){
    return {
      title:"TEï¼šé»‘åŒ–ç™»é¡¶ï¼ˆä½ æ‰æ˜¯ç³»ç»Ÿï¼‰",
      text:`ä½ æŠŠäººå¿ƒå½“æ£‹ï¼ŒæŠŠè§„çŸ©å½“åˆ€ã€‚\n\nå¤ªå­æƒ³æ‹‰ä½ å›å»ï¼Œä½ å´åªè½»è½»æŒ‰ä½ä»–æ‰‹è…•ï¼š\nâ€œæ®¿ä¸‹ï¼Œä½ å¯ä»¥å–œæ¬¢æˆ‘ï¼Œä½†åˆ«å¦„æƒ³é©¯æœæˆ‘ã€‚â€\n\næœ€ç»ˆä½ èµ°åˆ°æ›´é«˜çš„ä½ç½®â€”â€”\nä¸æ˜¯å¤ªå­å¦ƒï¼Œä¸æ˜¯å¥³é…ã€‚\nè€Œæ˜¯ï¼šèƒ½å†³å®šæ‰€æœ‰äººå‘½è¿çš„äººã€‚\n\nç³»ç»Ÿæ²‰é»˜äº†ã€‚\nå› ä¸ºä½ å·²ç»æˆäº†æ›´å¼ºçš„â€œè§„åˆ™â€ã€‚`
    };
  }

  // è¯æ®è¶³å¤Ÿä½†çˆ±ä¸å¤Ÿï¼šæƒè°‹è”ç›Ÿ
  if(ev>=18 && love<16){
    return {
      title:"GEï¼šæƒè°‹åŒç›Ÿï¼ˆå†·ç”œè‡ªæ§ï¼‰",
      text:`ä½ å®šç½ªè‹æ¸…è²ï¼Œå¤ºå›ä¸»åŠ¨æƒã€‚\nå¤ªå­çœ‹ä½ çš„çœ¼ç¥å¤æ‚ï¼šæ¬£èµã€æˆ’å¤‡ã€è¿˜æœ‰ä¸€ç‚¹ç‚¹æ¥ä¸åŠè¯´çš„æƒ…ç»ªã€‚\n\nä½ ä»¬è¾¾æˆåŒç›Ÿã€‚\nä¸å¿…ç”œè¨€èœœè¯­ï¼Œä½†å½¼æ­¤éƒ½çŸ¥é“ï¼š\nè¿™ä¸–ä¸Šæœ€ç‰¢çš„å…³ç³»ï¼Œæ˜¯äº’ç›¸éœ€è¦ã€äº’ç›¸è®¤å¯ã€‚\n\nä½ èµ¢äº†ã€‚\nåªæ˜¯èµ¢å¾—å¾ˆå†·ï¼Œä¹Ÿå¾ˆæ¸…é†’ã€‚`
    };
  }

  // è­¦å‘Šå¤ªé«˜ï¼šç³»ç»Ÿå¼ºåˆ¶ä¿®æ­£
  if(warn>=85){
    return {
      title:"BEï¼šç³»ç»Ÿå¼ºåˆ¶ä¿®æ­£",
      text:`ä½ æ€å¾—å¤ªç‹ ï¼Œåç¦»å¤ªè¿œã€‚\nç³»ç»Ÿå¯åŠ¨â€œå¼ºåˆ¶ä¿®æ­£â€â€”â€”æŠŠæ‰€æœ‰çº¿ç´¢ã€ç›Ÿå‹ã€å¶ç„¶ï¼Œå…¨éƒ½å˜æˆä½ çš„æ•Œæ„ã€‚\n\nä½ ä»èƒ½æ´»ï¼Œä½†ä¼šè¢«è¿«å›åˆ°â€œå¥³é…äººè®¾â€ã€‚\n\nï¼ˆæç¤ºï¼šæ€æ¡Œè¦é…åˆâ€œæ¼”æŠ€å¤§å¸ˆ/å±è”½ç¬¦â€ï¼Œå¹¶å®šæœŸé™è­¦å‘Šã€‚ï¼‰`
    };
  }

  // ç”œå® è·¯çº¿ï¼ˆç”œåº¦é«˜ + å¥½æ„Ÿé«˜ï¼‰
  if(P["ç”œåº¦å€¼"]>=18 && love>=18 && dark<14){
    return {
      title:"HEï¼šç”œå® å½’å¤„ï¼ˆä½ è¢«åçˆ±ï¼‰",
      text:`ä½ ä¸å†é â€œå¿â€ã€‚\nä½ å­¦ä¼šè¦ã€å­¦ä¼šè¯´ã€å­¦ä¼šæŠŠè‡ªå·±æ”¾åœ¨ç¬¬ä¸€ä½ã€‚\n\nå¤ªå­æŠŠä½ æŠ¤åœ¨èº«åï¼Œå´ä¹Ÿæ„¿æ„åœ¨ä½ é¢å‰ä½å¤´ï¼š\nâ€œæ‰¶é£ï¼Œæˆ‘æƒ³è¦ä½ â€”â€”ä¸æ˜¯å½“æ£‹å­ï¼Œæ˜¯å½“å”¯ä¸€ã€‚â€\n\nä½ ä¼¸æ‰‹æ‰£ä½ä»–æŒ‡èŠ‚ï¼š\nâ€œé‚£å°±åˆ«è®©æˆ‘å†å—ä¸€æ¬¡å§”å±ˆã€‚â€\n\nä½ å¾—åˆ°åçˆ±ï¼Œä¹Ÿå®ˆä½é”‹èŠ’ã€‚\nè¿™ä¸€æ¬¡ï¼Œç”œæ˜¯ä½ çš„ã€‚`
    };
  }

  // é»˜è®¤æ™®é€šç»“å±€
  return {
    title:"NEï¼šä½ æ´»æˆä½ è‡ªå·±",
    text:`ä½ æ²¡æœ‰å½»åº•é»‘åŒ–ï¼Œä¹Ÿæ²¡æœ‰å½»åº•æ²‰æººã€‚\nä½ æŠŠâ€œå¥³é…å‘½è¿â€æ’•å¼€ä¸€æ¡å£å­ï¼Œç„¶åä»å£å­é‡Œèµ°å‡ºå»ã€‚\n\næˆ–è®¸ä¸æ˜¯æœ€ç”œã€ä¸æ˜¯æœ€ç‹ ã€‚\nä½†ä½ ç»ˆäºèƒ½å¯¹é•œå­é‡Œçš„äººè¯´ï¼š\nâ€œæˆ‘ä¸æ¬ ä»»ä½•äººã€‚â€`
  };
}

/* ========= View ========= */
function renderPortrait(){
  const p = Portraits[State.portraitIndex % Portraits.length];
  portraitBox.textContent = p.glyph;
  portraitName.textContent = p.name;
}
function renderSubtitle(){
  dayBadge.textContent = State.day;
  subtitle.innerHTML = `ã€Œ${dayTitle(State.day)}ã€<span class="small">ï¼ˆ${dayMainTask(State.day)}ï¼‰</span>`;
}
function renderStats(){
  statBox.innerHTML="";
  const P = State.player;
  const rows = [
    ["é£å", P.é£å], ["è°‹ç•¥", P.è°‹ç•¥], ["å¿ƒæ™º", P.å¿ƒæ™º], ["å¥åº·", P.å¥åº·],
    ["æ€æ¡Œå€¼", P.æ€æ¡Œå€¼], ["åç¦»åº¦", P.åç¦»åº¦], ["è´µå¥³å£°æœ›", P.è´µå¥³å£°æœ›],
    ["å®¶æ—å£°æœ›", P.å®¶æ—å£°æœ›], ["ç³»ç»Ÿè­¦å‘Šå€¼", P["ç³»ç»Ÿè­¦å‘Šå€¼"]],
    ["å¤ªå­å¥½æ„Ÿ", P["å¤ªå­å¥½æ„Ÿ"]], ["è‹æ¸…è²æ€€ç–‘", P["è‹æ¸…è²æ€€ç–‘"]],
    ["è¯æ®å€¼", P["è¯æ®å€¼"]], ["é»‘åŒ–å€¼", P["é»‘åŒ–å€¼"]], ["ç”œåº¦å€¼", P["ç”œåº¦å€¼"]],
  ];
  rows.forEach(([k,v])=>{
    const max = 100;
    const pct = clamp((v/max)*100,0,100);
    const el=document.createElement("div");
    el.className="stat";
    el.innerHTML = `<b>${k}</b><div class="bar"><div class="fill" style="width:${pct}%"></div></div><span class="val">${v}</span>`;
    statBox.appendChild(el);
  });
}
function renderSystem(extra=""){
  const P = State.player;
  const warn=P["ç³»ç»Ÿè­¦å‘Šå€¼"];
  let badge=`<span class="badge badge-ok">ç›‘æ§æ­£å¸¸</span>`;
  if(warn>=70) badge=`<span class="badge badge-bad">é«˜å±</span>`;
  else if(warn>=35) badge=`<span class="badge badge-warn">è­¦æƒ•</span>`;

  const done = State.resolvedToday ? "âœ…å·²ç»“ç®—" : "âŒæœªç»“ç®—";
  systemBox.innerHTML = `
    <div class="sysRow"><span>ğŸ“… å›åˆ</span><b>ç¬¬ ${State.day} æ—¥</b></div>
    <div class="sysRow"><span>ğŸ§¾ ä»Šæ—¥çŠ¶æ€</span><span>${done}</span></div>
    <div class="small">${dayMainTask(State.day)}</div>
    <div class="hr"></div>
    <div class="sysRow"><span>ğŸ‘ è­¦å‘Šç­‰çº§</span>${badge}</div>
    <div class="small">${extra || "ç³»ç»Ÿæ­£åœ¨åˆ†æä½ çš„â€œäººè®¾ä¸€è‡´æ€§â€â€¦"}</div>
  `;
}
function renderOptions(){
  optionBox.innerHTML="";
  if(State.day>20){
    optionBox.innerHTML = `<div class="small">ä½ å·²ç»é€šå…³ã€‚ç‚¹ã€æ¸…æ¡£é‡å¼€ã€‘å†æ¥ä¸€æ¬¡ã€‚</div>`;
    return;
  }
  const actions = getActionsForDay(State.day);

  actions.forEach((op, index)=>{
    const div=document.createElement("div");
    div.className="option";
    if(index === State.selectedIndex) div.classList.add("selected"); // âœ… å…³é”®ï¼šé«˜äº®åªçœ‹ selectedIndex

    const tag1 = op.tags?.[0] || "è¡ŒåŠ¨";
    const tag2 = op.tags?.[1] || "æœªçŸ¥";
    const cls1 = tag1==="ä¸»çº¿" ? "tag-main" : (tag1==="æ€æ¡Œ" ? "tag-risk" : "tag-safe");
    const cls2 = tag2.includes("é«˜") ? "tag-risk" : (tag2.includes("ä¸­") ? "tag-warn" : "tag-safe");

    const deltaText = Object.entries(op.delta).map(([k,v])=>`${k}${v>=0?"+":""}${v}`).join(" Â· ");

    div.innerHTML = `
      <span class="tag ${cls1}">${tag1}</span>
      <span class="tag ${cls2}">${tag2}</span>
      <div style="margin-top:6px;font-weight:800">${op.name}</div>
      <div class="small">${deltaText}</div>
    `;

    div.onclick = ()=>{
      // âœ… å…³é”®ï¼šç‚¹å‡»åªæ”¹å˜ selectedIndexï¼Œä¸ç»“ç®—ï¼Œä¸æ¨è¿›å¤©æ•°
      State.selectedIndex = index;
      renderOptions(); // åªåˆ·æ–°é«˜äº®
      tip(`å·²é€‰æ‹©ï¼š${op.name}`, "warn");
      autoSave();
    };

    optionBox.appendChild(div);
  });
}
function renderShop(){
  shopMoney.innerHTML = `å½“å‰æ€æ¡Œå€¼ï¼š<b style="color:var(--accent)">${State.player.æ€æ¡Œå€¼}</b> ï½œè¢«åŠ¨å·²æ‹¥æœ‰ï¼š${
    Object.entries(State.buffs).filter(([k,v])=>v && !k.startsWith("next") && k!=="noPunishOnce").map(([k])=>k).join(", ") || "æ— "
  }`;
  shopGrid.innerHTML="";
  Shop.forEach(item=>{
    const can = State.player.æ€æ¡Œå€¼ >= item.price;
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <h4>${item.name}</h4>
      <div class="meta"><span class="price">-${item.price} æ€æ¡Œå€¼</span><span>${can ? "å¯è´­ä¹°" : "ä½™é¢ä¸è¶³"}</span></div>
      <div class="desc">${item.desc}</div>
      <div class="row">
        <button class="btn" ${can ? "" : "disabled"}>è´­ä¹°å¹¶ä½¿ç”¨</button>
        <span class="small">ID: ${item.id}</span>
      </div>
    `;
    el.querySelector("button").onclick = ()=>purchase(item.id);
    shopGrid.appendChild(el);
  });
}
function renderAll(extra=""){
  renderPortrait();
  renderSubtitle();
  renderOptions();
  renderStats();
  renderSystem(extra);
}

/* ========= å›åˆæµç¨‹ ========= */
function resolveChosenAction(){
  if(State.day>20) return;

  if(State.selectedIndex === null){
    tip("å…ˆç‚¹ä¸€ä¸ªè¡ŒåŠ¨å†ç»“æŸå›åˆ", "bad");
    return;
  }
  if(State.resolvedToday){
    tip("æœ¬æ—¥å·²ç»“ç®—ï¼Œç›´æ¥ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©", "warn");
    return;
  }

  const actions = getActionsForDay(State.day);
  const op = actions[State.selectedIndex];

  // ä¸€æ¬¡æ€§buffï¼šæƒ…æŠ¥çº¿äºº
  if(State.buffs.nextIntelBoost){
    State.buffs.nextIntelBoost=false;
    applyDelta({è°‹ç•¥:+3});
    tip("æƒ…æŠ¥çº¿äººï¼šè°‹ç•¥åŠ æˆè§¦å‘", "warn");
  }
  // äººè„‰ï¼šä¸»çº¿/ä½“é¢é¢å¤–åŠ æˆ
  const extra = {};
  if(State.buffs.lux && op.tags?.[0]==="ä¸»çº¿"){
    extra["è´µå¥³å£°æœ›"] = (extra["è´µå¥³å£°æœ›"]||0) + 2;
  }

  // å†™å‰§æƒ… + åº”ç”¨æ•°å€¼
  setStory(op.story);
  applyDelta({...op.delta, ...extra});

  // ä¸»çº¿æ²¡åšï¼ˆæ€æ¡Œï¼‰â†’ æƒ©ç½šæ¦‚ç‡ä¸Šå‡
  if(!op.mainDone){
    const warn = State.player["ç³»ç»Ÿè­¦å‘Šå€¼"];
    const lvl = warn>=70 ? 2 : 1;
    punish(lvl, "ä½ é€‰æ‹©äº†é«˜å¼ºåº¦åç¦»");
  }

  // å¥åº·å¤ªä½ï¼šå¼ºåˆ¶ä¼‘å…»æç¤º
  if(State.player["å¥åº·"]<=15){
    tip("å¥åº·è¿‡ä½ï¼šä¸‹ä¸€å¤©å»ºè®®ä¿®æ•´", "bad");
    applyDelta({"ç³»ç»Ÿè­¦å‘Šå€¼":+3});
  }

  State.resolvedToday = true;
  State.log.push({day:State.day, type:"action", id:op.id, name:op.name});

  checkAchievements();
  autoSave();
  renderAll("æœ¬æ—¥å·²ç»“ç®—ï¼šå†ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ã€‚");
}
function endTurn(){
  // å¦‚æœè¿˜æ²¡ç»“ç®— â†’ å…ˆç»“ç®—ï¼ˆæ›´ç¬¦åˆä½ ç°åœ¨çš„æ“ä½œä¹ æƒ¯ï¼‰
  if(!State.resolvedToday){
    resolveChosenAction();
    return;
  }

  // è¿›å…¥ä¸‹ä¸€å¤©
  if(State.day < 20){
    // å›åˆç»“æŸæ—¶éšæœºå±æœºï¼ˆå¯é€‰ï¼‰
    crisisMaybe();

    State.day++;
    State.selectedIndex = null;
    State.resolvedToday = false;

    // è¿›å…¥æ–°ä¸€å¤©æ—¶ç»™ä¸€æ®µå¼€åœº
    setStory(`ã€${dayTitle(State.day)}ã€‘\n\n${dayMainTask(State.day)}\n\nä½ æŠ¬çœ¼çœ‹å‘æ›´æ·±çš„å±€ã€‚\nè¿™ä¸€æ¬¡ï¼Œä½ ä¸ç­‰å‰§æƒ…æ¨ä½ â€”â€”ä½ æ¨å‰§æƒ…ã€‚`);
    checkAchievements();
    autoSave();
    renderAll("è¿›å…¥æ–°ä¸€å¤©ï¼šè¯·é€‰æ‹©è¡ŒåŠ¨ã€‚");
    return;
  }

  // Day20ï¼šè‡ªåŠ¨ç»“å±€
  if(State.day === 20){
    if(!State.resolvedToday){
      resolveChosenAction();
      return;
    }
    const ending = judgeEnding();
    setStory(`ã€ç¬¬äºŒåæ—¥ Â· ç»“å±€åˆ¤å®šã€‘\n\nã€Š${ending.title}ã€‹\n\n${ending.text}\n\nï¼ˆä½ å¯ä»¥æ¸…æ¡£é‡å¼€ï¼Œå°è¯•ä¸åŒè·¯çº¿ï¼šç”œå®  / æƒè°‹é»‘åŒ– / è¯æ®æµã€‚ï¼‰`);
    State.day = 21;
    State.selectedIndex = null;
    State.resolvedToday = true;
    checkAchievements();
    autoSave();
    renderAll("å·²é€šå…³ï¼šå¯æ¸…æ¡£é‡å¼€ã€‚");
  }
}

/* ========= å•†åŸè´­ä¹° ========= */
function purchase(id){
  const item = Shop.find(x=>x.id===id);
  if(!item) return;
  if(State.player["æ€æ¡Œå€¼"] < item.price){
    tip("æ€æ¡Œå€¼ä¸è¶³", "bad");
    return;
  }
  State.player["æ€æ¡Œå€¼"] -= item.price;
  item.apply(State);
  tip(`è´­ä¹°æˆåŠŸï¼š${item.name}`, "warn");
  autoSave();
  renderShop();
  renderStats();
}

/* ========= å­˜æ¡£/è¯»æ¡£/æ¸…æ¡£ ========= */
const SAVE_KEY = "boli_save_ultimate_v1";
function autoSave(){
  try{
    localStorage.setItem(SAVE_KEY, JSON.stringify(State));
  }catch(e){}
}
function saveGame(){
  autoSave();
  tip("å·²å­˜æ¡£ï¼ˆlocalStorageï¼‰", "good");
}
function loadGame(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){
    tip("æ²¡æœ‰å­˜æ¡£", "bad");
    return;
  }
  try{
    const obj = JSON.parse(raw);
    if(!obj || obj.version!=="boli-ultimate-v1") throw new Error("ç‰ˆæœ¬ä¸åŒ¹é…");
    State = obj;
    tip("è¯»æ¡£æˆåŠŸ", "good");
    renderAll("å·²è¯»æ¡£ã€‚");
    if(!State.lastStory){
      setStory(`ã€${dayTitle(State.day)}ã€‘\n\nè¯·é€‰æ‹©è¡ŒåŠ¨ã€‚`);
    }
  }catch(e){
    tip("è¯»æ¡£å¤±è´¥ï¼šå­˜æ¡£æŸå/ç‰ˆæœ¬ä¸åŒ¹é…", "bad");
  }
}
function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  State = freshState();
  setStory(`ä½ çŒ›åœ°çå¼€çœ¼ã€‚\n\nç»£å¸ä½å‚ï¼Œæª€é¦™å¹½å¹½ã€‚\nä½ ç©¿è¿›è™æ–‡ï¼Œæˆäº†æœ€ç»ˆæƒ¨æ­»çš„å¥³é…ï¼šæŸ³æ‰¶é£ã€‚\n\nç³»ç»ŸéŸ³å“èµ·ï¼š\nã€ä¸»çº¿ï¼šä»Šæ—¥åˆåå‰å¾€ä¸œå®«é€å‚æ±¤ã€‘\n\nä½ æŒ‡å°–å‘ç™½ï¼š\nâ€œè¿™ä¸€ä¸–â€”â€”æˆ‘ä¸å½“æ€¨ç§ã€‚æ¡Œå­ï¼Ÿæˆ‘æ¥æ€ã€‚â€`);
  tip("å·²æ¸…æ¡£é‡å¼€", "warn");
  renderAll("è¯·é€‰æ‹©è¡ŒåŠ¨ã€‚");
  autoSave();
}
function loadAuto(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw) return null;
  try{
    const obj = JSON.parse(raw);
    if(obj && obj.version==="boli-ultimate-v1") return obj;
  }catch(e){}
  return null;
}

/* ========= AIï¼šç»­å†™ï¼ˆOpenAIå…¼å®¹ /v1/chat/completionsï¼‰ ========= */
async function aiContinue(){
  const base = localStorage.getItem("boli_ai_base") || AI_DEFAULT.baseURL;
  const model = localStorage.getItem("boli_ai_model") || AI_DEFAULT.model;
  const key = localStorage.getItem("boli_ai_key") || AI_DEFAULT.key;

  if(!key){
    tip("å…ˆç‚¹ã€è®¾ç½®AIå¯†é’¥ã€‘", "bad");
    openAPI();
    return;
  }

  const ctx = `ä½ æ˜¯å¤é£äº’åŠ¨æ–‡å­—æ¸¸æˆçš„æ—ç™½ä¸å‰§æƒ…å¼•æ“ã€‚\nè¦æ±‚ï¼šä¸­æ–‡ã€å¸¦æƒ…ç»ªã€ç”œå® /æƒè°‹éƒ½èƒ½å†™ã€æ¯æ®µä¸è¶…è¿‡220å­—ï¼Œæœ€åç»™å‡º4ä¸ªæ–°è¡ŒåŠ¨é€‰é¡¹ã€‚\nå½“å‰Day=${State.day}ã€‚\nç©å®¶çŠ¶æ€=${JSON.stringify(State.player)}ã€‚\næœ€è¿‘å‰§æƒ…ï¼š\n${State.lastStory}\n`;
  const user = `è¯·åŸºäºå½“å‰å‰§æƒ…ç»­å†™ä¸‹ä¸€æ®µï¼ˆå¯æ¥ä¸‹ä¸€å¤©æˆ–æ¥å½“å‰åç»­ï¼‰ï¼Œå¹¶ç»™4ä¸ªè¡ŒåŠ¨é€‰é¡¹ï¼ˆä¸»çº¿/æ€æ¡Œ/è°‹ç•¥/å…»æˆï¼‰ã€‚`;

  tip("AIè¯·æ±‚ä¸­â€¦", "warn");

  try{
    const resp = await fetch(base.replace(/\/$/,"") + "/chat/completions", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + key
      },
      body: JSON.stringify({
        model,
        messages:[
          {role:"system", content: ctx},
          {role:"user", content: user}
        ],
        temperature: 0.85
      })
    });

    if(!resp.ok){
      const t = await resp.text();
      throw new Error(`HTTP ${resp.status} ${t}`);
    }
    const data = await resp.json();
    const text = data?.choices?.[0]?.message?.content || "";
    if(!text) throw new Error("ç©ºè¿”å›");

    // ç›´æ¥æ˜¾ç¤ºAIç»­å†™ï¼ˆä¸æ”¹å˜å¤©æ•°ï¼Œä¸æ”¹é€‰é¡¹ç»“æ„ï¼›åªæ˜¯è®©ä½ çœ‹ï¼‰
    setStory(`ã€AIç»­å†™ã€‘\n\n${text}`);
    tip("AIç»­å†™å®Œæˆ", "good");
    autoSave();
  }catch(e){
    tip("AIè¯·æ±‚å¼‚å¸¸ï¼ˆå¸¸è§ï¼šbaseURL/model/CORSï¼‰", "bad");
    setStory(`ã€AIè¯·æ±‚å¼‚å¸¸ã€‘\n\n${String(e)}\n\næ’æŸ¥ï¼š\n1ï¼‰baseURL æ˜¯å¦æ˜¯ https://xxx/v1\n2ï¼‰model æ˜¯å¦æ˜¯ä½ ç«™ç‚¹æ”¯æŒçš„æ¨¡å‹å\n3ï¼‰è¯¥ç«™ç‚¹æ˜¯å¦å…è®¸æµè§ˆå™¨è·¨åŸŸï¼ˆCORSï¼‰\n\nå¦‚æœç«™ç‚¹ä¸æ”¯æŒCORSï¼Œä½ éœ€è¦ç”¨â€œæœåŠ¡ç«¯ä»£ç†â€æˆ–æ¢æ”¯æŒCORSçš„APIç½‘å…³ã€‚`);
  }
}

/* ========= è‡ªå®šä¹‰è¡ŒåŠ¨ï¼ˆåªå†™å‰§æƒ…+è½»å¾®æ•°å€¼ï¼‰ ========= */
function customAction(){
  const txt = prompt("å†™ä¸‹ä½ æœ¬å›åˆæƒ³åšçš„è¡ŒåŠ¨ï¼ˆä¼šä½œä¸ºå‰§æƒ…æ˜¾ç¤ºï¼Œä¸ä¼šè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å¤©ï¼‰");
  if(!txt) return;
  setStory(`ã€è‡ªå®šä¹‰è¡ŒåŠ¨ã€‘\n\n${txt}\n\nç³»ç»Ÿè®°å½•ï¼šä½ æ­£åœ¨ç”¨è‡ªå·±çš„æ„å¿—æ”¹å†™å‰§æœ¬ã€‚`);
  applyDelta({"åç¦»åº¦":+1, "æ€æ¡Œå€¼":+1});
  State.resolvedToday = false; // å…è®¸ä½ ç»§ç»­é€‰è¡ŒåŠ¨ç»“ç®—
  autoSave();
  renderAll("è‡ªå®šä¹‰è¡ŒåŠ¨å·²è®°å½•ï¼šä»éœ€é€‰æ‹©å››é€‰ä¸€å¹¶ç»“æŸå›åˆæ¨è¿›å¤©æ•°ã€‚");
}

/* ========= APIè®¾ç½®UI ========= */
function openAPI(){
  apiBase.value = localStorage.getItem("boli_ai_base") || AI_DEFAULT.baseURL;
  apiModel.value = localStorage.getItem("boli_ai_model") || AI_DEFAULT.model;
  apiKey.value = localStorage.getItem("boli_ai_key") || AI_DEFAULT.key;
  apiHint.textContent = "æç¤ºï¼šè‹¥AIè¯·æ±‚å¼‚å¸¸ï¼Œå¤šåŠæ˜¯ baseURL/model ä¸å¯¹æˆ–CORSã€‚";
  apiMask.classList.add("show");
}
function closeAPI(){ apiMask.classList.remove("show"); }
async function testAPI(){
  const base = apiBase.value.trim();
  const model = apiModel.value.trim();
  const key = apiKey.value.trim();
  if(!base || !model || !key){
    apiHint.textContent = "è¯·å…ˆå¡«å†™ baseURL / model / keyã€‚";
    return;
  }
  apiHint.textContent = "æµ‹è¯•ä¸­â€¦";
  try{
    const resp = await fetch(base.replace(/\/$/,"") + "/chat/completions", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Authorization":"Bearer " + key },
      body: JSON.stringify({
        model,
        messages:[{role:"user", content:"å›å¤ä¸€ä¸ªOKï¼ˆåªè¦OKä¸¤ä¸ªå­—ï¼‰"}],
        temperature: 0
      })
    });
    const txt = await resp.text();
    if(!resp.ok) throw new Error(`HTTP ${resp.status} ${txt}`);
    apiHint.textContent = "âœ… æµ‹è¯•æˆåŠŸï¼šä½ çš„æ¥å£å¯ç”¨ã€‚";
  }catch(e){
    apiHint.textContent = "âŒ æµ‹è¯•å¤±è´¥ï¼š" + String(e);
  }
}

/* ========= äº‹ä»¶ç»‘å®š ========= */
$("btnEnd").onclick = endTurn;
$("btnCustom").onclick = customAction;
$("btnAI").onclick = aiContinue;
$("btnSkip").onclick = ()=>{
  State.day = 20;
  State.selectedIndex = 0;
  State.resolvedToday = true;
  const ending = judgeEnding();
  setStory(`ã€ç¬¬äºŒåæ—¥ Â· ç»“å±€åˆ¤å®šã€‘\n\nã€Š${ending.title}ã€‹\n\n${ending.text}`);
  State.day = 21;
  autoSave();
  renderAll("å·²ç›´æ¥ç»“å±€ã€‚å¯æ¸…æ¡£é‡å¼€ã€‚");
};

$("btnShop").onclick = ()=>{ renderShop(); shopMask.classList.add("show"); };
$("btnCloseShop").onclick = ()=>shopMask.classList.remove("show");

$("btnAch").onclick = ()=>{ renderAchievements(); achMask.classList.add("show"); };
$("btnCloseAch").onclick = ()=>achMask.classList.remove("show");

$("btnSave").onclick = saveGame;
$("btnLoad").onclick = loadGame;
$("btnReset").onclick = resetGame;

$("btnAPI").onclick = openAPI;
$("btnCloseAPI").onclick = closeAPI;
$("btnSaveAPI").onclick = ()=>{
  localStorage.setItem("boli_ai_base", apiBase.value.trim());
  localStorage.setItem("boli_ai_model", apiModel.value.trim());
  localStorage.setItem("boli_ai_key", apiKey.value.trim());
  tip("AIè®¾ç½®å·²ä¿å­˜ï¼ˆæœ¬åœ°ï¼‰", "good");
  closeAPI();
};
$("btnTestAPI").onclick = testAPI;
$("btnClearAPI").onclick = ()=>{
  localStorage.removeItem("boli_ai_base");
  localStorage.removeItem("boli_ai_model");
  localStorage.removeItem("boli_ai_key");
  apiBase.value = "";
  apiModel.value = "";
  apiKey.value = "";
  apiHint.textContent = "å·²æ¸…ç©ºã€‚";
};

$("btnPortrait").onclick = ()=>{
  State.portraitIndex = (State.portraitIndex + 1) % Portraits.length;
  renderPortrait();
  autoSave();
};

/* ========= åˆå§‹åŒ– ========= */
(function init(){
  if(!State.lastStory){
    setStory(`ä½ çŒ›åœ°çå¼€çœ¼ã€‚\n\nç»£å¸ä½å‚ï¼Œæª€é¦™å¹½å¹½ã€‚\nä½ ç©¿è¿›è™æ–‡ï¼Œæˆäº†æœ€ç»ˆæƒ¨æ­»çš„å¥³é…ï¼šæŸ³æ‰¶é£ã€‚\n\nç³»ç»ŸéŸ³å“èµ·ï¼š\nã€ä¸»çº¿ï¼šä»Šæ—¥åˆåå‰å¾€ä¸œå®«é€å‚æ±¤ã€‘\n\nä½ æŒ‡å°–å‘ç™½ï¼š\nâ€œè¿™ä¸€ä¸–â€”â€”æˆ‘ä¸å½“æ€¨ç§ã€‚æ¡Œå­ï¼Ÿæˆ‘æ¥æ€ã€‚â€`);
  }else{
    storyBox.textContent = State.lastStory;
  }
  checkAchievements();
  renderAll("è¯·é€‰æ‹©è¡ŒåŠ¨ã€‚");
  autoSave();
})();
</script>
</body>
</html>
