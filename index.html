<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ€¨ç§å¥³é…æ€æ¡Œå½• Â· ç»ˆæå®Œæ•´ç‰ˆ Day1â€“Day20</title>
<style>
:root{
  --bg:#0f1220;
  --card:#1b1f3a;
  --card2:#14182e;
  --text:#eaeaff;
  --muted:#b7b9ff;
  --border:#3b3f7a;
  --accent:#ff6aa2;
  --good:#7cffb2;
  --warn:#ffd36b;
  --bad:#ff5b5b;
  --glow:#ff6aa288;
  --shadow:0 0 12px #0007;
  --r:14px;
}
*{box-sizing:border-box}
body{
  margin:0;
  color:var(--text);
  font-family:"PingFang SC","Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background: radial-gradient(1200px 800px at 20% 0%, #1a1f44 0%, var(--bg) 55%, #0b0d18 100%);
}
.container{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  padding:12px;
}
.card{
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:14px;
  box-shadow:var(--shadow);
  position:relative;
  overflow:hidden;
}
h3{margin:0 0 10px; color:var(--accent); font-size:16px; letter-spacing:.4px;}
.small{font-size:12px;color:var(--muted);line-height:1.55}
.hr{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:10px 0;}
@media(max-width:860px){.container{grid-template-columns:1fr;}}

/* story */
#story{height:300px;overflow:auto;line-height:1.78;font-size:14px;padding-right:6px;white-space:pre-wrap}
#story::-webkit-scrollbar{width:8px}
#story::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

/* options */
.option{
  background:#242a62;
  border:1px solid #2f3578;
  padding:10px;
  margin:8px 0;
  border-radius:10px;
  cursor:pointer;
  transition:.15s;
  user-select:none;
}
.option:hover{transform:translateY(-1px); border-color:var(--accent); box-shadow:0 0 10px var(--glow);}
.option.highlight{border-color:var(--accent); box-shadow:0 0 16px var(--glow);}
.tag{
  display:inline-block;
  font-size:12px;
  padding:2px 8px;
  border-radius:999px;
  margin-right:8px;
  border:1px solid #ffffff22;
  opacity:.95;
}
.tag-main{color:var(--accent);background:#ff6aa214;border-color:#ff6aa244;}
.tag-safe{color:var(--good);background:#7cffb214;border-color:#7cffb255;}
.tag-risk{color:var(--bad);background:#ff5b5b14;border-color:#ff5b5b66;}
.tag-warn{color:var(--warn);background:#ffd36b14;border-color:#ffd36b66;}

/* stats */
.stat{display:flex;align-items:center;gap:10px;margin:6px 0;font-size:13px;}
.stat b{width:92px;color:#fff;font-weight:600}
.bar{flex:1;height:8px;background:#00000033;border:1px solid #ffffff12;border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,#7cffb2,#ffd36b,#ff6aa2);width:50%}
.val{width:46px;text-align:right}

/* system */
.sysRow{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0;font-size:13px;}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ffffff22;}
.badge-ok{color:var(--good);border-color:#7cffb266;background:#7cffb214;}
.badge-warn{color:var(--warn);border-color:#ffd36b66;background:#ffd36b12;}
.badge-bad{color:var(--bad);border-color:#ff5b5b66;background:#ff5b5b14;}

.btn{
  cursor:pointer;
  border-radius:10px;
  padding:8px 10px;
  border:1px solid #ffffff22;
  background:#20245a;
  color:var(--text);
  transition:.15s;
  font-size:13px;
}
.btn:hover{transform:translateY(-1px);border-color:var(--accent);box-shadow:0 0 10px var(--glow);}
.btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

/* floating tip */
.float{
  position:fixed; right:14px; top:14px; z-index:9999;
  padding:8px 10px; border-radius:10px;
  border:1px solid #ffffff22; background:#12152aee; box-shadow:var(--shadow);
  animation: floatUp 1.4s ease-out forwards; font-size:13px;
  max-width:min(92vw, 360px);
}
.float.good{color:var(--good);border-color:#7cffb255}
.float.bad{color:var(--bad);border-color:#ff5b5b66}
.float.warn{color:var(--warn);border-color:#ffd36b66}
@keyframes floatUp{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-40px)}}

/* punishment animation */
.flash{position:fixed;inset:0;background:radial-gradient(900px 400px at 50% 20%, #ff5b5b33, transparent 70%);opacity:0;pointer-events:none;z-index:9998;}
.flash.on{animation:flash .55s ease-in-out;}
@keyframes flash{0%{opacity:0}35%{opacity:1}100%{opacity:0}}
.shake{animation:shake .42s linear}
@keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}100%{transform:translateX(0)}}

/* modal */
.mask{position:fixed;inset:0;background:#00000088;display:none;align-items:center;justify-content:center;z-index:10000;}
.mask.show{display:flex}
.modal{
  width:min(860px, 92vw);
  max-height:84vh;
  overflow:auto;
  background:linear-gradient(180deg,#1b1f3a 0%, #14182e 100%);
  border:1px solid var(--border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:14px;
}
.modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px;}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
@media(max-width:680px){.grid2{grid-template-columns:1fr}}
.item{border:1px solid #ffffff1a;background:#10132a66;border-radius:12px;padding:10px;}
.item h4{margin:0 0 6px;color:#fff;font-size:14px;}
.meta{display:flex;gap:8px;align-items:center;margin:6px 0;font-size:12px;color:var(--muted);flex-wrap:wrap}
.price{color:var(--accent);border:1px solid #ff6aa244;background:#ff6aa214;border-radius:999px;padding:2px 8px;}
.desc{font-size:12px;line-height:1.55;color:#d7d9ff;}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
input,select,textarea{
  width:100%; padding:8px 10px; border-radius:10px;
  border:1px solid #ffffff22; background:#0f1220; color:var(--text);
}
textarea{min-height:88px;resize:vertical}

/* portrait */
.portraitWrap{display:flex;gap:10px;align-items:center}
.portrait{
  width:74px;height:74px;border-radius:16px;
  border:1px solid #ffffff22; background:#0b0d18;
  display:flex;align-items:center;justify-content:center;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.portrait svg{width:84px;height:84px;opacity:.98}
.pName{font-weight:800}
.pHint{font-size:12px;color:var(--muted);line-height:1.4}
.badgeMini{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #ffffff22;color:var(--muted)}
</style>
</head>

<body>
<div class="flash" id="flash"></div>

<div class="container">

  <!-- Portrait / Achievements -->
  <div class="card" id="cardPortrait">
    <h3>ğŸ§ ç«‹ç»˜ / å…³ç³»</h3>
    <div class="portraitWrap">
      <div class="portrait" id="portrait"></div>
      <div style="flex:1">
        <div class="pName" id="pName">æŸ³æ‰¶é£</div>
        <div class="pHint" id="pHint">ä½ ä¸å½“æ€¨ç§ï¼Œä½ æ€æ¡Œã€‚</div>
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap" id="miniBadges"></div>
      </div>
      <button class="btn" id="btnPortrait">åˆ‡æ¢ç«‹ç»˜</button>
    </div>
    <div class="hr"></div>
    <div class="small" id="achvPreview">æˆå°±ï¼š0 / 12</div>
    <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnAchv">ğŸ† æˆå°±åˆ—è¡¨</button>
      <button class="btn" id="btnAI">ğŸ¤– AIç»­å†™</button>
      <button class="btn" id="btnAIKey">ğŸ”‘ è®¾ç½®AIå¯†é’¥</button>
    </div>
  </div>

  <div class="card" id="cardStory">
    <h3>ğŸ“œ å½“å‰å‰§æƒ…</h3>
    <div class="small" id="subtitle"></div>
    <div class="hr"></div>
    <div id="story"></div>
  </div>

  <div class="card" id="cardAction">
    <h3>ğŸ¯ è¡ŒåŠ¨é¢æ¿</h3>
    <div class="small">æ¯å›åˆé€‰ 1 é¡¹ â†’ è¿›å…¥ç»“ç®— â†’ ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ã€‚é«˜äº®=æ€æ¡Œ/é«˜é£é™©ã€‚</div>
    <div class="hr"></div>
    <div id="options"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnCustom">âœï¸ è‡ªå®šä¹‰è¡ŒåŠ¨</button>
      <button class="btn" id="btnEnd">â© ç»“æŸæœ¬å›åˆ</button>
      <button class="btn" id="btnSkip">â­ï¸ ç›´æ¥åˆ°Day20ç»“å±€</button>
    </div>
  </div>

  <div class="card" id="cardStats">
    <h3>ğŸ“Š è§’è‰²çŠ¶æ€</h3>
    <div class="small">è­¦å‘Šå€¼â‰¥70æƒ©ç½šæ›´ç‹ ï¼›å¥åº·â‰¤15å¯èƒ½â€œç—…å€’â€å¼ºåˆ¶ä¼‘å…»ï¼›Day20è‡ªåŠ¨ç»“å±€åˆ¤å®šã€‚</div>
    <div class="hr"></div>
    <div id="stats"></div>
  </div>

  <div class="card" id="cardSystem">
    <h3>âš™ ç³»ç»Ÿç›‘æ§</h3>
    <div id="system"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnShop">ğŸ›’ ç³»ç»Ÿå•†åŸ</button>
      <button class="btn" id="btnSave">ğŸ’¾ å­˜æ¡£</button>
      <button class="btn" id="btnLoad">ğŸ“¥ è¯»æ¡£</button>
      <button class="btn" id="btnReset">ğŸ§¨ æ¸…æ¡£é‡å¼€</button>
    </div>
  </div>

</div>

<!-- Shop Modal -->
<div class="mask" id="shopMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ›’ ç³»ç»Ÿå•†åŸ</div>
        <div class="small">è´§å¸=æ€æ¡Œå€¼ã€‚ä¹°æŠ€èƒ½æ›´å®¹æ˜“â€œéª—è¿‡ç³»ç»Ÿâ€ã€‚</div>
      </div>
      <button class="btn" id="btnCloseShop">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div class="small" id="shopMoney"></div>
    <div class="grid2" id="shopGrid"></div>
  </div>
</div>

<!-- Achievements Modal -->
<div class="mask" id="achvMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ† æˆå°±ç³»ç»Ÿ</div>
        <div class="small">æ»¡è¶³æ¡ä»¶ä¼šè‡ªåŠ¨è§£é”ï¼ˆä¼šå¼¹æç¤ºï¼‰ã€‚</div>
      </div>
      <button class="btn" id="btnCloseAchv">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div id="achvList" class="grid2"></div>
  </div>
</div>

<!-- AI Settings Modal -->
<div class="mask" id="aiMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ”‘ AIè®¾ç½®</div>
        <div class="small">æŠŠä½ çš„ API åœ°å€ / Key / æ¨¡å‹å¡«è¿›å»ã€‚åªä¿å­˜åœ¨æœ¬æœº localStorageã€‚</div>
      </div>
      <button class="btn" id="btnCloseAI">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div class="item">
        <h4>API Base URL</h4>
        <div class="desc">ç¤ºä¾‹ï¼š<span class="badgeMini">https://api.xxx.com/v1</span>ï¼ˆå¿…é¡»å¸¦ /v1ï¼‰</div>
        <div style="margin-top:8px"><input id="aiBase" placeholder="https://.../v1"></div>
      </div>
      <div class="item">
        <h4>Model</h4>
        <div class="desc">ç¤ºä¾‹ï¼šgpt-4o-mini / gpt-4.1-mini / ä½ é¢æ¿æ˜¾ç¤ºçš„æ¨¡å‹å</div>
        <div style="margin-top:8px"><input id="aiModel" placeholder="æ¨¡å‹å"></div>
      </div>
      <div class="item">
        <h4>API Key</h4>
        <div class="desc">æ ¼å¼é€šå¸¸ï¼šsk-xxxxxxxxï¼ˆä¸è¦å‘ç»™ä»»ä½•äººï¼‰</div>
        <div style="margin-top:8px"><input id="aiKey" placeholder="sk-..."></div>
      </div>
      <div class="item">
        <h4>è¶…æ—¶ / é‡è¯•</h4>
        <div class="desc">AIå¤±è´¥æ—¶ä¼šè‡ªåŠ¨é€€å›åˆ°â€œå†…ç½®å‰§æƒ…ç»­å†™â€ã€‚</div>
        <div style="margin-top:8px">
          <select id="aiTemp">
            <option value="0.6">æ¸©åº¦ 0.6ï¼ˆç¨³ï¼‰</option>
            <option value="0.9">æ¸©åº¦ 0.9ï¼ˆæ›´æ”¾é£ï¼‰</option>
            <option value="1.1">æ¸©åº¦ 1.1ï¼ˆæ›´æˆå‰§ï¼‰</option>
          </select>
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnSaveAI">ä¿å­˜è®¾ç½®</button>
      <button class="btn" id="btnTestAI">æµ‹è¯•è¿æ¥</button>
      <button class="btn" id="btnClearAI">æ¸…ç©ºè®¾ç½®</button>
    </div>
    <div class="hr"></div>
    <div class="small" id="aiStatus">çŠ¶æ€ï¼šæœªæµ‹è¯•</div>
  </div>
</div>

<!-- Custom Action Modal -->
<div class="mask" id="customMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">âœï¸ è‡ªå®šä¹‰è¡ŒåŠ¨</div>
        <div class="small">ä½ å†™ä¸€å¥è¡ŒåŠ¨ï¼Œæˆ‘ä¼šæŒ‰â€œæ€æ¡Œ/ä¸»çº¿/è°‹ç•¥/å…»æˆâ€è‡ªåŠ¨åˆ¤å®šå¹¶ç»“ç®—ã€‚</div>
      </div>
      <button class="btn" id="btnCloseCustom">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <textarea id="customText" placeholder="æ¯”å¦‚ï¼šæˆ‘å»ä¸œå®«å½“ä¼—æ­ç©¿è‹æ¸…è²çš„è´¦æœ¬ï¼Œé¡ºä¾¿é€¼å¤ªå­è¡¨æ€ã€‚"></textarea>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnDoCustom">æ‰§è¡Œ</button>
      <button class="btn" id="btnDoCustomAI">ç”¨AIæ‰©å†™å¹¶æ‰§è¡Œ</button>
    </div>
    <div class="small" style="margin-top:10px">æç¤ºï¼šå¦‚æœä½ æƒ³â€œç”œå® è·¯çº¿â€ï¼Œå¤šé€‰ã€ä¸»çº¿/ä½“é¢æ¨è¿›ã€‘å¹¶ç´¯ç§¯å¤ªå­å¥½æ„Ÿï¼›å¦‚æœâ€œæƒè°‹é»‘åŒ–â€ï¼Œå¤šé€‰ã€è¯æ®æ¨è¿›/æ€æ¡Œã€‘å¹¶å †è°‹ç•¥ä¸æ€€ç–‘å€¼ã€‚</div>
  </div>
</div>

<script>
/* ===================== ç«‹ç»˜ï¼ˆå†…ç½®SVGï¼Œä¸éœ€è¦å¤–é“¾ï¼‰ ===================== */
const Portraits = {
  heroine: [
    {name:"æŸ³æ‰¶é£ Â· å†·è‰³", svg: svgFace("#ff6aa2","#0f1220","#eaeaff","å†·") },
    {name:"æŸ³æ‰¶é£ Â· ä¹–å·§", svg: svgFace("#7cffb2","#0f1220","#eaeaff","ä¹–") },
    {name:"æŸ³æ‰¶é£ Â· é»‘åŒ–", svg: svgFace("#ff5b5b","#0f1220","#eaeaff","ç‹ ") },
  ],
  prince: [
    {name:"æ…•å®¹ç© Â· å¤ªå­", svg: svgFace("#ffd36b","#0f1220","#eaeaff","ç©") },
  ],
  su: [
    {name:"è‹æ¸…è² Â· ç™½è²", svg: svgFace("#b7b9ff","#0f1220","#eaeaff","è²") },
  ]
};
function svgFace(accent, bg, fg, mark){
return `
<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="${accent}" stop-opacity="0.95"/>
      <stop offset="1" stop-color="${accent}" stop-opacity="0.25"/>
    </linearGradient>
  </defs>
  <rect x="6" y="6" width="88" height="88" rx="18" fill="${bg}" stroke="${accent}" stroke-opacity="0.45"/>
  <circle cx="50" cy="50" r="30" fill="url(#g)" opacity="0.9"/>
  <circle cx="40" cy="46" r="4" fill="${fg}" opacity="0.9"/>
  <circle cx="60" cy="46" r="4" fill="${fg}" opacity="0.9"/>
  <path d="M38 62 C45 70, 55 70, 62 62" stroke="${fg}" stroke-width="3" fill="none" stroke-linecap="round" opacity="0.8"/>
  <text x="50" y="54" text-anchor="middle" font-size="18" fill="${fg}" opacity="0.35" font-weight="800">${mark}</text>
</svg>`;
}

/* ===================== å•†åŸ ===================== */
const Shop = [
  {id:"shield", name:"å±è”½ç¬¦", price:10, desc:"ä¸‹ä¸€æ¬¡å…ç³»ç»Ÿæƒ©ç½šï¼ˆä¸€æ¬¡æ€§ï¼‰ã€‚", apply:s=>s.buffs.noPunishOnce=true},
  {id:"actor", name:"æ¼”æŠ€å¤§å¸ˆ", price:40, desc:"è¢«åŠ¨ï¼šé™ä½æƒ©ç½šè§¦å‘æ¦‚ç‡ï¼ˆæ›´å®¹æ˜“éª—è¿‡ç³»ç»Ÿï¼‰ã€‚", apply:s=>s.buffs.actor=true},
  {id:"iron", name:"é“è¡€å¿ƒé˜²", price:30, desc:"è¢«åŠ¨ï¼šæƒ©ç½šå¯¹å¿ƒæ™º/å¥åº·çš„ä¼¤å®³-1ã€‚", apply:s=>s.buffs.iron=true},
  {id:"intel", name:"æƒ…æŠ¥çº¿äºº", price:25, desc:"ä¸€æ¬¡æ€§ï¼šä¸‹ä¸€å›åˆè°‹ç•¥+3ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰ã€‚", apply:s=>{s.buffs.nextIntelBoost=true}},
  {id:"lux", name:"ç²ç‘äººè„‰", price:35, desc:"è¢«åŠ¨ï¼šç¤¾äº¤é€‰é¡¹é¢å¤–+2å£°æœ›ã€‚", apply:s=>s.buffs.lux=true},
  {id:"med", name:"å›æ˜¥ä¸¸", price:18, desc:"ä¸€æ¬¡æ€§ï¼šå¥åº·+10ã€å¿ƒæ™º+6ã€‚", apply:s=>{s.player.å¥åº·=clamp(s.player.å¥åº·+10,0,100); s.player.å¿ƒæ™º=clamp(s.player.å¿ƒæ™º+6,0,100);}},
];

/* ===================== æˆå°±ç³»ç»Ÿ ===================== */
const Achievements = [
  {id:"firstFlip", name:"ç¬¬ä¸€æ¬¡æ€æ¡Œ", desc:"æ€æ¡Œå€¼é¦–æ¬¡è¾¾åˆ° â‰¥6", check:s=>s.player.æ€æ¡Œå€¼>=6},
  {id:"flipKing", name:"æ€æ¡Œç‹", desc:"æ€æ¡Œå€¼è¾¾åˆ° 60", check:s=>s.player.æ€æ¡Œå€¼>=60},
  {id:"calmMind", name:"å¿ƒå¦‚æ­¢æ°´", desc:"å¿ƒæ™ºè¾¾åˆ° 90", check:s=>s.player.å¿ƒæ™º>=90},
  {id:"ironBody", name:"é“äºº", desc:"å¥åº·è¾¾åˆ° 95", check:s=>s.player.å¥åº·>=95},
  {id:"plotMaster", name:"ä½“é¢æ¨è¿›", desc:"ä¸»çº¿å®Œæˆç´¯è®¡ 8 æ¬¡", check:s=>s.meta.mainDoneCount>=8},
  {id:"evidence", name:"è¯æ®é“¾", desc:"è‹æ¸…è²æ€€ç–‘ â‰¥70", check:s=>s.player["è‹æ¸…è²æ€€ç–‘"]>=70},
  {id:"princeLove", name:"å¤ªå­å¿ƒåŠ¨", desc:"å¤ªå­å¥½æ„Ÿ â‰¥70", check:s=>s.player["å¤ªå­å¥½æ„Ÿ"]>=70},
  {id:"warning", name:"ç³»ç»Ÿæ€’ç«", desc:"ç³»ç»Ÿè­¦å‘Šå€¼ â‰¥80", check:s=>s.player["ç³»ç»Ÿè­¦å‘Šå€¼"]>=80},
  {id:"reputation", name:"è´µå¥³ä¼ è¯´", desc:"è´µå¥³å£°æœ› â‰¥95", check:s=>s.player["è´µå¥³å£°æœ›"]>=95},
  {id:"strategist", name:"æƒè°‹å®¶", desc:"è°‹ç•¥ â‰¥90", check:s=>s.player.è°‹ç•¥>=90},
  {id:"survivor", name:"è‹Ÿä½å°±æ˜¯èµ¢", desc:"å¥åº·æ›¾ä½äº15ä½†ä½ æ´»åˆ°Day10", check:s=>s.meta.lowHPOnce && s.day>=10},
  {id:"ending", name:"è§è¯ç»“å±€", desc:"å®Œæˆä»»æ„ç»“å±€", check:s=>s.meta.ended===true},
];

/* ===================== å¼•æ“çŠ¶æ€ ===================== */
const State = {
  day: 1,
  phase: "CHOOSE",
  focus: "heroine",         // å½“å‰ç«‹ç»˜è§’è‰²ï¼šheroine/prince/su
  portraitIndex: 0,
  route: "UNSET",           // SWEET / DARK / BALANCE
  player: {
    é£å: 92,
    è°‹ç•¥: 78,
    å¿ƒæ™º: 74,
    å¥åº·: 88,
    æ€æ¡Œå€¼: 0,
    åç¦»åº¦: 0,
    è´µå¥³å£°æœ›: 85,
    å®¶æ—å£°æœ›: 95,
    ç³»ç»Ÿè­¦å‘Šå€¼: 0,
    "å¤ªå­å¥½æ„Ÿ": 0,
    "è‹æ¸…è²æ€€ç–‘": 0,
  },
  buffs: {
    noPunishOnce:false,
    actor:false,
    iron:false,
    nextIntelBoost:false,
    lux:false,
  },
  flags: {
    mainDone:false
  },
  meta:{
    mainDoneCount:0,
    lowHPOnce:false,
    ended:false,
  },
  achvUnlocked:{},
  log: []
};

/* ===================== Day1â€“Day20 ä¸»çº¿å‰§æƒ…åº“ï¼ˆå«åˆ†æ”¯æ–‡æœ¬ï¼‰ ===================== */
function dayIntro(day){
  const T = {
    1:`ä½ çŒ›åœ°çå¼€çœ¼ã€‚\nç»£å¸ä½å‚ï¼Œæª€é¦™å¹½å¹½ã€‚\nä½ ç©¿è¿›è™æ–‡ï¼Œæˆäº†æ³¨å®šæƒ¨æ­»çš„å¥³é…ï¼šæŸ³æ‰¶é£ã€‚\n\nã€ä¸»çº¿ä»»åŠ¡ï¼šåˆåå‰å¾€ä¸œå®«ï¼Œä¸ºå¤ªå­é€å‚æ±¤ã€‚ã€‘\nä½ æŒ‡å°–å‘ç™½ï¼š\nâ€œè¿™ä¸€ä¸–â€”â€”æˆ‘ä¸å½“æ€¨ç§ã€‚â€`,
    2:`ç¬¬äºŒæ—¥ï¼ŒåŸé‡Œé£å£°å˜å†·ã€‚\nç³»ç»Ÿæ¢äº†æ‹›ï¼šä¸å†é€¼ä½ é€æ­»ï¼Œè€Œæ˜¯é€¼ä½ â€œåƒå¥³é…â€ã€‚\nä½ æœ›å‘è¡—å··ï¼šæ¯ä¸€æ¡å··å­éƒ½è—ç€è€³æœµã€‚`,
    3:`ç¬¬ä¸‰æ—¥ï¼Œä¸œå®«å£è°•ï¼šå¤ªå­å¬è§ã€‚\nç³»ç»Ÿä½å£°æé†’ä½ â€œä¿æŒäººè®¾ä¸€è‡´â€ã€‚\nä½ å¿ƒæƒ³ï¼šæˆ‘æœ€è®¨åŒè¢«å®‰æ’ã€‚`,
    4:`ç¬¬å››æ—¥ï¼Œä¸ç›¸åºœåé™¢çš„è´¦å†Œå¼€å§‹éœ²è§’ã€‚\nä½ è‹¥æƒ³ç¿»ç›˜ï¼Œè¯æ®è¦åƒç½‘ï¼šè¶Šç»‡è¶Šå¯†ã€‚`,
    5:`ç¬¬äº”æ—¥ï¼Œè‹æ¸…è²ä¸»åŠ¨é€’å¸–ã€‚\nå­—å­—æ¸©æŸ”ï¼Œå¥å¥å¸¦åˆºã€‚\nä½ è‹¥æ¥ï¼Œå¥¹æœ‰æˆï¼›ä½ è‹¥ä¸æ¥ï¼Œå¥¹ä¹Ÿæœ‰æˆã€‚`,
    6:`ç¬¬å…­æ—¥ï¼Œå®«å®´å°†å¼€ã€‚\nè¿™æ˜¯â€œå¥³é…ç¤¾æ­»â€çš„ä¼ ç»Ÿèˆå°ã€‚\nè€Œä½ å‡†å¤‡æŠŠèˆå°æ€ç¿»ã€‚`,
    7:`ç¬¬ä¸ƒæ—¥ï¼Œå¤ªå­ç¬¬ä¸€æ¬¡åœ¨æš—å¤„ç»™ä½ é€’æ¥â€œåˆ€â€ã€‚\nä½ æ¥ä¸æ¥ï¼Ÿ\næ¥äº†ï¼Œå¯èƒ½å¹¶è‚©ï¼›ä¸æ¥ï¼Œå¯èƒ½æ›´è‡ªç”±ã€‚`,
    8:`ç¬¬å…«æ—¥ï¼Œè¯æ®é“¾åˆ°æ‰‹ä¸€åŠã€‚\nä½ éœ€è¦ä¸€ä¸ªâ€œå…¬å¼€çˆ†ç‚¹â€ã€‚\nå¦åˆ™åˆ«äººåªå½“ä½ ç–¯ã€‚`,
    9:`ç¬¬ä¹æ—¥ï¼Œè‹æ¸…è²çš„å¸®æ‰‹éœ²é¢ï¼šç¤¼éƒ¨ä¸å†…ä¾å‹¾è¿ã€‚\nä½ é—»åˆ°æƒåŠ›çš„è…¥å‘³ã€‚`,
    10:`ç¬¬åæ—¥ï¼Œç³»ç»ŸæŠ•æ”¾å¼ºæƒ©ç½šé¢„è­¦ã€‚\nä½ è¶Šä¸ä¹–ï¼Œå®ƒè¶Šç‹ ã€‚\nä½ è¶Šç‹ ï¼Œå®ƒè¶Šæ€•ã€‚`,
    11:`ç¬¬åä¸€æ—¥ï¼Œå¤ªå­å¯¹ä½ æ”¹å£ï¼šä¸å†å«â€œæŸ³å§‘å¨˜â€ï¼Œå«â€œæ‰¶é£â€ã€‚\nè¿™ä¸¤ä¸ªå­—åƒç«ï¼Œçƒ§å¾—ä½ æ‰‹å¿ƒå‘çƒ«ã€‚`,
    12:`ç¬¬åäºŒæ—¥ï¼Œä¸ç›¸åºœæœ‰äººè¦ç­å£ã€‚\nä½ è‹¥é€€ä¸€æ­¥ï¼Œå°±ä¼šè¢«æ¨ä¸‹å»ã€‚\nä½ è‹¥è¿›åŠæ­¥ï¼Œå°±è¦è¸©ç€è¡€ä¸Šæ¥ã€‚`,
    13:`ç¬¬åä¸‰æ—¥ï¼Œæœå ‚é£èµ·ï¼šå°†å†›åºœè¢«ç‰µè¿çš„ä¼ é—»å››æ•£ã€‚\nä½ è¦æŠ¤å®¶ï¼Œè¿˜æ˜¯å€ŸåŠ¿ï¼Ÿ`,
    14:`ç¬¬åå››æ—¥ï¼Œå¤ªå­æå‡ºâ€œäº¤æ˜“â€ã€‚\nä½ è¦ç”œï¼Ÿè¦æƒï¼Ÿè¿˜æ˜¯è¦ä¸¤è€…éƒ½è¦ï¼Ÿ`,
    15:`ç¬¬åäº”æ—¥ï¼Œè‹æ¸…è²å¼€å§‹åæ‰‘ï¼šå¥¹è¦æŠŠä½ é’‰æ­»åœ¨â€œå¦–å¥³â€åå£°ä¸Šã€‚\nä½ å¿…é¡»åæ‰‹ä¸€åˆ€ã€‚`,
    16:`ç¬¬åå…­æ—¥ï¼Œä½ æ‰‹æ¡è¯æ®ï¼Œä½†ç¼ºä¸€ä¸ªâ€œå®¡åˆ¤å¸­â€çš„ä½ç½®ã€‚\nä½ è¦è¿›å®«é—¨ï¼Œå¾—æ‹¿åˆ°é’¥åŒ™ã€‚`,
    17:`ç¬¬åä¸ƒæ—¥ï¼Œå®«é‡Œä¼ æ¥å¯†è¯ï¼šè¦æŸ¥ä¸ç›¸ã€‚\nä½ ç»ˆäºç«™åœ¨é£æš´ä¸­å¿ƒã€‚`,
    18:`ç¬¬åå…«æ—¥ï¼Œæœ€ç»ˆå¯¹å†³å‰å¤œã€‚\nä½ å¯ä»¥é€‰æ‹©â€œæ¸©æŸ”åœ°èµ¢â€ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©â€œæ®‹å¿åœ°èµ¢â€ã€‚`,
    19:`ç¬¬åä¹æ—¥ï¼Œæœå ‚å…¬å®¡ã€‚\nä½ ä¸€å¼€å£ï¼Œèƒ½æ•‘äººï¼Œä¹Ÿèƒ½æ€äººã€‚`,
    20:`ç¬¬äºŒåæ—¥ï¼Œç»“å±€ä¹‹é—¨æ‰“å¼€ã€‚\nç³»ç»Ÿæ²‰é»˜ã€‚\nä½ ä¹Ÿæ²‰é»˜ã€‚\nâ€”â€”å› ä¸ºä½ ç»ˆäºæ‹¥æœ‰äº†â€œå†™ä¸‹ç»“å±€â€çš„æƒåŠ›ã€‚`,
  };
  return T[day] || `ç¬¬${day}æ—¥ã€‚`;
}

function dayTitle(day){return `ç¬¬${day}æ—¥ Â· ${[
"å°†å†›åºœ","åŸä¸­æš—æµ","ä¸œå®«å›å£°","è¯æ®ç»‡ç½‘","ç™½è²é‚€å±€",
"å®«å®´èˆå°","æš—åˆ€åŒç›Ÿ","çˆ†ç‚¹æˆå½¢","ç¤¼éƒ¨é»‘çº¿","ç³»ç»ŸåŠ å‹",
"å¿ƒåŠ¨ä¸è¯•æ¢","ç­å£ä¹‹å¤œ","æŠ¤å®¶ä¸å€ŸåŠ¿","äº¤æ˜“æ¡ä»¶","åæ‰‘ä¸åæ€",
"å®«é—¨é’¥åŒ™","å¯†è¯é£æš´","å¯¹å†³å‰å¤œ","æœå ‚å…¬å®¡","ç»ˆå±€åˆ¤å®š"
][day-1]||"æ–°ç« "}`}

function mainTask(day){
  return [
"é€æ±¤å…¥ä¸œå®«ï¼ˆç¨³ä½ç³»ç»Ÿï¼‰",
"ç¨³å£ç¢‘/å–è¯æ®ï¼ˆå»ºç«‹æ£‹ç›˜ï¼‰",
"ä¸å¤ªå­æ­£é¢äº¤é”‹ï¼ˆå…³ç³»å®šè°ƒï¼‰",
"è¡¥å…¨è¯æ®é“¾ï¼ˆæŠ“ä½å°¾å·´ï¼‰",
"åº”å¯¹è‹æ¸…è²é‚€å±€ï¼ˆä¸å…¥é™·é˜±ï¼‰",
"å®«å®´äº®ç›¸ï¼ˆåå£°æˆ˜ï¼‰",
"æ‹¿åˆ°å¤ªå­çš„â€œæš—åˆ€â€è®¸å¯",
"åˆ¶é€ å…¬å¼€çˆ†ç‚¹ï¼ˆç¿»ç›˜è¯æ®ï¼‰",
"é”å®šç¤¼éƒ¨é»‘çº¿ï¼ˆå®˜åœºè¯æ®ï¼‰",
"æ‰›ä½ç³»ç»ŸåŠ å‹ï¼ˆä¸å´©ï¼‰",
"æ¨è¿›å¤ªå­å…³ç³»æˆ–åˆ’æ¸…ç•Œé™",
"é˜»æ­¢ç­å£ï¼ˆä¿äººè¯ï¼‰",
"æŠ¤å°†å†›åºœå£°æœ›ï¼ˆä¿æ ¹ï¼‰",
"æ¥å—/æ‹’ç»äº¤æ˜“ï¼ˆè·¯çº¿é€‰æ‹©ï¼‰",
"åæ€èˆ†è®ºï¼ˆé‡å¡‘å£ç¢‘ï¼‰",
"å¤ºå®«é—¨é’¥åŒ™ï¼ˆæŒæ§å®¡åˆ¤å¸­ï¼‰",
"é…åˆå¯†è¯ï¼ˆä¸Šå°é¢ï¼‰",
"æœ€ç»ˆç­¹ç ï¼ˆå®šèµ¢æ³•ï¼‰",
"å…¬å®¡ä¸€å‡»ï¼ˆå®šç”Ÿæ­»ï¼‰",
"ç»“å±€åˆ¤å®šï¼ˆå¤šç»“å±€ï¼‰"
][day-1] || "ç»§ç»­æ¨è¿›";
}

/* ç»Ÿä¸€å››ç±»è¡ŒåŠ¨ï¼ˆæ¯ä¸€å¤©éƒ½ä¼šå˜æ–‡æœ¬ + ç»†å¾®æ•°å€¼å·®ï¼‰ */
function buildOptions(day, S){
  const P = S.player;
  const warn = P["ç³»ç»Ÿè­¦å‘Šå€¼"];
  const highWarn = warn >= 70;

  // è·¯çº¿å€¾å‘
  const sweetBias = P["å¤ªå­å¥½æ„Ÿ"] - P["è‹æ¸…è²æ€€ç–‘"];
  const darkBias  = P["è‹æ¸…è²æ€€ç–‘"] + P["æ€æ¡Œå€¼"] - P["å¤ªå­å¥½æ„Ÿ"];
  if(S.route==="UNSET"){
    if(sweetBias>=25) S.route="SWEET";
    else if(darkBias>=35) S.route="DARK";
    else S.route="BALANCE";
  }

  const baseMain = {
    id:`D${day}-main`,
    tag:["ä¸»çº¿","ä½é£é™©"],
    actionKey:"MAIN",
    effect:{ "å¤ªå­å¥½æ„Ÿ": +2, "åç¦»åº¦": -1, "ç³»ç»Ÿè­¦å‘Šå€¼": -2, "è´µå¥³å£°æœ›": +1 },
    story:
`ã€ä½“é¢æ¨è¿›ã€‘\nä½ æŒ‰ä¸»çº¿è¦æ±‚å®Œæˆå…³é”®åŠ¨ä½œï¼š${mainTask(day)}ã€‚\nä½ ä¸å‘ä¸äº¢ï¼ŒæŠŠâ€œå¥³é…äººè®¾â€ç©¿å¾—æ»´æ°´ä¸æ¼ã€‚\nç³»ç»ŸçŸ­æš‚å®‰é™ã€‚\nä½ å¿ƒé‡Œå´æ›´æ¸…é†’ï¼šä½“é¢æ˜¯ä¼ªè£…ï¼Œèƒœåˆ©æ‰æ˜¯ç›®çš„ã€‚`,
    focus: (day%3===0)?"prince":"heroine"
  };

  const baseFlip = {
    id:`D${day}-flip`,
    tag:["æ€æ¡Œ","é«˜é£é™©"],
    highlight:true,
    actionKey:"FLIP",
    effect:{ "æ€æ¡Œå€¼": +6, "åç¦»åº¦": +3, "ç³»ç»Ÿè­¦å‘Šå€¼": +6, "å¿ƒæ™º": -1, "è´µå¥³å£°æœ›": -1 },
    story:
`ã€æ€æ¡Œå¼€æ€ã€‘\nä½ æŠŠè§„çŸ©å½“çº¸ã€‚\nä½ æŠŠè„¸é¢å½“ç°ã€‚\nä½ å½“ä¼—åšå‡ºâ€œåŸè‘—ä¸å…è®¸â€çš„é€‰æ‹©â€”â€”å¹¶ä¸”ç¬‘ç€ç«™åœ¨é£å£ä¸Šã€‚\nç³»ç»Ÿå°–é¸£ã€‚\nä½ å´å¬è§è‡ªå·±å¿ƒè·³ï¼šå…´å¥‹èƒœè¿‡ææƒ§ã€‚`,
    focus:"heroine"
  };

  const baseProof = {
    id:`D${day}-proof`,
    tag:["è°‹ç•¥","ä¸­é£é™©"],
    actionKey:"PROOF",
    effect:{ "è°‹ç•¥": +3, "åç¦»åº¦": +1, "è‹æ¸…è²æ€€ç–‘": +4, "è´µå¥³å£°æœ›": +1 },
    story:
`ã€è¯æ®æ¨è¿›ã€‘\nä½ ä¸æ€¥ç€åµã€‚\nä½ æŠŠæ¯ä¸€æ¬¡å‘¼å¸éƒ½ç”¨æ¥ç»‡ç½‘ï¼šçº¿ç´¢ã€è´¦å†Œã€è¯äººã€åŠ¨æœºã€‚\nè‹æ¸…è²çš„â€œæ— å¿ƒä¹‹å¤±â€å¼€å§‹å˜å¾—åƒä¸€åœºé¢„è°‹ã€‚\nä½ ç¦»â€œç¿»ç›˜â€æ›´è¿‘äº†ä¸€æ­¥ã€‚`,
    focus: (day%2===0)?"su":"heroine"
  };

  const baseRest = {
    id:`D${day}-rest`,
    tag:["å…»æˆ","ä½é£é™©"],
    actionKey:"REST",
    effect:{ "å¿ƒæ™º": +4, "å¥åº·": +4, "åç¦»åº¦": 0, "ç³»ç»Ÿè­¦å‘Šå€¼": -1 },
    story:
`ã€é—­é—¨ä¿®æ•´ã€‘\nä½ è®©è‡ªå·±å…ˆæ´»ä¸‹å»ã€‚\nä½ å–è¯ã€ç»ƒå­—ã€æŠ„å…µä¹¦ã€ç¨³ä½å‘¼å¸ã€‚\nç³»ç»Ÿå¾ˆä¸çˆ½ï¼Œä½†å®ƒä¹Ÿæ²¡æ³•è®©ä¸€ä¸ªâ€œç—…äººâ€ç«‹åˆ»å»æ­»ã€‚\nä½ æ›´ç¡¬äº†ã€‚`,
    focus:"heroine"
  };

  // æ¯æ—¥å‰§æƒ…â€œå˜åŒ–å¥â€ï¼Œè®©æ¯ä¸€å¤©è¯»èµ·æ¥ä¸é‡å¤
  const spice = [
    "",
    "è¡—å··é‡Œæœ‰äººåœ¨å¿µä½ çš„åå­—ã€‚",
    "ä¸œå®«çš„ç¯ç«åƒå®¡åˆ¤ã€‚",
    "è´¦å†Œè¾¹è§’æ²¾ç€å¢¨ä¸è¡€ã€‚",
    "ç™½è²ç¬‘é‡Œè—é’©ã€‚",
    "å®«å®´çš„æ‰‡å½±åƒåˆ€ã€‚",
    "å¤ªå­é€’åˆ€æ—¶çœ¼ç¥å¾ˆæ·¡ã€‚",
    "ä½ åªå·®ä¸€ä¸ªçˆ†ç‚¹ã€‚",
    "ç¤¼éƒ¨çš„é—¨åæ˜¯è„æ‰‹ã€‚",
    "ç³»ç»Ÿå¼€å§‹å¤±æ§åœ°ä¿®æ­£ã€‚",
    "ä»–å–Šä½ æ‰¶é£é‚£ä¸€åˆ»ï¼Œä½ å·®ç‚¹èµ°ç¥ã€‚",
    "å··å£çš„è„šæ­¥å£°æ›´è¿‘äº†ã€‚",
    "å°†å†›åºœçš„é—¨åŒ¾è¢«äººç›¯ä¸Šã€‚",
    "äº¤æ˜“åƒå»ï¼Œä¹Ÿåƒæ·é”ã€‚",
    "åæ‰‘çš„è°£è¨€åƒæ½®ã€‚",
    "å®«é—¨é’¥åŒ™å†°å†·ã€‚",
    "å¯†è¯åƒé›·ã€‚",
    "å¤œé£é‡Œå…¨æ˜¯ç­¹ç å‘³ã€‚",
    "å…¬å®¡å¸­ä¸Šæ¯ä¸ªäººéƒ½åœ¨èµŒã€‚",
    "ç»ˆå±€é‡Œï¼Œåªæœ‰ä½ èƒ½è½ç¬”ã€‚"
  ][day-1] || "";

  // å¼ºæƒ©ç½šæç¤º/å±æœºé€‰é¡¹ï¼ˆå½“è­¦å‘Šé«˜ï¼‰
  const crisis = highWarn ? [{
    id:`D${day}-crisis`,
    tag:["å±æœº","ä¸­é£é™©"],
    actionKey:"CRISIS",
    effect:{ "å¿ƒæ™º": -2, "ç³»ç»Ÿè­¦å‘Šå€¼": +2, "è°‹ç•¥": +1 },
    story:
`ã€ç³»ç»Ÿå±æœºæŠ•æ”¾ã€‘\n${spice}\nç³»ç»Ÿå¼ºè¡Œå¡æ¥ä¸€æ®µâ€œä¿®æ­£äº‹ä»¶â€ã€‚\nä½ å¿…é¡»å½“åœºå¤„ç†ï¼šè¦ä¹ˆå¿ï¼Œè¦ä¹ˆæ›´ç‹ ã€‚\nä½ å’¬ä½èˆŒå°–ï¼šæˆ‘ä¸ä¼šå›åˆ°åŸè‘—ã€‚`,
    focus:"heroine"
  }] : [];

  // ç»™å››ä¸ªåŠ¨ä½œåŠ ä¸Šå½“æ—¥ç‰¹å†™å¥
  const patch = op => ({...op, story: op.story + (spice?`\n\nï¼ˆä»Šæ—¥æš—æµï¼š${spice}ï¼‰`:"")});
  return [patch(baseMain), patch(baseFlip), patch(baseProof), patch(baseRest), ...crisis];
}

/* ===================== DOM ===================== */
const $ = id => document.getElementById(id);
const storyBox = $("story");
const subtitle = $("subtitle");
const optionBox = $("options");
const statBox = $("stats");
const systemBox = $("system");
const flash = $("flash");
const cards = [$("cardPortrait"),$("cardStory"),$("cardAction"),$("cardStats"),$("cardSystem")];

const shopMask = $("shopMask");
const shopGrid = $("shopGrid");
const shopMoney = $("shopMoney");

const achvMask = $("achvMask");
const achvList = $("achvList");

const aiMask = $("aiMask");
const aiStatus = $("aiStatus");

const customMask = $("customMask");

/* ===================== util ===================== */
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
function tip(text, kind="good"){
  const d=document.createElement("div");
  d.className=`float ${kind}`;
  d.innerText=text;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1400);
}
function typeText(text){
  storyBox.innerText="";
  let i=0;
  const timer=setInterval(()=>{
    storyBox.innerText += (text[i] ?? "");
    storyBox.scrollTop = storyBox.scrollHeight;
    i++;
    if(i>=text.length) clearInterval(timer);
  }, 9);
}
function nowBadges(){
  const P=State.player;
  const tags=[];
  if(State.route==="SWEET") tags.push("ç”œå® å€¾å‘");
  if(State.route==="DARK") tags.push("é»‘åŒ–å€¾å‘");
  if(P["ç³»ç»Ÿè­¦å‘Šå€¼"]>=70) tags.push("ç³»ç»Ÿé«˜å±");
  if(P["å¤ªå­å¥½æ„Ÿ"]>=70) tags.push("å¤ªå­å¿ƒåŠ¨");
  if(P["è‹æ¸…è²æ€€ç–‘"]>=70) tags.push("ç™½è²å°†çˆ†");
  return tags;
}

/* ===================== æ¸²æŸ“ ===================== */
function renderSubtitle(){
  subtitle.innerHTML = `ã€Œ${dayTitle(State.day)}ã€ <span class="small">ï¼ˆDay20è‡ªåŠ¨ç»“å±€ï½œä¸»çº¿æ›´ç¨³ï½œæ€æ¡Œèµšè´§å¸ï¼‰</span>`;
}
function renderPortrait(){
  const focus = State.focus;
  const list = Portraits[focus] || Portraits.heroine;
  State.portraitIndex = clamp(State.portraitIndex,0,list.length-1);
  const cur = list[State.portraitIndex];
  $("portrait").innerHTML = cur.svg;
  $("pName").innerText = cur.name || "è§’è‰²";
  $("pHint").innerText = focus==="heroine" ? "ä½ å¯ä»¥ä¹–ï¼Œä½†ä½ æ›´ä¼šèµ¢ã€‚" :
                         focus==="prince" ? "ä»–ä¸è¯´æƒ…è¯ï¼Œä½†ä»–ä¼šç»™ä½ åˆ€ã€‚" :
                         "å¥¹ç¬‘å¾—æœ€è½¯ï¼Œåˆ€ä¹Ÿæœ€ç‹ ã€‚";

  const badges = $("miniBadges");
  badges.innerHTML = "";
  nowBadges().forEach(t=>{
    const s=document.createElement("span");
    s.className="badgeMini";
    s.innerText=t;
    badges.appendChild(s);
  });
  renderAchvPreview();
}
function renderStats(){
  statBox.innerHTML="";
  const P = State.player;
  const rows = [
    ["é£å", P.é£å], ["è°‹ç•¥", P.è°‹ç•¥], ["å¿ƒæ™º", P.å¿ƒæ™º], ["å¥åº·", P.å¥åº·],
    ["æ€æ¡Œå€¼", P.æ€æ¡Œå€¼], ["åç¦»åº¦", P.åç¦»åº¦], ["è´µå¥³å£°æœ›", P.è´µå¥³å£°æœ›],
    ["å®¶æ—å£°æœ›", P.å®¶æ—å£°æœ›], ["ç³»ç»Ÿè­¦å‘Šå€¼", P.ç³»ç»Ÿè­¦å‘Šå€¼],
    ["å¤ªå­å¥½æ„Ÿ", P["å¤ªå­å¥½æ„Ÿ"]], ["è‹æ¸…è²æ€€ç–‘", P["è‹æ¸…è²æ€€ç–‘"]],
  ];
  rows.forEach(([k,v])=>{
    const pct = clamp(v,0,100);
    const el=document.createElement("div");
    el.className="stat";
    el.innerHTML = `<b>${k}</b><div class="bar"><div class="fill" style="width:${pct}%"></div></div><span class="val">${v}</span>`;
    statBox.appendChild(el);
  });
}
function renderSystem(extra=""){
  const P = State.player;
  const warn=P["ç³»ç»Ÿè­¦å‘Šå€¼"];
  let badge=`<span class="badge badge-ok">ç›‘æ§æ­£å¸¸</span>`;
  if(warn>=70) badge=`<span class="badge badge-bad">é«˜å±</span>`;
  else if(warn>=35) badge=`<span class="badge badge-warn">è­¦æƒ•</span>`;

  const done = State.flags.mainDone ? "âœ…å·²å®Œæˆ" : "âŒæœªå®Œæˆ";
  systemBox.innerHTML = `
    <div class="sysRow"><span>ğŸ“… å›åˆ</span><b>Day ${State.day} / 20</b></div>
    <div class="sysRow"><span>ğŸ¯ ä»Šæ—¥ä¸»çº¿</span><span>${done}</span></div>
    <div class="small">${mainTask(State.day)}</div>
    <div class="hr"></div>
    <div class="sysRow"><span>ğŸ‘ è­¦å‘Šç­‰çº§</span>${badge}</div>
    <div class="small">${extra || "ç³»ç»Ÿæ­£åœ¨åˆ†æä½ çš„â€œäººè®¾ä¸€è‡´æ€§â€â€¦"}</div>
  `;
}
function renderOptions(){
  optionBox.innerHTML="";
  const ops = buildOptions(State.day, State);

  ops.forEach(op=>{
    const div=document.createElement("div");
    div.className="option";
    if(op.highlight) div.classList.add("highlight");

    const tag1 = op.tag?.[0] || "è¡ŒåŠ¨";
    const tag2 = op.tag?.[1] || "æœªçŸ¥";
    const cls1 = tag1==="ä¸»çº¿" ? "tag-main" : (tag1==="æ€æ¡Œ" ? "tag-risk" : (tag1==="å±æœº" ? "tag-warn" : "tag-safe"));
    const cls2 = tag2.includes("é«˜") ? "tag-risk" : (tag2.includes("ä¸­") ? "tag-warn" : "tag-safe");

    const shortTitle = (tag1==="ä¸»çº¿") ? "ç¨³ä½å±€é¢ï¼ˆä¸»çº¿/ä½“é¢æ¨è¿›ï¼‰" :
                       (tag1==="æ€æ¡Œ") ? "æ€æ¡Œå¼€æ€ï¼ˆé«˜é£é™©é«˜æ”¶ç›Šï¼‰" :
                       (tag1==="è°‹ç•¥") ? "è¯æ®æ¨è¿›ï¼ˆè°‹ç•¥çº¿ï¼‰" :
                       (tag1==="å…»æˆ") ? "é—­é—¨ä¿®æ•´ï¼ˆå›è¡€ç¨³å¿ƒï¼‰" :
                       "å¤„ç†å±æœºï¼ˆç³»ç»ŸæŠ•æ”¾ï¼‰";

    // é¢„è§ˆæ•ˆæœ
    const eff = Object.entries(op.effect||{})
      .map(([k,v])=> `${k}${v>=0?"+":""}${v}`)
      .slice(0,5).join(" Â· ");

    div.innerHTML = `
      <span class="tag ${cls1}">${tag1}</span>
      <span class="tag ${cls2}">${tag2}</span>
      <div style="margin-top:6px;font-weight:700">${shortTitle}</div>
      <div class="small" style="margin-top:6px">${eff || ""}</div>
    `;
    div.onclick = ()=>applyAction(op);
    optionBox.appendChild(div);
  });
}
function renderShop(){
  shopMoney.innerHTML = `å½“å‰æ€æ¡Œå€¼ï¼š<b style="color:var(--accent)">${State.player.æ€æ¡Œå€¼}</b> ï½œè¢«åŠ¨å·²æ‹¥æœ‰ï¼š${
    Object.entries(State.buffs).filter(([k,v])=>v && (k==="actor"||k==="iron"||k==="lux")).map(([k])=>k).join(", ") || "æ— "
  }`;
  shopGrid.innerHTML="";
  Shop.forEach(item=>{
    const can = State.player.æ€æ¡Œå€¼ >= item.price;
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <h4>${item.name}</h4>
      <div class="meta"><span class="price">-${item.price} æ€æ¡Œå€¼</span><span>${can ? "å¯è´­ä¹°" : "ä½™é¢ä¸è¶³"}</span></div>
      <div class="desc">${item.desc}</div>
      <div class="row">
        <button class="btn" ${can ? "" : "disabled"}>è´­ä¹°å¹¶ä½¿ç”¨</button>
        <span class="small">ID: ${item.id}</span>
      </div>
    `;
    el.querySelector("button").onclick = ()=>purchase(item.id);
    shopGrid.appendChild(el);
  });
}
function renderAchvPreview(){
  const total = Achievements.length;
  const got = Object.keys(State.achvUnlocked).length;
  $("achvPreview").innerText = `æˆå°±ï¼š${got} / ${total}`;
}
function renderAchvList(){
  achvList.innerHTML="";
  Achievements.forEach(a=>{
    const got = !!State.achvUnlocked[a.id];
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <h4>${got ? "âœ… " : "â¬œ "} ${a.name}</h4>
      <div class="desc">${a.desc}</div>
      <div class="meta"><span class="badgeMini">${got ? "å·²è§£é”" : "æœªè§£é”"}</span><span class="badgeMini">ID: ${a.id}</span></div>
    `;
    achvList.appendChild(el);
  });
}

/* ===================== æ ¸å¿ƒé€»è¾‘ ===================== */
function applyDelta(delta){
  Object.entries(delta).forEach(([k,v])=>{
    if(!(k in State.player)) return;
    const before=State.player[k];
    State.player[k]=clamp(before+v,0,100);
    const sign=v>0?"+":"";
    if(v!==0) tip(`${k} ${sign}${v}`, v>0 ? "good" : "bad");
  });

  if(State.player.å¥åº·<=15) State.meta.lowHPOnce=true;
  checkAchievements();
}
function punish(level=1, reason="åç¦»ä¸»çº¿"){
  if(State.buffs.noPunishOnce){
    State.buffs.noPunishOnce=false;
    tip("å±è”½ç¬¦ç”Ÿæ•ˆï¼šå…ä¸€æ¬¡æƒ©ç½š", "warn");
    renderSystem("ã€å±è”½ç¬¦ã€‘å·²æ¶ˆè€—ï¼šç³»ç»ŸçŸ­æš‚å¤±æ˜ã€‚");
    return;
  }

  flash.classList.add("on");
  cards.forEach(c=>c.classList.add("shake"));
  setTimeout(()=>{
    flash.classList.remove("on");
    cards.forEach(c=>c.classList.remove("shake"));
  }, 520);

  // æ¼”æŠ€å¤§å¸ˆï¼šä¸€å®šæ¦‚ç‡è·³è¿‡æƒ©ç½š
  if(State.buffs.actor){
    const skip = Math.random() < 0.35;
    if(skip){
      tip("æ¼”æŠ€å¤§å¸ˆï¼šä½ éª—è¿‡ç³»ç»Ÿä¸€æ¬¡", "warn");
      return;
    }
  }

  let base = level===1 ? 3 : level===2 ? 7 : 12;
  if(State.buffs.iron) base = Math.max(1, base-1);

  const dMind = -base;
  const dHp = -Math.max(1, Math.floor(base/2));
  const dWarn = +(level===1 ? 10 : level===2 ? 20 : 33);

  applyDelta({å¿ƒæ™º:dMind, å¥åº·:dHp, "ç³»ç»Ÿè­¦å‘Šå€¼":dWarn});
  tip(`ç³»ç»Ÿæƒ©ç½šï¼š${reason}`, "bad");
}

function applyAction(op){
  if(State.phase!=="CHOOSE") return;
  State.phase="RESOLVE";
  State.flags.mainDone = (op.actionKey==="MAIN");

  // ä¸€æ¬¡æ€§buffï¼šæƒ…æŠ¥çº¿äºº
  if(State.buffs.nextIntelBoost){
    State.buffs.nextIntelBoost=false;
    applyDelta({è°‹ç•¥:+3});
    tip("æƒ…æŠ¥çº¿äººï¼šè°‹ç•¥åŠ æˆè§¦å‘", "warn");
  }

  // äººè„‰ï¼šç¤¾äº¤ï¼ˆè¿™é‡Œç”¨â€œä¸»çº¿â€å½“ç¤¾äº¤çš„ç¨³å®šæ¨è¿›ï¼‰é¢å¤–åŠ æˆ
  const extra = {};
  if(State.buffs.lux && op.actionKey==="MAIN"){
    extra["è´µå¥³å£°æœ›"] = (extra["è´µå¥³å£°æœ›"]||0) + 2;
  }

  // ç«‹ç»˜ç„¦ç‚¹
  if(op.focus) State.focus = op.focus;
  if(op.actionKey==="PROOF") State.focus="su";
  if(op.actionKey==="MAIN" && (State.day%3===0)) State.focus="prince";

  typeText(op.story);

  // åº”ç”¨æ•°å€¼
  applyDelta({...op.effect, ...extra});

  // è·¯çº¿å€¾å‘æ›´æ˜æ˜¾
  if(op.actionKey==="MAIN") State.meta.mainDoneCount++;
  if(op.actionKey==="FLIP") State.route = (State.route==="SWEET") ? "BALANCE" : (State.route==="BALANCE" ? "DARK" : State.route);
  if(op.actionKey==="PROOF" && State.player["è‹æ¸…è²æ€€ç–‘"]>55) State.route = (State.route==="SWEET") ? "BALANCE" : State.route;

  // ä¸»çº¿æœªå®Œæˆ => æƒ©ç½šï¼ˆè­¦å‘Šè¶Šé«˜è¶Šç‹ ï¼‰
  if(!State.flags.mainDone){
    const warn = State.player["ç³»ç»Ÿè­¦å‘Šå€¼"];
    const lvl = warn>=85 ? 3 : (warn>=70 ? 2 : 1);
    punish(lvl, "æœªå®Œæˆä¸»çº¿/åç¦»ä¿®æ­£");
  }else{
    // å®Œæˆä¸»çº¿ï¼šç•¥å¾®é™ä½è­¦å‘Š
    applyDelta({"ç³»ç»Ÿè­¦å‘Šå€¼": -2});
  }

  // å¥åº·è¿‡ä½ï¼šå¼ºåˆ¶ä¼‘å…»ï¼ˆä»ç®—å®Œæˆå½“å¤©ç»“ç®—ï¼‰
  if(State.player.å¥åº·<=15){
    tip("ä½ ç—…å€’äº†ï¼šå¼ºåˆ¶ä¼‘å…»ï¼ˆä¸‹ä¸€å¤©å‰ï¼‰", "bad");
    applyDelta({å¥åº·:+6, å¿ƒæ™º:+4, "ç³»ç»Ÿè­¦å‘Šå€¼": -1});
  }

  renderStats();
  renderSystem("ç»“ç®—å®Œæˆã€‚ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ã€‚");
  renderPortrait();

  // é”ä½æœ¬å›åˆå†æ¬¡é€‰æ‹©
  setButtonsEnabled(false);
  $("btnEnd").disabled = false;
}

function setButtonsEnabled(enabled){
  // åªå½±å“è¡ŒåŠ¨åŒºåŸŸæŒ‰é’®ï¼ˆé¿å…å­˜æ¡£ç­‰è¢«ç¦ç”¨ï¼‰
  const btns = [$("btnCustom"), $("btnAI"), $("btnShop"), $("btnEnd")];
  btns.forEach(b=>{ if(b) b.disabled = !enabled; });
}

function nextDay(){
  if(State.phase!=="RESOLVE"){
    tip("å…ˆé€‰ä¸€ä¸ªè¡ŒåŠ¨å†ç»“æŸå›åˆ", "warn");
    return;
  }
  State.day++;
  State.phase="CHOOSE";
  State.flags.mainDone=false;

  if(State.day>20){
    showEnding();
    return;
  }

  typeText(dayIntro(State.day));
  renderAll("è¿›å…¥ä¸‹ä¸€å¤©ã€‚");
  setButtonsEnabled(true);
}
function skipToEnding(){
  State.day = 20;
  State.phase = "CHOOSE";
  State.flags.mainDone=false;
  typeText(dayIntro(State.day));
  renderAll("å·²è·³è½¬åˆ° Day20ã€‚");
  setButtonsEnabled(true);
}

function checkAchievements(){
  let unlockedNow = [];
  Achievements.forEach(a=>{
    if(State.achvUnlocked[a.id]) return;
    try{
      if(a.check(State)){
        State.achvUnlocked[a.id]=true;
        unlockedNow.push(a.name);
      }
    }catch(e){}
  });
  if(unlockedNow.length){
    tip("æˆå°±è§£é”ï¼š " + unlockedNow.join("ã€"), "good");
  }
  renderAchvPreview();
}

function showEnding(){
  // ç»“å±€åˆ¤å®šï¼šç”œå®  / æƒè°‹é»‘åŒ– / å¹³è¡¡ / BE / HE
  const P=State.player;

  // å…³é”®é˜ˆå€¼
  const love = P["å¤ªå­å¥½æ„Ÿ"];
  const proof = P["è‹æ¸…è²æ€€ç–‘"];
  const power = P.è°‹ç•¥ + P["å®¶æ—å£°æœ›"];
  const flip = P["æ€æ¡Œå€¼"];
  const warn = P["ç³»ç»Ÿè­¦å‘Šå€¼"];
  const hp = P.å¥åº·;

  let ending = {name:"æœªçŸ¥ç»“å±€", text:"", kind:"warn", focus:"heroine"};

  // BEï¼ˆé«˜è­¦å‘Š/ä½å¥åº·ï¼‰
  if(hp<=12 || warn>=92){
    ending = {
      name:"Bad Endï¼šç³»ç»Ÿä¿®æ­£",
      kind:"bad",
      focus:"heroine",
      text:
`ã€Bad Endï¼šç³»ç»Ÿä¿®æ­£ã€‘\nç³»ç»Ÿç»ˆäºæŠ“ä½ä½ ã€‚\nå®ƒæŠŠä½ æŒ‰å›åŸè‘—ï¼šç—…å€’ã€å¤±åŠ¿ã€è¢«æ¨åˆ°é£å£ã€‚\nä½ æ˜ç™½ï¼šä¸æ˜¯ä½ ä¸å¤Ÿç‹ ï¼Œè€Œæ˜¯ä½ ç‹ å¾—è¿˜ä¸å¤Ÿæ—©ã€‚\n\nï¼ˆæç¤ºï¼šæ›´ç¨³åœ°å®Œæˆä¸»çº¿ã€åŒæ—¶æ¨è¿›è¯æ®é“¾ï¼›æˆ–æ—©æ—©æ”’æ€æ¡Œå€¼å»å•†åŸä¹°â€œæ¼”æŠ€/å¿ƒé˜²â€ã€‚ï¼‰`
    };
  }else if(love>=75 && proof>=60 && power>=160){
    ending = {
      name:"True Endï¼šå¹¶è‚©æŒå±€ï¼ˆç”œå® +æƒè°‹ï¼‰",
      kind:"good",
      focus:"prince",
      text:
`ã€True Endï¼šå¹¶è‚©æŒå±€ã€‘\næœå ‚å…¬å®¡é‚£æ—¥ï¼Œä½ æŠŠè¯æ®ä¸€æ¡æ¡æ‘Šå¼€ã€‚\nè‹æ¸…è²çš„â€œæ— å¿ƒä¹‹å¤±â€è¢«é’‰æˆé“æ¡ˆã€‚\nå¤ªå­åœ¨ä½ èº«ä¾§ï¼Œå£°éŸ³å¾ˆæ·¡ï¼Œå´å¥å¥æŠ¤ä½ ï¼š\nâ€œå¥¹ä¸æ˜¯æ£‹å­ã€‚â€\n\nå¤œé‡Œï¼Œä»–æŠŠä½ çš„æŒ‡å°–æ¡è¿›æŒå¿ƒï¼š\nâ€œæ‰¶é£ï¼Œå­¤è¦çš„æ˜¯ä½ â€”â€”ä¸æ˜¯ä½ çš„ä¹–ã€‚â€\nä½ ç¬‘ï¼š\nâ€œæ®¿ä¸‹ï¼Œæˆ‘è¦çš„æ˜¯å¤©ä¸‹â€”â€”é¡ºä¾¿è¦ä½ ã€‚â€`
    };
  }else if(love>=75 && proof<55){
    ending = {
      name:"Sweet Endï¼šå¤ªå­ç‹¬å® ",
      kind:"good",
      focus:"prince",
      text:
`ã€Sweet Endï¼šå¤ªå­ç‹¬å® ã€‘\nä½ æ²¡æŠŠè‹æ¸…è²é€¼åˆ°æ­»å±€ã€‚\nä½ é€‰æ‹©ä½“é¢åœ°èµ¢ã€æ¸©æŸ”åœ°èµ°ã€‚\nå¤ªå­ä¸ºä½ æŒ¡ä¸‹æ‰€æœ‰æµè¨€ï¼ŒæŠŠä½ æŠ¤è¿›ä¸œå®«æœ€æ·±å¤„ã€‚\n\nä»–ä½å£°è¯´ï¼š\nâ€œä»ä»Šå¾€åï¼Œä½ ä¸å¿…æ€æ¡Œã€‚\nä½ æƒ³æ€â€”â€”æˆ‘æ›¿ä½ æ€ã€‚â€`
    };
  }else if(proof>=75 && (flip>=40 || power>=170)){
    ending = {
      name:"Dark Endï¼šæƒè°‹é»‘åŒ–ä¸Šä½",
      kind:"warn",
      focus:"heroine",
      text:
`ã€Dark Endï¼šæƒè°‹é»‘åŒ–ã€‘\nä½ æŠŠè¯æ®å½“åˆ€ï¼ŒæŠŠåå£°å½“ç›”ã€‚\nè‹æ¸…è²å€’ä¸‹é‚£ä¸€åˆ»ï¼ŒåŸé‡Œæ‰€æœ‰äººéƒ½å™¤å£°ã€‚\nä½ ç«™åœ¨é«˜å¤„ï¼Œå‘ç°è‡ªå·±å·²ç»ä¸å†éœ€è¦â€œè¢«çˆ±â€ã€‚\n\nå¤ªå­çœ‹ä½ å¾ˆä¹…ï¼š\nâ€œä½ å˜äº†ã€‚â€\nä½ ç¬‘ï¼š\nâ€œæ®¿ä¸‹ï¼Œæ˜¯æˆ‘ç»ˆäºåƒâ€˜èµ¢å®¶â€™äº†ã€‚â€`
    };
  }else if(power>=170){
    ending = {
      name:"Balance Endï¼šå°†å†›åºœå¥³ä¸»äºº",
      kind:"good",
      focus:"heroine",
      text:
`ã€Balance Endï¼šå°†å†›åºœå¥³ä¸»äººã€‘\nä½ æ²¡æœ‰æŠŠè‡ªå·±æŠ¼åœ¨ä»»ä½•äººèº«ä¸Šã€‚\nä½ æŠ¤ä½å°†å†›åºœï¼Œæ”¶æ‹¢äººè„‰ï¼Œç¨³ä½æœå±€ã€‚\nä½ æˆäº†â€œæ‰€æœ‰äººéƒ½ä¸æ•¢è½»è§†â€çš„é‚£ä¸ªäººã€‚\n\nçˆ±æƒ…ï¼Ÿ\nä½ ä¹Ÿå¯ä»¥è¦ã€‚\nä½†ä½ æ›´æ¸…æ¥šï¼šä½ å…ˆè¦è‡ªå·±ã€‚`
    };
  }else{
    ending = {
      name:"Normal Endï¼šæ”¹å†™å‘½è¿ï¼Œä»éœ€åŠªåŠ›",
      kind:"warn",
      focus:"heroine",
      text:
`ã€Normal Endã€‘\nä½ æ´»è¿‡äº†åŸè‘—ã€‚\nä½ èº²å¼€äº†æœ€ç‹ çš„åˆ€ã€‚\nä½†ä½ ä¹ŸçŸ¥é“ï¼šä½ è¿˜æ²¡æŠŠæƒåŠ›æ¡åœ¨æ‰‹é‡Œã€‚\n\nï¼ˆæç¤ºï¼šæé«˜è°‹ç•¥ã€ç´¯ç§¯æ€€ç–‘å€¼æˆ–å¤ªå­å¥½æ„Ÿï¼ŒDay1â€“Day20å¤šåšâ€œè¯æ®æ¨è¿›/ä½“é¢æ¨è¿›â€ã€‚ï¼‰`
    };
  }

  State.meta.ended=true;
  checkAchievements();

  State.focus = ending.focus;
  typeText(ending.text);
  renderPortrait();
  renderSystem(`ç»“å±€ï¼š${ending.name}`);
  $("options").innerHTML = `<div class="small">âœ… ç»“å±€å·²åˆ¤å®šï¼š<b>${ending.name}</b><br>ä½ å¯ä»¥ã€è¯»æ¡£ã€‘æˆ–ã€æ¸…æ¡£é‡å¼€ã€‘å°è¯•ä¸åŒè·¯çº¿ã€‚</div>`;
  $("btnEnd").disabled = true;
  $("btnCustom").disabled = true;
  $("btnAI").disabled = true;
}

/* ===================== å•†åŸè´­ä¹° ===================== */
function purchase(id){
  const item = Shop.find(x=>x.id===id);
  if(!item) return;
  if(State.player.æ€æ¡Œå€¼ < item.price){
    tip("æ€æ¡Œå€¼ä¸è¶³", "bad"); return;
  }
  State.player.æ€æ¡Œå€¼ = clamp(State.player.æ€æ¡Œå€¼ - item.price, 0, 100);
  item.apply(State);
  tip(`è´­ä¹°æˆåŠŸï¼š${item.name}`, "good");
  renderShop(); renderStats(); renderSystem("å•†åŸè´­ä¹°å·²ç”Ÿæ•ˆã€‚");
}

/* ===================== å­˜æ¡£ç³»ç»Ÿ ===================== */
const SAVE_KEY = "flipTable_save_v1";
function saveGame(){
  try{
    localStorage.setItem(SAVE_KEY, JSON.stringify(State));
    tip("å·²å­˜æ¡£ âœ…", "good");
  }catch(e){
    tip("å­˜æ¡£å¤±è´¥ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰", "bad");
  }
}
function loadGame(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw){ tip("æ²¡æœ‰å­˜æ¡£", "warn"); return; }
    const obj = JSON.parse(raw);
    // æµ…åˆå¹¶ä¿åº•ï¼ˆé¿å…æ—§ç‰ˆæœ¬ç¼ºå­—æ®µï¼‰
    Object.assign(State, obj);
    State.player = Object.assign({
      é£å:92,è°‹ç•¥:78,å¿ƒæ™º:74,å¥åº·:88,æ€æ¡Œå€¼:0,åç¦»åº¦:0,è´µå¥³å£°æœ›:85,å®¶æ—å£°æœ›:95,"ç³»ç»Ÿè­¦å‘Šå€¼":0,"å¤ªå­å¥½æ„Ÿ":0,"è‹æ¸…è²æ€€ç–‘":0
    }, obj.player||{});
    State.buffs = Object.assign({noPunishOnce:false,actor:false,iron:false,nextIntelBoost:false,lux:false}, obj.buffs||{});
    State.flags = Object.assign({mainDone:false}, obj.flags||{});
    State.meta = Object.assign({mainDoneCount:0,lowHPOnce:false,ended:false}, obj.meta||{});
    State.achvUnlocked = obj.achvUnlocked || {};
    tip("è¯»æ¡£æˆåŠŸ âœ…", "good");
    // é‡æ–°æ¸²æŸ“
    typeText(dayIntro(State.day));
    renderAll("å·²è¯»æ¡£ã€‚");
    setButtonsEnabled(State.phase==="CHOOSE");
  }catch(e){
    tip("è¯»æ¡£å¤±è´¥", "bad");
  }
}
function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}

/* ===================== AI ç»­å†™ï¼ˆå¯é€‰ï¼‰ ===================== */
const AI_KEY = "flipTable_ai_v1";
function getAIConf(){
  try{
    return JSON.parse(localStorage.getItem(AI_KEY) || "{}");
  }catch(e){ return {}; }
}
function setAIConf(conf){
  localStorage.setItem(AI_KEY, JSON.stringify(conf));
}
function openAISettings(){
  const c=getAIConf();
  $("aiBase").value = c.base || "";
  $("aiModel").value = c.model || "";
  $("aiKey").value = c.key || "";
  $("aiTemp").value = String(c.temp ?? "0.9");
  aiStatus.innerText = "çŠ¶æ€ï¼šæœªæµ‹è¯•";
  aiMask.classList.add("show");
}
function closeAISettings(){ aiMask.classList.remove("show"); }

async function aiChat(prompt){
  const c=getAIConf();
  if(!c.base || !c.model || !c.key) throw new Error("AIæœªé…ç½®å®Œæ•´");
  const url = c.base.replace(/\/+$/,"") + "/chat/completions";
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), 15000);

  const body = {
    model: c.model,
    temperature: Number(c.temp ?? 0.9),
    messages: [
      {role:"system", content:"ä½ æ˜¯ä¸­æ–‡äº’åŠ¨å°è¯´å†™æ‰‹ã€‚é£æ ¼ï¼šå¿«èŠ‚å¥ã€æˆå‰§å¼ åŠ›ã€ç”œå® /æƒè°‹å¯åˆ‡æ¢ã€‚ä¸è¦è¾“å‡ºä»£ç ï¼Œåªè¾“å‡ºå‰§æƒ…æ–‡æœ¬ã€‚"},
      {role:"user", content: prompt}
    ]
  };

  const res = await fetch(url, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + c.key
    },
    body: JSON.stringify(body),
    signal: controller.signal
  }).finally(()=>clearTimeout(t));

  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error("HTTP "+res.status+" "+txt.slice(0,120));
  }
  const data = await res.json();
  const out = data?.choices?.[0]?.message?.content;
  if(!out) throw new Error("æ— è¾“å‡º");
  return out.trim();
}

function localFallbackContinuation(){
  // æ— AIæ—¶çš„å†…ç½®ç»­å†™ï¼šæ ¹æ®è·¯çº¿ç”Ÿæˆä¸€å°æ®µ + ä¸‹ä¸€æ­¥æç¤º
  const P=State.player;
  const route = State.route;
  const mood = route==="SWEET" ? "ç”œ" : (route==="DARK" ? "ç‹ " : "ç¨³");
  const hint = route==="SWEET" ? "å»ºè®®å¤šåšã€ä¸»çº¿ã€‘å †å¤ªå­å¥½æ„Ÿ" :
               route==="DARK" ? "å»ºè®®å¤šåšã€è¯æ®/æ€æ¡Œã€‘å †æ€€ç–‘ä¸è°‹ç•¥" :
               "å»ºè®®ä¸»çº¿ä¸è¯æ®äº¤æ›¿æ¨è¿›";
  return `ã€å†…ç½®ç»­å†™ã€‘\nä½ åœ¨å¿ƒé‡ŒæŠŠä»Šæ—¥çš„åˆ€å£åˆç£¨äº†ä¸€éã€‚\n${mood === "ç”œ" ? "å¤ªå­çš„ç›®å…‰è½åœ¨ä½ èº«ä¸Šï¼Œåƒæ— å£°çš„åçˆ±ã€‚" : (mood==="ç‹ " ? "ä½ ç¬‘å¾—æ›´è½»ï¼Œå¿ƒå´æ›´å†·ã€‚" : "ä½ æŠŠæƒ…ç»ªå‹ä½ï¼ŒæŠŠæ£‹ç›˜é“ºå¼€ã€‚")}\n\nä¸‹ä¸€æ­¥ï¼šDay${State.day}ä¸»çº¿ã€Œ${mainTask(State.day)}ã€ã€‚\nï¼ˆ${hint}ï¼‰`;
}

/* AIç»­å†™æŒ‰é’®ï¼šåªæ‰©å†™â€œå½“å‰å±€åŠ¿æ€»ç»“â€ï¼Œä¸æ”¹å˜ç³»ç»Ÿç»“æ„ */
async function doAIContinue(){
  $("btnAI").disabled = true;
  tip("AIç»­å†™ä¸­â€¦", "warn");

  const P = State.player;
  const prompt =
`å½“å‰æ˜¯ Day${State.day}/20ï¼Œæ ‡é¢˜ï¼š${dayTitle(State.day)}ã€‚
ä¸»çº¿ä»»åŠ¡ï¼š${mainTask(State.day)}ã€‚
æ•°å€¼ï¼šå¤ªå­å¥½æ„Ÿ=${P["å¤ªå­å¥½æ„Ÿ"]}ï¼Œè‹æ¸…è²æ€€ç–‘=${P["è‹æ¸…è²æ€€ç–‘"]}ï¼Œè°‹ç•¥=${P.è°‹ç•¥}ï¼Œæ€æ¡Œå€¼=${P["æ€æ¡Œå€¼"]}ï¼Œç³»ç»Ÿè­¦å‘Šå€¼=${P["ç³»ç»Ÿè­¦å‘Šå€¼"]}ï¼Œå¥åº·=${P.å¥åº·}ï¼Œå¿ƒæ™º=${P.å¿ƒæ™º}ã€‚
è·¯çº¿å€¾å‘ï¼š${State.route}ã€‚
è¯·å†™ä¸€æ®µ200-350å­—çš„â€œå‰§æƒ…ç»­å†™â€ï¼Œè¦è¡”æ¥å½“å‰å±€åŠ¿ï¼Œç»“å°¾ç»™å‡ºä¸€å¥å¯æ‰§è¡Œçš„ä¸‹ä¸€æ­¥å»ºè®®ï¼ˆä¸è¦å†™åˆ—è¡¨ï¼‰ã€‚`;

  try{
    const txt = await aiChat(prompt);
    typeText(txt);
    renderSystem("AIç»­å†™æˆåŠŸã€‚");
  }catch(e){
    const fb = localFallbackContinuation();
    typeText(fb);
    renderSystem("AIè¯·æ±‚å¼‚å¸¸ï¼šå·²ä½¿ç”¨å†…ç½®ç»­å†™ã€‚");
    tip("AIè¯·æ±‚å¼‚å¸¸ï¼ˆå·²é™çº§ï¼‰", "bad");
  }finally{
    $("btnAI").disabled = false;
  }
}

/* è‡ªå®šä¹‰è¡ŒåŠ¨ï¼šç®€å•æ„å›¾è¯†åˆ« + å¯é€‰AIæ‰©å†™ */
function classifyCustom(text){
  const t = text.trim();
  const hasPrince = /å¤ªå­|ä¸œå®«|æ®¿ä¸‹|æ…•å®¹/.test(t);
  const hasProof  = /è¯æ®|è´¦æœ¬|è´¦å†Œ|çº¿ç´¢|å†…ä¾|ç¤¼éƒ¨|ä¸ç›¸|è‹æ¸…è²/.test(t);
  const hasFlip   = /æ€æ¡Œ|å½“ä¼—|æ’•|æ‰“è„¸|ç¿»|ç ¸|ç¾è¾±|é€¼è¿«|å¨èƒ/.test(t);
  const hasRest   = /ä¼‘æ¯|å…»|ä¿®æ•´|å–è¯|ç¡|é—­é—¨|è°ƒå…»/.test(t);

  if(hasRest) return "REST";
  if(hasFlip) return "FLIP";
  if(hasProof) return "PROOF";
  if(hasPrince) return "MAIN";
  return "BALANCE";
}
function customEffect(kind){
  if(kind==="MAIN") return {"å¤ªå­å¥½æ„Ÿ":+3,"è´µå¥³å£°æœ›":+1,"ç³»ç»Ÿè­¦å‘Šå€¼":-2,"åç¦»åº¦":-1};
  if(kind==="PROOF") return {"è°‹ç•¥":+3,"è‹æ¸…è²æ€€ç–‘":+5,"åç¦»åº¦":+1};
  if(kind==="FLIP") return {"æ€æ¡Œå€¼":+7,"ç³»ç»Ÿè­¦å‘Šå€¼":+7,"åç¦»åº¦":+3,"å¿ƒæ™º":-1,"è´µå¥³å£°æœ›":-1};
  if(kind==="REST") return {"å¥åº·":+5,"å¿ƒæ™º":+4,"ç³»ç»Ÿè­¦å‘Šå€¼":-1};
  return {"è°‹ç•¥":+1,"è´µå¥³å£°æœ›":+1,"åç¦»åº¦":0};
}
function customStory(text, kind){
  const head = kind==="MAIN" ? "ã€è‡ªå®šä¹‰Â·ä½“é¢æ¨è¿›ã€‘" :
               kind==="PROOF" ? "ã€è‡ªå®šä¹‰Â·è¯æ®æ¨è¿›ã€‘" :
               kind==="FLIP" ? "ã€è‡ªå®šä¹‰Â·æ€æ¡Œå¼€æ€ã€‘" :
               kind==="REST" ? "ã€è‡ªå®šä¹‰Â·é—­é—¨ä¿®æ•´ã€‘" :
               "ã€è‡ªå®šä¹‰Â·è¡ŒåŠ¨ã€‘";
  return `${head}\nä½ é€‰æ‹©ï¼š${text}\n\nç³»ç»Ÿè®°å½•ä½ çš„é€‰æ‹©ï¼Œå¹¶åœ¨æš—å¤„é‡æ–°è®¡ç®—â€œå‘½è¿ä¿®æ­£â€ã€‚`;
}

async function doCustom(useAI=false){
  const text = $("customText").value.trim();
  if(!text){ tip("å…ˆå†™ä¸€å¥è¡ŒåŠ¨", "warn"); return; }

  let story = "";
  let kind = classifyCustom(text);

  if(useAI){
    try{
      const P=State.player;
      const prompt =
`ä½ åœ¨å†™ä¸­æ–‡äº’åŠ¨å°è¯´ã€‚è¯·æŠŠç©å®¶çš„è¡ŒåŠ¨æ‰©å†™æˆ150-220å­—å‰§æƒ…æ®µè½ï¼ˆä¸è¦å†™ä»£ç ã€ä¸è¦åˆ—è¡¨ï¼‰ï¼Œé£æ ¼ï¼šæˆå‰§å¼ åŠ›+å¥³é…æ€æ¡Œçˆ½æ„Ÿï¼›å¯ä»¥ç”œå® æˆ–æƒè°‹ä½†è¦è´´åˆæ•°å€¼ã€‚
ç©å®¶è¡ŒåŠ¨ï¼š${text}
å½“å‰Dayï¼š${State.day}
æ•°å€¼ï¼šå¤ªå­å¥½æ„Ÿ=${P["å¤ªå­å¥½æ„Ÿ"]}ï¼Œè‹æ¸…è²æ€€ç–‘=${P["è‹æ¸…è²æ€€ç–‘"]}ï¼Œè°‹ç•¥=${P.è°‹ç•¥}ï¼Œæ€æ¡Œå€¼=${P["æ€æ¡Œå€¼"]}ï¼Œç³»ç»Ÿè­¦å‘Šå€¼=${P["ç³»ç»Ÿè­¦å‘Šå€¼"]}ã€‚
è¾“å‡ºï¼šåªè¾“å‡ºå‰§æƒ…æ–‡æœ¬ã€‚`;
      story = await aiChat(prompt);
    }catch(e){
      story = customStory(text, kind) + "\nï¼ˆAIè¯·æ±‚å¼‚å¸¸ï¼šå·²ç”¨ç®€ç‰ˆæ–‡æœ¬ã€‚ï¼‰";
      tip("AIè¯·æ±‚å¼‚å¸¸ï¼ˆå·²é™çº§ï¼‰", "bad");
    }
  }else{
    story = customStory(text, kind);
  }

  // æ‰§è¡Œä¸€ä¸ªâ€œä¸´æ—¶è¡ŒåŠ¨â€
  const op = {
    id:"CUSTOM",
    tag:[ kind==="MAIN"?"ä¸»çº¿":(kind==="PROOF"?"è°‹ç•¥":(kind==="FLIP"?"æ€æ¡Œ":"å…»æˆ")),
          kind==="FLIP"?"é«˜é£é™©":(kind==="PROOF"?"ä¸­é£é™©":"ä½é£é™©") ],
    highlight: kind==="FLIP",
    actionKey: kind==="MAIN"?"MAIN":(kind==="PROOF"?"PROOF":(kind==="FLIP"?"FLIP":"REST")),
    effect: customEffect(kind),
    story: story,
    focus: kind==="PROOF"?"su":(kind==="MAIN"?"prince":"heroine")
  };
  customMask.classList.remove("show");
  $("customText").value="";
  applyAction(op);
}

/* ===================== ç»Ÿä¸€æ¸²æŸ“å…¥å£ ===================== */
function renderAll(extra=""){
  renderSubtitle();
  renderOptions();
  renderStats();
  renderSystem(extra);
  renderPortrait();
}

/* ===================== äº‹ä»¶ç»‘å®š ===================== */
$("btnEnd").onclick = nextDay;
$("btnSkip").onclick = skipToEnding;

$("btnShop").onclick = ()=>{ renderShop(); shopMask.classList.add("show"); };
$("btnCloseShop").onclick = ()=> shopMask.classList.remove("show");
shopMask.addEventListener("click", e=>{ if(e.target===shopMask) shopMask.classList.remove("show"); });

$("btnSave").onclick = saveGame;
$("btnLoad").onclick = loadGame;
$("btnReset").onclick = resetGame;

$("btnAchv").onclick = ()=>{ renderAchvList(); achvMask.classList.add("show"); };
$("btnCloseAchv").onclick = ()=> achvMask.classList.remove("show");
achvMask.addEventListener("click", e=>{ if(e.target===achvMask) achvMask.classList.remove("show"); });

$("btnAIKey").onclick = openAISettings;
$("btnCloseAI").onclick = closeAISettings;
aiMask.addEventListener("click", e=>{ if(e.target===aiMask) closeAISettings(); });

$("btnSaveAI").onclick = ()=>{
  const conf = {
    base: $("aiBase").value.trim(),
    model: $("aiModel").value.trim(),
    key: $("aiKey").value.trim(),
    temp: Number($("aiTemp").value)
  };
  setAIConf(conf);
  aiStatus.innerText = "çŠ¶æ€ï¼šå·²ä¿å­˜ï¼ˆå»ºè®®ç‚¹æµ‹è¯•ï¼‰";
  tip("AIè®¾ç½®å·²ä¿å­˜", "good");
};
$("btnClearAI").onclick = ()=>{
  localStorage.removeItem(AI_KEY);
  aiStatus.innerText = "çŠ¶æ€ï¼šå·²æ¸…ç©º";
  tip("å·²æ¸…ç©ºAIè®¾ç½®", "warn");
};
$("btnTestAI").onclick = async ()=>{
  aiStatus.innerText = "çŠ¶æ€ï¼šæµ‹è¯•ä¸­â€¦";
  try{
    const txt = await aiChat("å›å¤â€œOKâ€ã€‚");
    aiStatus.innerText = "çŠ¶æ€ï¼šâœ… è¿æ¥æˆåŠŸï¼š" + (txt.slice(0,30) || "OK");
    tip("AIæµ‹è¯•æˆåŠŸ", "good");
  }catch(e){
    aiStatus.innerText = "çŠ¶æ€ï¼šâŒ å¤±è´¥ï¼š" + String(e.message||e).slice(0,120);
    tip("AIæµ‹è¯•å¤±è´¥", "bad");
  }
};

$("btnAI").onclick = doAIContinue;

$("btnCustom").onclick = ()=> customMask.classList.add("show");
$("btnCloseCustom").onclick = ()=> customMask.classList.remove("show");
customMask.addEventListener("click", e=>{ if(e.target===customMask) customMask.classList.remove("show"); });
$("btnDoCustom").onclick = ()=> doCustom(false);
$("btnDoCustomAI").onclick = ()=> doCustom(true);

$("btnPortrait").onclick = ()=>{
  const focus = State.focus;
  const list = Portraits[focus] || Portraits.heroine;
  State.portraitIndex = (State.portraitIndex + 1) % list.length;
  renderPortrait();
};

/* ===================== åˆå§‹åŒ– ===================== */
function init(){
  // å¦‚æœæœ‰å­˜æ¡£ï¼Œè‡ªåŠ¨è½½å…¥æ›´æ–¹ä¾¿ï¼ˆä½ ä¹Ÿå¯ä»¥æ³¨é‡Šæ‰ï¼‰
  // loadGame();

  typeText(dayIntro(State.day));
  State.focus = "heroine";
  renderAll("é€‰æ‹©è¡ŒåŠ¨å¼€å§‹ Day1ã€‚");
  setButtonsEnabled(true);
  $("btnEnd").disabled = true; // å¿…é¡»å…ˆé€‰è¡ŒåŠ¨æ‰èƒ½ç»“æŸå›åˆ
}
init();
</script>

<!--
âœ… GitHub Pages å¿…é¡»æŠŠæœ¬æ–‡ä»¶å‘½åä¸ºï¼šindex.htmlï¼ˆå…¨å°å†™ï¼‰å¹¶æ”¾åœ¨ä»“åº“æ ¹ç›®å½•
âœ… ä½ ç°åœ¨æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼ˆindex å’Œ index.htmlï¼‰ä¼šå¯¼è‡´æ··ä¹±ï¼šå»ºè®®åªç•™ index.html
âœ… Pages è®¾ç½®ï¼šSettings â†’ Pages â†’ Deploy from a branch â†’ main / (root) â†’ Save
-->
</body>
</html>
