<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ€¨ç§å¥³é…æ€æ¡Œå½• Â· Day1â€“Day20 ç»ˆæå®Œæ•´ç‰ˆ</title>
<style>
:root{
  --bg:#0f1220;
  --card:#1b1f3a;
  --card2:#14182e;
  --text:#eaeaff;
  --muted:#b7b9ff;
  --border:#3b3f7a;
  --accent:#ff6aa2;
  --good:#7cffb2;
  --warn:#ffd36b;
  --bad:#ff5b5b;
  --glow:#ff6aa288;
  --shadow:0 0 12px #0007;
  --r:14px;
}
*{box-sizing:border-box}
body{
  margin:0;
  color:var(--text);
  font-family:"PingFang SC","Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background: radial-gradient(1200px 800px at 20% 0%, #1a1f44 0%, var(--bg) 55%, #0b0d18 100%);
}
.container{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  padding:12px;
}
.card{
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:14px;
  box-shadow:var(--shadow);
  position:relative;
  overflow:hidden;
}
h3{margin:0 0 10px; color:var(--accent); font-size:16px; letter-spacing:.4px;}
.small{font-size:12px;color:var(--muted);line-height:1.55}
.hr{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:10px 0;}
@media(max-width:820px){.container{grid-template-columns:1fr;}}

/* story */
#story{height:290px;overflow:auto;line-height:1.78;font-size:14px;padding-right:6px;white-space:pre-wrap;}
#story::-webkit-scrollbar{width:8px}
#story::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

/* options */
.option{
  background:#242a62;
  border:1px solid #2f3578;
  padding:10px;
  margin:8px 0;
  border-radius:10px;
  cursor:pointer;
  transition:.15s;
  user-select:none;
}
.option:hover{transform:translateY(-1px); border-color:var(--accent); box-shadow:0 0 10px var(--glow);}
.option.highlight{border-color:var(--accent); box-shadow:0 0 16px var(--glow);}
.tag{
  display:inline-block;
  font-size:12px;
  padding:2px 8px;
  border-radius:999px;
  margin-right:8px;
  border:1px solid #ffffff22;
  opacity:.95;
}
.tag-main{color:var(--accent);background:#ff6aa214;border-color:#ff6aa244;}
.tag-safe{color:var(--good);background:#7cffb214;border-color:#7cffb255;}
.tag-risk{color:var(--bad);background:#ff5b5b14;border-color:#ff5b5b66;}
.tag-warn{color:var(--warn);background:#ffd36b14;border-color:#ffd36b66;}

/* stats */
.stat{display:flex;align-items:center;gap:10px;margin:6px 0;font-size:13px;}
.stat b{width:90px;color:#fff;font-weight:600}
.bar{flex:1;height:8px;background:#00000033;border:1px solid #ffffff12;border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,#7cffb2,#ffd36b,#ff6aa2);width:50%}
.val{width:44px;text-align:right}

/* system */
.sysRow{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0;font-size:13px;}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ffffff22;}
.badge-ok{color:var(--good);border-color:#7cffb266;background:#7cffb214;}
.badge-warn{color:var(--warn);border-color:#ffd36b66;background:#ffd36b12;}
.badge-bad{color:var(--bad);border-color:#ff5b5b66;background:#ff5b5b14;}

.btn{
  cursor:pointer;
  border-radius:10px;
  padding:8px 10px;
  border:1px solid #ffffff22;
  background:#20245a;
  color:var(--text);
  transition:.15s;
  font-size:13px;
}
.btn:hover{transform:translateY(-1px);border-color:var(--accent);box-shadow:0 0 10px var(--glow);}
.btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

/* floating tip */
.float{
  position:fixed; right:14px; top:14px; z-index:9999;
  padding:8px 10px; border-radius:10px;
  border:1px solid #ffffff22; background:#12152aee; box-shadow:var(--shadow);
  animation: floatUp 1.4s ease-out forwards; font-size:13px;
}
.float.good{color:var(--good);border-color:#7cffb255}
.float.bad{color:var(--bad);border-color:#ff5b5b66}
.float.warn{color:var(--warn);border-color:#ffd36b66}
@keyframes floatUp{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-40px)}}

/* punishment animation */
.flash{position:fixed;inset:0;background:radial-gradient(900px 400px at 50% 20%, #ff5b5b33, transparent 70%);opacity:0;pointer-events:none;z-index:9998;}
.flash.on{animation:flash .55s ease-in-out;}
@keyframes flash{0%{opacity:0}35%{opacity:1}100%{opacity:0}}
.shake{animation:shake .42s linear}
@keyframes shake{0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}100%{transform:translateX(0)}}

/* modal */
.mask{position:fixed;inset:0;background:#00000088;display:none;align-items:center;justify-content:center;z-index:10000;}
.mask.show{display:flex}
.modal{
  width:min(860px, 92vw);
  max-height:84vh;
  overflow:auto;
  background:linear-gradient(180deg,#1b1f3a 0%, #14182e 100%);
  border:1px solid var(--border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:14px;
}
.modalTop{display:flex;justify-content:space-between;align-items:center;gap:10px;}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px;}
@media(max-width:680px){.grid2{grid-template-columns:1fr}}
.item{border:1px solid #ffffff1a;background:#10132a66;border-radius:12px;padding:10px;}
.item h4{margin:0 0 6px;color:#fff;font-size:14px;}
.meta{display:flex;gap:8px;align-items:center;margin:6px 0;font-size:12px;color:var(--muted);flex-wrap:wrap;}
.price{color:var(--accent);border:1px solid #ff6aa244;background:#ff6aa214;border-radius:999px;padding:2px 8px;}
.desc{font-size:12px;line-height:1.55;color:#d7d9ff;}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}

/* portraits */
.porWrap{display:flex;gap:10px;align-items:center;margin-bottom:8px;}
.por{
  width:44px;height:44px;border-radius:12px;
  border:1px solid #ffffff22;
  background: linear-gradient(135deg,#ff6aa240,#7cffb240);
  box-shadow:0 0 12px #0006;
  overflow:hidden;
  flex:0 0 auto;
}
.por img{width:100%;height:100%;object-fit:cover;display:block;}
.speaker{font-weight:800;color:#fff;letter-spacing:.3px}
.speaker small{font-weight:400;color:var(--muted)}
.kv{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.kv .pill{
  font-size:12px;border:1px solid #ffffff22;border-radius:999px;padding:2px 8px;
  color:#fff;background:#0f1220aa;
}
</style>
</head>

<body>
<div class="flash" id="flash"></div>

<div class="container">

  <div class="card" id="cardStory">
    <h3>ğŸ“œ å½“å‰å‰§æƒ…</h3>
    <div class="porWrap">
      <div class="por" id="porBox"><img id="porImg" alt="" /></div>
      <div>
        <div class="speaker" id="speaker">æŸ³æ‰¶é£ <small>ï¼ˆä½ ï¼‰</small></div>
        <div class="small" id="subtitle"></div>
        <div class="kv" id="routePills"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div id="story"></div>
  </div>

  <div class="card" id="cardAction">
    <h3>ğŸ¯ è¡ŒåŠ¨é¢æ¿</h3>
    <div class="small">æ¯å›åˆé€‰ 1 é¡¹ï¼›é€‰å®Œä¼šè¿›å…¥â€œç»“ç®—â€ï¼Œå†ç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©ã€‚é«˜äº®=æ€æ¡Œ/é«˜é£é™©ã€‚</div>
    <div class="hr"></div>
    <div id="options"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnCustom">âœï¸ è‡ªå®šä¹‰è¡ŒåŠ¨</button>
      <button class="btn" id="btnEnd">â© ç»“æŸæœ¬å›åˆ</button>
      <button class="btn" id="btnAI">ğŸ¤– AIç»­å†™</button>
    </div>
  </div>

  <div class="card" id="cardStats">
    <h3>ğŸ“Š è§’è‰²çŠ¶æ€</h3>
    <div class="small">ç³»ç»Ÿè­¦å‘Šå€¼â‰¥70æ›´ç‹ ï¼›å¥åº·â‰¤15å¯èƒ½â€œç—…å€’â€ã€‚Day20 è‡ªåŠ¨ç»“å±€åˆ¤å®šã€‚</div>
    <div class="hr"></div>
    <div id="stats"></div>
    <div class="hr"></div>
    <button class="btn" id="btnAch">ğŸ† æˆå°±</button>
  </div>

  <div class="card" id="cardSystem">
    <h3>âš™ ç³»ç»Ÿç›‘æ§</h3>
    <div id="system"></div>
    <div class="hr"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnShop">ğŸ›’ ç³»ç»Ÿå•†åŸ</button>
      <button class="btn" id="btnPortrait">ğŸ–¼ ç«‹ç»˜è®¾ç½®</button>
      <button class="btn" id="btnSave">ğŸ’¾ å­˜æ¡£</button>
      <button class="btn" id="btnLoad">ğŸ“¥ è¯»æ¡£</button>
      <button class="btn" id="btnReset">ğŸ§¨ æ¸…æ¡£é‡å¼€</button>
      <button class="btn" id="btnAIKey">ğŸ”‘ è®¾ç½®AIå¯†é’¥</button>
    </div>
  </div>

</div>

<!-- Shop -->
<div class="mask" id="shopMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ›’ ç³»ç»Ÿå•†åŸ</div>
        <div class="small">è´§å¸=æ€æ¡Œå€¼ã€‚ä¹°æŠ€èƒ½æ›´å®¹æ˜“â€œéª—è¿‡ç³»ç»Ÿâ€ã€‚</div>
      </div>
      <button class="btn" id="btnCloseShop">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div class="small" id="shopMoney"></div>
    <div class="grid2" id="shopGrid"></div>
  </div>
</div>

<!-- Achievements -->
<div class="mask" id="achMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ† æˆå°±</div>
        <div class="small">æ»¡è¶³æ¡ä»¶ä¼šè‡ªåŠ¨è§£é”å¹¶å¼¹æç¤ºã€‚</div>
      </div>
      <button class="btn" id="btnCloseAch">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div id="achList" class="grid2"></div>
  </div>
</div>

<!-- Portrait -->
<div class="mask" id="porMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ–¼ ç«‹ç»˜/å¤´åƒè®¾ç½®</div>
        <div class="small">å¯ç²˜è´´å›¾ç‰‡URLï¼ˆä¸å¡«å°±ç”¨é»˜è®¤è‰²å—ï¼‰ã€‚</div>
      </div>
      <button class="btn" id="btnClosePor">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div class="item">
        <h4>æŸ³æ‰¶é£ï¼ˆä½ ï¼‰</h4>
        <div class="desc">å¤´åƒURL</div>
        <div class="row">
          <input id="inYou" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff22;background:#0f1220;color:#fff" placeholder="https://..." />
          <button class="btn" id="btnSaveYou">ä¿å­˜</button>
        </div>
      </div>
      <div class="item">
        <h4>å¤ªå­Â·æ…•å®¹ç©</h4>
        <div class="desc">å¤´åƒURL</div>
        <div class="row">
          <input id="inPrince" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff22;background:#0f1220;color:#fff" placeholder="https://..." />
          <button class="btn" id="btnSavePrince">ä¿å­˜</button>
        </div>
      </div>
      <div class="item">
        <h4>è‹æ¸…è²</h4>
        <div class="desc">å¤´åƒURL</div>
        <div class="row">
          <input id="inSu" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff22;background:#0f1220;color:#fff" placeholder="https://..." />
          <button class="btn" id="btnSaveSu">ä¿å­˜</button>
        </div>
      </div>
      <div class="item">
        <h4>ç³»ç»Ÿ</h4>
        <div class="desc">å¤´åƒURL</div>
        <div class="row">
          <input id="inSys" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff22;background:#0f1220;color:#fff" placeholder="https://..." />
          <button class="btn" id="btnSaveSys">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AI Key -->
<div class="mask" id="aiMask">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:800;color:#fff">ğŸ”‘ AIå¯†é’¥</div>
        <div class="small">æŠŠ OpenAI API Key å¡«è¿™é‡Œï¼ˆåªå­˜æœ¬åœ° localStorageï¼‰ã€‚</div>
      </div>
      <button class="btn" id="btnCloseAI">å…³é—­</button>
    </div>
    <div class="hr"></div>
    <div class="item">
      <h4>OpenAI API Key</h4>
      <div class="desc">æ ¼å¼ï¼šsk-...ï¼ˆæ³¨æ„ä¿å¯†ï¼Œä¸è¦å‘ç»™åˆ«äººï¼‰</div>
      <div class="row">
        <input id="inKey" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff22;background:#0f1220;color:#fff" placeholder="sk-..." />
        <button class="btn" id="btnSaveKey">ä¿å­˜</button>
      </div>
      <div class="hr"></div>
      <div class="small">æç¤ºï¼šæœ¬é¡¹ç›®ç”¨ <b>/v1/responses</b> è°ƒç”¨ï¼ˆæ–°æ¥å£ï¼‰ã€‚ [oai_citation:1â€¡OpenAI å¹³å°](https://platform.openai.com/docs/guides/migrate-to-responses?utm_source=chatgpt.com)</div>
    </div>
  </div>
</div>

<script>
/* =========================
   1) ä¸–ç•Œè§‚ä¸å‰§æƒ…ï¼ˆDay1â€“Day20ï¼‰
   ========================= */

/**
 * ä¸‰æ¡ä¸»è·¯çº¿ï¼ˆæŒ‰â€œä½ çš„é€‰æ‹©â€è‡ªåŠ¨å€¾å‘ï¼‰
 * ç”œå® ï¼šå¤ªå­å¥½æ„Ÿé«˜ + åç¦»é€‚ä¸­ + å£°æœ›ä¸å´©
 * æƒè°‹ï¼šè°‹ç•¥é«˜ + è¯æ®çº¿æ¨è¿› + å£°æœ›/å®¶æ—é«˜
 * é»‘åŒ–ï¼šåç¦»é«˜ + æ€æ¡Œé«˜ + è­¦å‘Šé«˜/å¿ƒæ™ºä½ä»ç¡¬æ‰›
 */
function dayIntroTemplate(day){
  const map = {
    1: `ä½ çŒ›åœ°çå¼€çœ¼ã€‚\n\nç»£å¸ä½å‚ï¼Œæª€é¦™å¹½å¹½ã€‚\nä½ ç©¿è¿›è™æ–‡ï¼Œæˆäº†æœ€ç»ˆæƒ¨æ­»çš„å¥³é…ï¼šæŸ³æ‰¶é£ã€‚\n\nã€ä¸»çº¿ä»»åŠ¡ï¼šåˆåå‰å¾€ä¸œå®«ï¼Œä¸ºå¤ªå­é€å‚æ±¤ã€‚ã€‘\n\nåŸè‘—é‡Œä½ è¢«è‹æ¸…è²æ’ç¿»æ±¤ç›…ï¼Œå¤ªå­å†·çœ¼ï¼Œä½ æ²¦ä¸ºç¬‘æŸ„ã€‚\nä½ æŠ¬æ‰‹ï¼ŒæŒ‡å°–å‘ç™½ï¼š\n\nâ€œè¿™ä¸€ä¸–ï¼Œæˆ‘ä¸å½“æ€¨ç§ã€‚â€\nâ€œæ¡Œå­ï¼Ÿæˆ‘æ¥æ€ã€‚â€`,
    2: `ç¬¬äºŒæ—¥æ¸…æ™¨ï¼Œæ°¸å®åŸçš„é£å¸¦ç€å¯’ã€‚\nç³»ç»Ÿæ¢äº†å£å»ï¼š\nã€æç¤ºï¼šåç¦»åº¦è¶Šé«˜ï¼Œæƒ©ç½šè¶Šç‹ ã€‚ã€‘\n\nä½ çœ‹ç€åŸä¸­è½¦é©¬ï¼Œå¿½ç„¶æ˜ç™½ï¼š\nè¿™åŸé‡Œï¼Œæ¯æ¡å··å­éƒ½è—ç€è€³æœµã€‚`,
    3: `ç¬¬ä¸‰æ—¥ï¼Œä¸œå®«ä¼ å£è°•ï¼šå¤ªå­è¦è§ä½ ã€‚\nç³»ç»Ÿä½å£°åŠä½ â€œä¿æŒäººè®¾â€ã€‚\nä½ å´åªæƒ³çŸ¥é“ï¼š\n\nä»–åˆ°åº•æ˜¯åˆ€ï¼Œè¿˜æ˜¯é˜ï¼Ÿ`,
    4: `ç¬¬å››æ—¥ï¼Œä¸ç›¸åºœçš„é—¨æ§›æ¯”åˆ€è¿˜é”‹åˆ©ã€‚\nè‹æ¸…è²çš„â€œæ¸©æŸ”â€ï¼Œå¼€å§‹åœ¨åŸé‡Œå‘èŠ½ã€‚\nä½ éœ€è¦ä¸€æŠŠé•°åˆ€ã€‚\nâ€”â€”æˆ–è€…ä¸€æŠŠç«ã€‚`,
    5: `ç¬¬äº”æ—¥ï¼Œå¤ªå­åºœè®¾å°å®´ã€‚\nå¸­é—´çš„ç¬‘å£°åƒè–„å†°ã€‚\nä½ åœ¨å†°ä¸‹çœ‹è§æš—æµï¼š\næœ‰äººæƒ³ç”¨ä½ å½“å«è„šçŸ³ã€‚`,
    6: `ç¬¬å…­æ—¥ï¼Œå®«é‡Œä¼ æ¥ä¸€é“å¯†æ—¨é£å£°ã€‚\næœ‰äººè¦å€Ÿâ€œå¥³çœ·äº‰æ–—â€é®ä½â€œæœå ‚äº¤æ˜“â€ã€‚\nä½ è‹¥åªæ–—å®…æ–—ï¼Œå°±ä¼šè¾“ã€‚`,
    7: `ç¬¬ä¸ƒæ—¥ï¼Œçš‡åå¬è§ã€‚\nå¥¹çœ‹ä½ åƒçœ‹ä¸€æšæ£‹ã€‚\nä½ è¦è®©å¥¹çŸ¥é“ï¼š\nä½ æ˜¯ä¼šåå’¬çš„æ£‹ã€‚`,
    8: `ç¬¬å…«æ—¥ï¼ŒåŸå¤–æœ‰å…µæ¢°èµ°ç§çš„å½±å­ã€‚\nä½ é—»åˆ°äº†è¡€ä¸é“¶å­çš„å‘³é“ã€‚\nè‹æ¸…è²çš„â€œå¹²å‡€â€ï¼Œä¹Ÿè®¸åªæ˜¯æ´—å¾—æ›´ä»”ç»†ã€‚`,
    9: `ç¬¬ä¹æ—¥ï¼Œå¤ªå­å¿½ç„¶ç»™äº†ä½ ä¸€æ”¯æš—å«ã€‚\nç³»ç»Ÿè­¦å‘Šï¼š\nã€å…³ç³»çº¿æ³¢åŠ¨ï¼Œè°¨æ…ã€‚ã€‘\n\nä½ å¿ƒé‡Œå´ä¸€ç¬‘ï¼š\nâ€œä»–ç»™æˆ‘åˆ€ï¼Œæˆ‘å°±æ‹¿å®ƒå¼€è·¯ã€‚â€`,
    10:`ç¬¬åæ—¥ï¼Œä¸ç›¸åºœæ”¾å‡ºæµè¨€ï¼š\nâ€œæŸ³æ‰¶é£ç—´æ‹å¤ªå­ï¼Œå¦„å›¾é€¼å©šã€‚â€\n\nä½ çœ‹ç€é‚£å¥â€œç—´æ‹â€ï¼Œåƒçœ‹ä¸€å¼ è„çº¸ã€‚\nä½ è¦æŠŠçº¸ç‚¹ç€ã€‚`,
    11:`ç¬¬åä¸€æ—¥ï¼Œçš‡åŸå¤œé›¨ã€‚\næœ‰äººåœ¨é›¨é‡Œæ¢äº†ä¿¡ä»¶ã€‚\nä½ çš„è¯æ®çº¿ï¼Œç»ˆäºç¢°åˆ°æ ¸å¿ƒï¼š\nâ€œä¸œå®«å†…ä¾â€ä¸â€œä¸ç›¸ç§åº“â€ã€‚`,
    12:`ç¬¬åäºŒæ—¥ï¼Œå¤ªå­ç§ä¸‹é—®ä½ ï¼š\nâ€œä½ åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Ÿâ€\n\nä½ æƒ³è¦å¾ˆå¤šã€‚\nä½†ä½ åªä¼šè¯´ä½ è¦çš„é‚£ä¸€ä»¶â€”â€”\næœ€èƒ½è®©ä½ èµ¢çš„é‚£ä¸€ä»¶ã€‚`,
    13:`ç¬¬åä¸‰æ—¥ï¼Œè‹æ¸…è²ç¬¬ä¸€æ¬¡ä¸»åŠ¨æ¥å°†å†›åºœã€‚\nå¥¹ç¬‘å¾—å¤ªæ¸©æŸ”ã€‚\næ¸©æŸ”åˆ°åƒè¦æŠŠä½ åŸ‹äº†ã€‚`,
    14:`ç¬¬åå››æ—¥ï¼Œæœå ‚äº‰è®ºèµ·â€œè¾¹å†›ç²®é¥·â€ã€‚\nä½ çš„çˆ¶äº²ç«™åœ¨é£å£ã€‚\nä½ è‹¥ä¸å‡ºæ‰‹ï¼Œå®¶æ—å£°æœ›ä¼šè¢«æ’•å¼€å£å­ã€‚`,
    15:`ç¬¬åäº”æ—¥ï¼Œå¤ªå­ä¸ä¸ç›¸å…¬å¼€å¯¹å³™ã€‚\nä½ ç«™åœ¨ä¸¤æ–¹ä¹‹é—´ã€‚\nç³»ç»Ÿå…´å¥‹ï¼š\nã€å…³é”®åˆ†æ­§ç‚¹å‡ºç°ï¼ã€‘\n\nä½ ä¹Ÿå…´å¥‹ã€‚\nå› ä¸ºä½ ç»ˆäºèƒ½é€‰ï¼š\nâ€œçˆ±â€è¿˜æ˜¯â€œæƒâ€ã€‚\nâ€”â€”æˆ–è€…ä¸¤è€…éƒ½è¦ã€‚`,
    16:`ç¬¬åå…­æ—¥ï¼ŒåŸé‡Œå‡ºç°åˆºå®¢ã€‚\nåˆºå®¢çš„ç›®æ ‡ä¸æ˜¯ä½ ã€‚\nä½†ä½ çŸ¥é“ï¼š\nâ€œåˆ€è¦è½ä¸‹ä¹‹å‰ï¼Œæ€»è¦å…ˆè¯•åˆƒã€‚â€`,
    17:`ç¬¬åä¸ƒæ—¥ï¼Œçš‡åç»™ä½ ä¸€æ¡é€€è·¯ï¼š\nâ€œå«ç»™åˆ«çš„äººï¼Œä¿å¹³å®‰ã€‚â€\n\né€€è·¯å¾ˆæš–ã€‚\nä½†ä½ ä¸æƒ³å›å¤´ã€‚`,
    18:`ç¬¬åå…«æ—¥ï¼Œä½ æ¡åˆ°ä¸ç›¸åºœçœŸæ­£çš„è´¦å†Œã€‚\nåšå¾—åƒä¸€åº§åŸã€‚\nä½ åªéœ€æŠŠåŸç›–æ€å¼€ä¸€æ¬¡ã€‚`,
    19:`ç¬¬åä¹æ—¥ï¼Œå¤ªå­é—®ä½ ï¼š\nâ€œè‹¥æˆ‘ç™»åŸºï¼Œä½ è¦ä»€ä¹ˆä½ç½®ï¼Ÿâ€\n\nä½ æŠ¬çœ¼ï¼š\nâ€œæˆ‘è¦ä½ æ‰¿è®¤ï¼Œæˆ‘ä¸æ˜¯é™„å±å“ã€‚â€`,
    20:`ç¬¬äºŒåæ—¥ï¼Œé£åœã€‚\nç‰Œé¢å·²ç»æ‘†å¥½ã€‚\nç³»ç»Ÿå†·å†·å®£å¸ƒï¼š\nã€ç»ˆå±€åˆ¤å®šå¼€å§‹ã€‚ã€‘\n\nä½ å¬è§è‡ªå·±å¿ƒè·³ã€‚\nä¸æ˜¯å®³æ€•ã€‚\næ˜¯èƒœè´Ÿæ¬²ã€‚`,
  };
  return map[day] || `ç¬¬${day}æ—¥ï¼Œå‰§æƒ…ä»åœ¨æ¨è¿›â€¦â€¦`;
}

/**
 * Day 1â€“20ï¼šæ¯ä¸€å¤© 4 ä¸ªé€‰é¡¹
 * - ä¸»çº¿/ä½é£é™©ï¼šç¨³ä½ç³»ç»Ÿ
 * - æ€æ¡Œ/é«˜é£é™©ï¼šèµšæ€æ¡Œå€¼ + åç¦»åº¦
 * - è°‹ç•¥/ä¸­é£é™©ï¼šè¯æ®çº¿æ¨è¿›
 * - å…»æˆ/ä½é£é™©ï¼šå›è¡€/ç¨³å¿ƒæ™º
 */
function buildPlot(){
  const plot = {};
  for(let d=1; d<=20; d++){
    const key = `MAIN_${d}`;
    plot[d] = {
      title: `ç¬¬${d}æ—¥`,
      mainTask: (d===1) ? "åˆåå‰å¾€ä¸œå®«é€å‚æ±¤ï¼ˆåŸè‘—å…³é”®èŠ‚ç‚¹ï¼‰"
              : (d===20) ? "ç»ˆå±€ï¼šæ‘Šç‰Œå¹¶è½å­"
              : "å®Œæˆä¸€æ¬¡å…³é”®æ¨è¿›ï¼ˆç¨³å£°æœ›/æ‹¿è¯æ®/æ§å¤ªå­çº¿ï¼‰",
      key,
      intro: dayIntroTemplate(d),
      options: (state)=> dayOptions(d, state, key)
    };
  }
  return plot;
}

function dayOptions(d, state, key){
  const P = state.player;
  const warn = P["ç³»ç»Ÿè­¦å‘Šå€¼"];
  const highWarn = warn >= 70;

  // è®© Day20 çš„é€‰é¡¹æ›´â€œç»ˆå±€â€
  if(d===20){
    return [
      opt(`d20a`, ["ç”œå® ","ä¸­é£é™©"], false, key,
`ä½ é€‰æ‹©åœ¨ç»ˆå±€å‰ï¼Œå…ˆå»è§å¤ªå­ã€‚\n\nä½ ä¸è°ˆæƒï¼Œåªè°ˆä½ è‡ªå·±ï¼š\nâ€œæˆ‘ä¸æƒ³åšä½ çš„é™„å±å“ã€‚â€\n\nå¤ªå­æ²‰é»˜è‰¯ä¹…ï¼ŒæŠŠä½ çš„æ‰‹æŒ‰åœ¨æŒå¿ƒï¼š\nâ€œé‚£å°±å¹¶è‚©ã€‚â€\n\nä½ å¬è§ç³»ç»Ÿå‘å‡ºä¸ç”˜çš„å—¡é¸£ã€‚\nä½ ç¬‘ï¼š\nâ€œæˆ‘ä»¬ä¸€èµ·æŠŠå®ƒå…³æ‰ã€‚â€`,
        { "å¤ªå­å¥½æ„Ÿ": +6, åç¦»åº¦:+1, è´µå¥³å£°æœ›:+2, æ€æ¡Œå€¼:+2 }
      ),
      opt(`d20b`, ["æƒè°‹","é«˜é£é™©"], true, key,
`ä½ æŠŠè´¦å†Œä¸è¯æ®é€’è¿›æœå ‚ã€‚\n\nä½ ä¸æ±‚æ€œæ‚¯ï¼Œåªæ±‚åˆ¤å†³ã€‚\nä¸ç›¸çš„è„¸è‰²ç¬¬ä¸€æ¬¡è£‚å¼€ã€‚\n\nä½ æŠ¬çœ¸ï¼Œå£°éŸ³æ¸…å†·ï¼š\nâ€œæˆ‘ä¸æ˜¯æ¥å“­çš„ï¼Œæˆ‘æ˜¯æ¥æ”¶è´¦çš„ã€‚â€\n\nç³»ç»Ÿå°–å«ï¼š\nã€åç¦»åº¦å¼‚å¸¸ï¼å‰§æƒ…å¼ºåˆ¶å›æ”¶ï¼ã€‘\n\nä½ å½“ä¼—å›å®ƒä¸€å¥ï¼š\nâ€œæ”¶ä½ ã€‚â€`,
        { è°‹ç•¥:+4, å®¶æ—å£°æœ›:+4, è´µå¥³å£°æœ›:+2, æ€æ¡Œå€¼:+8, åç¦»åº¦:+5, "ç³»ç»Ÿè­¦å‘Šå€¼":+6 }
      ),
      opt(`d20c`, ["é»‘åŒ–","æé«˜é£é™©"], true, key,
`ä½ ä¸æŠŠè¯æ®äº¤ç»™ä»»ä½•äººã€‚\nä½ é€‰æ‹©ç›´æ¥â€œæ–­æ ¹â€ã€‚\n\nå¤œé‡Œï¼Œä¸ç›¸ç§åº“èµ·ç«ã€‚\nä½ ç«™åœ¨ç«å…‰å¤–ï¼Œåƒç«™åœ¨æ–°ä¸–ç•Œé—¨å£ã€‚\n\nå¤ªå­èµ¶æ¥ï¼Œçœ¼é‡Œç¬¬ä¸€æ¬¡å‡ºç°æ…Œï¼š\nâ€œä½ ç–¯äº†å—ï¼Ÿâ€\n\nä½ è½»è½»ç¬‘ï¼š\nâ€œæˆ‘åªæ˜¯å­¦ä¼šäº†ä»–ä»¬çš„è§„åˆ™ã€‚â€`,
        { æ€æ¡Œå€¼:+12, åç¦»åº¦:+8, å¿ƒæ™º:-6, "ç³»ç»Ÿè­¦å‘Šå€¼":+12, "å¤ªå­å¥½æ„Ÿ":-2, è´µå¥³å£°æœ›:-3 }
      ),
      opt(`d20d`, ["ä¿å‘½","ä½é£é™©"], false, key,
`ä½ é€‰æ‹©é€€ä¸€æ­¥ã€‚\næŠŠè¯æ®äº¤ç»™å¤ªå­ï¼Œè®©ä»–å»æ–©ã€‚\nä½ åªä¿å…¨å°†å†›åºœã€‚\n\nç³»ç»Ÿæ»¡æ„ï¼š\nã€å®¿ä¸»å›å½’â€œå¥³é…å®‰å…¨çº¿â€ã€‚ã€‘\n\nä½ å´åœ¨å¿ƒé‡Œè¡¥ä¸€å¥ï¼š\nâ€œå®‰å…¨çº¿ï¼Œæ˜¯æˆ‘ç”»çš„ã€‚â€`,
        { å®¶æ—å£°æœ›:+3, è´µå¥³å£°æœ›:+2, åç¦»åº¦:-1, "å¤ªå­å¥½æ„Ÿ":+2 }
      ),
    ];
  }

  // é€šç”¨å››é€‰
  const mainText = (d===1)
    ? `ä½ æŒ‰ä¸»çº¿å»ä¸œå®«é€æ±¤ï¼Œç¨³ä½ç³»ç»Ÿã€‚`
    : `ä½ å®Œæˆä»Šæ—¥â€œä½“é¢æ¨è¿›â€ï¼ŒæŠŠè‡ªå·±æ‘†åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šã€‚`;

  const flipText = (d===1)
    ? `ä½ å½“ä¼—å€’æ±¤æ€æ¡Œï¼Œæ•´åº§åŸéƒ½å¬è§ä½ çš„åˆ€å£°ã€‚`
    : `ä½ æŒ‘æœ€è¦å‘½çš„åœºåˆæ€æ¡Œï¼šè¦ä¹ˆèµ¢å¾—å½»åº•ï¼Œè¦ä¹ˆæ­»å¾—æ¼‚äº®ã€‚`;

  const intelText = (d===1)
    ? `ä½ æš—æŸ¥è‹æ¸…è²ï¼Œé—»åˆ°å¥¹â€œå¹²å‡€â€èƒŒåçš„è„ã€‚`
    : `ä½ æ¨è¿›è¯æ®çº¿ï¼šè´¦ã€ä¿¡ã€äººè¯ï¼Œä¸‰è€…è‡³å°‘æŠ“åˆ°å…¶ä¸€ã€‚`;

  const restText = `ä½ æ”¶åˆ€å…¥é˜ï¼Œå…»èº«ç¨³å¿ƒã€‚ä½ ä¸æ€•æ…¢ï¼Œä½ æ€•ä¹±ã€‚`;

  // æŸäº›å¤©ç»™ä¸€ç‚¹ä¸“å±å‘³é“ï¼ˆä¸å½±å“ç»“æ„ï¼‰
  const spice = {
    4: ["è‹æ¸…è²é€’æ¥ç”œå¸–","ä½ æŠŠç”œå¸–å‹åœ¨ç šå°ä¸‹ï¼šè®©å®ƒå‘éœ‰ã€‚"],
    7: ["çš‡åä¸€å¥è¯èƒ½å‹æ­»äºº","ä½ åè¦æŠ¬å¤´ï¼ŒåƒæŠ¬åˆ€ã€‚"],
    10:["æµè¨€åƒç®­","ä½ è®©ç®­æ‰å¤´ã€‚"],
    15:["æœå ‚å¯¹å³™","ä½ è¦æŠŠä¸¤è¾¹éƒ½å˜æˆä½ çš„ç­¹ç ã€‚"],
    18:["çœŸè´¦å†Œåˆ°æ‰‹","ä½ ä¸æ€¥ç€æ€ç›–ï¼Œä½ å…ˆæŒ–è·¯ã€‚"],
  };
  const extra = spice[d] ? `\n\nï¼ˆä»Šæ—¥è¦ç‚¹ï¼š${spice[d][0]}ã€‚\nä½ æƒ³ï¼š${spice[d][1]}ï¼‰` : "";

  return [
    opt(`d${d}a`, ["ä¸»çº¿","ä½é£é™©"], false, key,
`${mainText}${extra}\n\nä½ æŠŠæƒ…ç»ªæ”¶å¾—å¾ˆç¨³ã€‚\nç¨³åˆ°æ—äººä»¥ä¸ºä½ è®¤å‘½ã€‚\nåªæœ‰ä½ è‡ªå·±çŸ¥é“ï¼š\nä½ æ˜¯åœ¨è“„åŠ›ã€‚`,
      { "å¤ªå­å¥½æ„Ÿ": +2, åç¦»åº¦: -1, è´µå¥³å£°æœ›: +1, "ç³»ç»Ÿè­¦å‘Šå€¼": -2 }
    ),
    opt(`d${d}b`, ["æ€æ¡Œ","é«˜é£é™©"], true, "DEFY",
`${flipText}${extra}\n\nç³»ç»Ÿå¼€å§‹å°–å«ã€‚\nä½ å´æ„Ÿè§‰è¡€æ¶²åœ¨å‘çƒ«ã€‚\n\nä½ ä¸æ˜¯åœ¨åæŠ—å‘½è¿ã€‚\nä½ æ˜¯åœ¨æ”¹å†™è§„åˆ™ã€‚`,
      { æ€æ¡Œå€¼: +6, åç¦»åº¦: +4, è´µå¥³å£°æœ›: -1, "ç³»ç»Ÿè­¦å‘Šå€¼": +6, å¿ƒæ™º: -1 }
    ),
    opt(`d${d}c`, ["è°‹ç•¥","ä¸­é£é™©"], false, "EVIDENCE",
`${intelText}${extra}\n\nä½ æŠŠçº¿ä¸€æ ¹æ ¹æŠ½å‡ºæ¥ã€‚\nä¸æ€¥ç€æ‰¯æ–­ã€‚\nä½ è¦ç­‰å®ƒç¼ ä¸Šå¯¹æ–¹çš„è„–å­ã€‚`,
      { è°‹ç•¥: +3, åç¦»åº¦: +1, "è‹æ¸…è²æ€€ç–‘": +3, è´µå¥³å£°æœ›: +1 }
    ),
    opt(`d${d}d`, ["å…»æˆ","ä½é£é™©"], false, "REST",
`${restText}${extra}\n\nä½ æ˜ç™½ï¼š\nçœŸæ­£çš„ç‹ ï¼Œä¸æ˜¯æ¯å¤©éƒ½æ€æ¡Œã€‚\nè€Œæ˜¯è¯¥æ€çš„æ—¶å€™â€”â€”ä¸€å‡»æ¯™å‘½ã€‚`,
      { å¿ƒæ™º: +4, å¥åº·: +4, åç¦»åº¦: 0, "ç³»ç»Ÿè­¦å‘Šå€¼": -1 }
    ),
    ...(highWarn ? [opt(`d${d}e`, ["å±æœº","ä¸­é£é™©"], false, "CRISIS",
`ã€å±æœºæŠ•æ”¾ã€‘ç³»ç»Ÿåœ¨åŸé‡Œå¡è¿›ä¸€æšâ€œä¿®æ­£é’‰â€ã€‚\næœ‰äººçªç„¶æŒ‡æ§ä½ â€œè¿ç¤¼â€ï¼Œè¯•å›¾è®©ä½ å½“ä¼—å‡ºä¸‘ã€‚\n\nä½ çœ¼åº•ä¸€å†·ï¼š\nâ€œå¥½å•Šï¼Œé‚£å°±è®©ä»–ä»¬ä¸€èµ·å‡ºä¸‘ã€‚â€`,
      { å¿ƒæ™º: -2, è°‹ç•¥: +1, è´µå¥³å£°æœ›: -2, "ç³»ç»Ÿè­¦å‘Šå€¼": +0 }
    )] : [])
  ];
}

function opt(id, tag, highlight, actionKey, story, effect){
  return { id, tag, highlight, actionKey, story, effect };
}

const Plot = buildPlot();

/* =========================
   2) å•†åŸ / æˆå°± / ç»“å±€
   ========================= */

const Shop = [
  {id:"shield", name:"å±è”½ç¬¦", price:10, desc:"ä¸‹ä¸€æ¬¡å…ç³»ç»Ÿæƒ©ç½šï¼ˆä¸€æ¬¡æ€§ï¼‰ã€‚", apply:s=>s.buffs.noPunishOnce=true},
  {id:"actor", name:"æ¼”æŠ€å¤§å¸ˆ", price:40, desc:"è¢«åŠ¨ï¼šé™ä½æƒ©ç½šè§¦å‘æ¦‚ç‡ï¼ˆæ›´å®¹æ˜“éª—è¿‡ç³»ç»Ÿï¼‰ã€‚", apply:s=>s.buffs.actor=true},
  {id:"iron", name:"é“è¡€å¿ƒé˜²", price:30, desc:"è¢«åŠ¨ï¼šæƒ©ç½šå¯¹å¿ƒæ™º/å¥åº·çš„ä¼¤å®³-1ã€‚", apply:s=>s.buffs.iron=true},
  {id:"intel", name:"æƒ…æŠ¥çº¿äºº", price:25, desc:"ä¸€æ¬¡æ€§ï¼šä¸‹ä¸€å›åˆè°‹ç•¥+3ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰ã€‚", apply:s=>{s.buffs.nextIntelBoost=true}},
  {id:"lux", name:"ç²ç‘äººè„‰", price:35, desc:"è¢«åŠ¨ï¼šç¤¾äº¤ç›¸å…³é¢å¤–+2è´µå¥³å£°æœ›ã€‚", apply:s=>s.buffs.lux=true},
  {id:"heal", name:"å›æ˜¥ä¸¹", price:18, desc:"ä¸€æ¬¡æ€§ï¼šå¥åº·+10ï¼Œå¿ƒæ™º+6ã€‚", apply:s=>{s.player.å¥åº·=clamp(s.player.å¥åº·+10,0,100);s.player.å¿ƒæ™º=clamp(s.player.å¿ƒæ™º+6,0,100)}},
];

const Achievements = [
  {id:"firstFlip", name:"ç¬¬ä¸€æ€", desc:"ç¬¬ä¸€æ¬¡é€‰æ‹©æ€æ¡Œè¡ŒåŠ¨ã€‚", cond:s=>s.stats.flipCount>=1},
  {id:"rich", name:"æ€æ¡Œå¯Œå©†", desc:"æ€æ¡Œå€¼è¾¾åˆ° 30ã€‚", cond:s=>s.player.æ€æ¡Œå€¼>=30},
  {id:"love", name:"å¿ƒåŠ¨ä¿¡å·", desc:"å¤ªå­å¥½æ„Ÿè¾¾åˆ° 30ã€‚", cond:s=>s.player["å¤ªå­å¥½æ„Ÿ"]>=30},
  {id:"brain", name:"å±€ä¸­äºº", desc:"è°‹ç•¥è¾¾åˆ° 90ã€‚", cond:s=>s.player.è°‹ç•¥>=90},
  {id:"danger", name:"ç³»ç»Ÿå…¬æ•Œ", desc:"ç³»ç»Ÿè­¦å‘Šå€¼è¾¾åˆ° 80ã€‚", cond:s=>s.player["ç³»ç»Ÿè­¦å‘Šå€¼"]>=80},
  {id:"survive", name:"ç¡¬æ‰›ç‹", desc:"å¥åº·â‰¤15ä»æœªGameOverå¹¶ç»§ç»­æ¨è¿›ã€‚", cond:s=>s.stats.lowHPsurvive===true},
  {id:"day20", name:"ç»ˆå±€æŠµè¾¾", desc:"æŠµè¾¾ Day20ã€‚", cond:s=>s.day>=20},
];

function endingJudge(state){
  const P = state.player;
  const love = P["å¤ªå­å¥½æ„Ÿ"];
  const rep = P["è´µå¥³å£°æœ›"];
  const fam = P["å®¶æ—å£°æœ›"];
  const brain = P["è°‹ç•¥"];
  const dev = P["åç¦»åº¦"];
  const warn = P["ç³»ç»Ÿè­¦å‘Šå€¼"];

  // å¼ºåˆ¶BE/å´©æºƒ
  if(P.å¥åº·<=0) return {title:"BEï¼šç—…éª¨æˆç°", text:"ä½ ç¡¬æ‰›åˆ°æœ€åä¸€åˆ»ã€‚\nç³»ç»Ÿå†·å†·ç»“ç®—ï¼š\nã€å®¿ä¸»ç”Ÿå‘½å€¼å½’é›¶ã€‚ã€‘\n\nä½ èººåœ¨é£é‡Œï¼Œæƒ³èµ·ä¸€å¥è¯ï¼š\nâ€œæ€æ¡Œå¾ˆçˆ½ï¼Œä½†åˆ€ä¹Ÿä¼šåå™¬ã€‚â€\n\nç»“å±€ï¼šä½ æ­»äº†ï¼Œä½†ä½ è‡³å°‘ä¸æ˜¯æ€¨ç§ã€‚"};
  if(P.å¿ƒæ™º<=0) return {title:"BEï¼šå¿ƒæ™ºå´©å", text:"ä½ èµ¢äº†å¾ˆå¤šæ¬¡ã€‚\nå´è¾“ç»™äº†è‡ªå·±ã€‚\n\nç³»ç»ŸæŠŠä½ æ‹–å›æœ€é»‘çš„é‚£ä¸€é¡µï¼š\nâ€œå¥³é…å°±è¯¥å´©æºƒã€‚â€\n\nç»“å±€ï¼šä½ æ´»ç€ï¼Œå´å†ä¹Ÿä¸æ˜¯ä½ ã€‚"};

  // éšè—ï¼šå…³ç³»ç»Ÿï¼ˆéœ€è¦é«˜åç¦»+é«˜è°‹ç•¥+é«˜æ€æ¡Œï¼‰
  if(dev>=65 && brain>=85 && P.æ€æ¡Œå€¼>=40 && warn>=70){
    return {title:"éšè—ç»“å±€ï¼šä½ æŠŠç³»ç»Ÿå…³æœºäº†", text:"ä½ åœ¨ç»ˆå±€é‚£å¤œï¼ŒæŠŠæ‰€æœ‰è¯æ®ä¸äººå¿ƒæ”¾åˆ°åŒä¸€å¼ æ¡Œä¸Šã€‚\n\nç³»ç»Ÿæƒ³æ‰£ä½ åˆ†ã€‚\nä½ å´æŠŠå®ƒçš„æƒé™ä¹Ÿæ‰£æ‰ã€‚\n\nã€æƒé™è½¬ç§»ä¸­â€¦ã€‘\nã€ç³»ç»Ÿï¼šå…³é—­ã€‚ã€‘\n\nç»“å±€ï¼šä½ ä»â€œæ•…äº‹é‡Œçš„äººâ€ï¼Œå˜æˆâ€œå†™æ•…äº‹çš„äººâ€ã€‚"};
  }

  // ç”œå® ï¼šå¥½æ„Ÿé«˜ + åç¦»é€‚ä¸­ + å£°æœ›ä¸å´©
  if(love>=55 && dev<=45 && rep>=70){
    return {title:"ç”œå® ç»“å±€ï¼šå¹¶è‚©ä¸ºå", text:"å¤ªå­åœ¨ä¼—ç›®ç½ç½ä¸‹ç‰µä½ä½ ã€‚\n\nâ€œå­¤è¦çš„ï¼Œä»æ¥ä¸æ˜¯ä¸€æšå¥½ç”¨çš„æ£‹ã€‚â€\nâ€œå­¤è¦çš„æ˜¯ä½ ã€‚â€\n\nä½ ç¬‘ç€å›æ¡ï¼š\nâ€œé‚£å°±åˆ«æŠŠæˆ‘å½“å‰§æƒ…ã€‚â€\n\nç»“å±€ï¼šä½ ä»¬å¹¶è‚©ï¼ŒæŠŠæ—§ä¸–ç•Œæ”¹å¾—æ›´åƒä½ ä»¬ã€‚"};
  }

  // æƒè°‹ï¼šè°‹ç•¥é«˜ + å®¶æ—/å£°æœ›é«˜
  if(brain>=85 && fam>=80 && rep>=70){
    return {title:"æƒè°‹ç»“å±€ï¼šå¥³ç›¸ä¹‹è·¯", text:"ä½ æŠŠè´¦å†Œé€’ä¸Šæœå ‚ã€‚\nä¸ç›¸å€’å°ï¼Œæ—§åŠ¿åŠ›å´©è£‚ã€‚\n\nå¤ªå­çœ‹ä½ ï¼Œåƒçœ‹ä¸€åº§æ–°ç§©åºã€‚\n\nç»“å±€ï¼šä½ ä¸é çˆ±æƒ…ä¸Šä½ã€‚\nä½ é èƒœåˆ©ã€‚"};
  }

  // é»‘åŒ–ï¼šåç¦»é«˜ + æ€æ¡Œé«˜ + è­¦å‘Šé«˜
  if(dev>=55 && P.æ€æ¡Œå€¼>=35 && warn>=60){
    return {title:"é»‘åŒ–ç»“å±€ï¼šç«ä¸­æ‰§æƒ", text:"ä½ èµ°åˆ°æœ€åï¼Œæ‰‹ä¸Šæ²¡æœ‰ä¸€æ»´â€œæ— è¾œâ€ã€‚\n\nä½ çŸ¥é“è‡ªå·±åšäº†ä»€ä¹ˆã€‚\nä¹Ÿä¸åæ‚”ã€‚\n\nç»“å±€ï¼šä½ èµ¢å¾—å½»åº•ã€‚\nä»£ä»·æ˜¯ï¼Œä½ å†ä¹Ÿå›ä¸åˆ°ä»å‰ã€‚"};
  }

  // æ™®é€šå¥½ç»“å±€
  return {title:"æ™®é€šç»“å±€ï¼šä½ æ´»æˆäº†è‡ªå·±", text:"ä½ æ²¡æœ‰æŠŠæ‰€æœ‰äººéƒ½è¸©ä¸‹å»ã€‚\nä½†ä½ ä¹Ÿæ²¡æœ‰å†è·ªã€‚\n\nç»“å±€ï¼šä½ æ´»ä¸‹æ¥ï¼Œå¹¶ä¸”æ´»å¾—ä½“é¢ã€‚"};
}

/* =========================
   3) å¼•æ“çŠ¶æ€ï¼ˆä¿®å¤â€œè¿›ä¸äº†ç¬¬äºŒå¤©â€ï¼‰
   ========================= */

const State = {
  day: 1,
  phase: "INTRO", // INTRO / CHOOSE / RESOLVE / END
  speaker: "æŸ³æ‰¶é£",
  player: {
    é£å: 92,
    è°‹ç•¥: 78,
    å¿ƒæ™º: 74,
    å¥åº·: 88,
    æ€æ¡Œå€¼: 0,
    åç¦»åº¦: 0,
    è´µå¥³å£°æœ›: 85,
    å®¶æ—å£°æœ›: 95,
    ç³»ç»Ÿè­¦å‘Šå€¼: 0,
    "å¤ªå­å¥½æ„Ÿ": 0,
    "è‹æ¸…è²æ€€ç–‘": 0,
  },
  buffs: {
    noPunishOnce:false,
    actor:false,
    iron:false,
    nextIntelBoost:false,
    lux:false,
  },
  flags: {
    mainDone:false,
    ending:false
  },
  stats: {
    flipCount:0,
    lowHPsurvive:false
  },
  achievementsUnlocked: {},
  ai: {
    key: ""
  },
  portraits: {
    you:"",
    prince:"",
    su:"",
    sys:""
  }
};

/* =========================
   4) DOM
   ========================= */
const $ = id => document.getElementById(id);

const storyBox = $("story");
const subtitle = $("subtitle");
const optionBox = $("options");
const statBox = $("stats");
const systemBox = $("system");
const flash = $("flash");
const cards = [$("cardStory"),$("cardAction"),$("cardStats"),$("cardSystem")];

const porImg = $("porImg");
const speakerEl = $("speaker");
const routePills = $("routePills");

const shopMask = $("shopMask");
const shopGrid = $("shopGrid");
const shopMoney = $("shopMoney");

const achMask = $("achMask");
const achList = $("achList");

const porMask = $("porMask");
const aiMask = $("aiMask");

const inYou = $("inYou");
const inPrince = $("inPrince");
const inSu = $("inSu");
const inSys = $("inSys");
const inKey = $("inKey");

/* =========================
   5) util
   ========================= */
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function tip(text, kind="good"){
  const d=document.createElement("div");
  d.className=`float ${kind}`;
  d.innerText=text;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1400);
}

function typeText(text){
  storyBox.innerHTML="";
  let i=0;
  const timer=setInterval(()=>{
    storyBox.innerHTML += (text[i] ?? "");
    storyBox.scrollTop = storyBox.scrollHeight;
    i++;
    if(i>=text.length) clearInterval(timer);
  }, 10);
}

function setSpeaker(name){
  State.speaker = name;
  let key = "you";
  if(name.includes("å¤ªå­")) key="prince";
  else if(name.includes("è‹")) key="su";
  else if(name.includes("ç³»ç»Ÿ")) key="sys";
  speakerEl.innerHTML = `${name} <small>${key==="you"?"ï¼ˆä½ ï¼‰":""}</small>`;

  const url = State.portraits[key] || "";
  if(url){
    porImg.src = url;
    porImg.style.display="block";
  }else{
    // æ²¡URLå°±ç”¨é»˜è®¤è‰²å—ï¼ˆéšè—imgé¿å…ç ´å›¾ï¼‰
    porImg.removeAttribute("src");
    porImg.style.display="none";
  }
}

function computeRoute(){
  const P = State.player;
  // åªåšâ€œå€¾å‘æç¤ºâ€ï¼Œä¸ç¡¬é”è·¯çº¿
  const sweet = P["å¤ªå­å¥½æ„Ÿ"] + (100-P["ç³»ç»Ÿè­¦å‘Šå€¼"])*0.3 + P["è´µå¥³å£°æœ›"]*0.2 - P["åç¦»åº¦"]*0.2;
  const power = P["è°‹ç•¥"] + P["å®¶æ—å£°æœ›"]*0.25 + P["è´µå¥³å£°æœ›"]*0.15;
  const dark  = P["åç¦»åº¦"] + P["æ€æ¡Œå€¼"]*0.7 + P["ç³»ç»Ÿè­¦å‘Šå€¼"]*0.3 - P["å¿ƒæ™º"]*0.2;

  const arr = [
    {k:"ç”œå® å€¾å‘", v:sweet},
    {k:"æƒè°‹å€¾å‘", v:power},
    {k:"é»‘åŒ–å€¾å‘", v:dark},
  ].sort((a,b)=>b.v-a.v);

  routePills.innerHTML = "";
  arr.forEach((x,i)=>{
    const pill=document.createElement("div");
    pill.className="pill";
    pill.textContent = `${i===0?"â­ ":""}${x.k}`;
    routePills.appendChild(pill);
  });
}

/* =========================
   6) Render
   ========================= */
function renderSubtitle(){
  const dayPlot = Plot[State.day];
  const t = dayPlot?.title || `ç¬¬${State.day}æ—¥`;
  subtitle.innerHTML = `ã€Œ${t}ã€ <span class="small">ï¼ˆé€‰å®Œâ†’ç‚¹ç»“æŸå›åˆè¿›ä¸‹ä¸€å¤©ï¼‰</span>`;
}

function renderStats(){
  statBox.innerHTML="";
  const P = State.player;
  const rows = [
    ["é£å", P.é£å], ["è°‹ç•¥", P.è°‹ç•¥], ["å¿ƒæ™º", P.å¿ƒæ™º], ["å¥åº·", P.å¥åº·],
    ["æ€æ¡Œå€¼", P.æ€æ¡Œå€¼], ["åç¦»åº¦", P.åç¦»åº¦], ["è´µå¥³å£°æœ›", P.è´µå¥³å£°æœ›],
    ["å®¶æ—å£°æœ›", P.å®¶æ—å£°æœ›], ["ç³»ç»Ÿè­¦å‘Šå€¼", P.ç³»ç»Ÿè­¦å‘Šå€¼],
    ["å¤ªå­å¥½æ„Ÿ", P["å¤ªå­å¥½æ„Ÿ"]], ["è‹æ¸…è²æ€€ç–‘", P["è‹æ¸…è²æ€€ç–‘"]],
  ];
  rows.forEach(([k,v])=>{
    const pct = clamp(v,0,100);
    const el=document.createElement("div");
    el.className="stat";
    el.innerHTML = `<b>${k}</b><div class="bar"><div class="fill" style="width:${pct}%"></div></div><span class="val">${v}</span>`;
    statBox.appendChild(el);
  });
}

function renderSystem(extra=""){
  const P = State.player;
  const warn=P["ç³»ç»Ÿè­¦å‘Šå€¼"];
  let badge=`<span class="badge badge-ok">ç›‘æ§æ­£å¸¸</span>`;
  if(warn>=70) badge=`<span class="badge badge-bad">é«˜å±</span>`;
  else if(warn>=35) badge=`<span class="badge badge-warn">è­¦æƒ•</span>`;

  const dayPlot = Plot[State.day];
  const main = dayPlot?.mainTask || "ï¼ˆæš‚æ— ï¼‰";
  const done = State.flags.mainDone ? "âœ…å·²å®Œæˆ" : "âŒæœªå®Œæˆ";

  systemBox.innerHTML = `
    <div class="sysRow"><span>ğŸ“… å›åˆ</span><b>Day ${State.day} / 20</b></div>
    <div class="sysRow"><span>ğŸ¯ ä»Šæ—¥ä¸»çº¿</span><span>${done}</span></div>
    <div class="small">${main}</div>
    <div class="hr"></div>
    <div class="sysRow"><span>ğŸ‘ è­¦å‘Šç­‰çº§</span>${badge}</div>
    <div class="small">${extra || "ç³»ç»Ÿæ­£åœ¨åˆ†æä½ çš„â€˜äººè®¾ä¸€è‡´æ€§â€™â€¦"}</div>
  `;
}

function renderOptions(){
  optionBox.innerHTML="";
  const dayPlot = Plot[State.day];
  if(!dayPlot){
    optionBox.innerHTML = `<div class="small">æš‚æ— å‰§æƒ…ã€‚</div>`;
    return;
  }
  if(State.flags.ending){
    optionBox.innerHTML = `<div class="small">å·²è¿›å…¥ç»“å±€ã€‚è¯·æ¸…æ¡£é‡å¼€æˆ–è¯»æ¡£ã€‚</div>`;
    return;
  }

  const ops = dayPlot.options(State);
  ops.forEach(op=>{
    const div=document.createElement("div");
    div.className="option";
    if(op.highlight) div.classList.add("highlight");

    const tag1 = op.tag?.[0] || "è¡ŒåŠ¨";
    const tag2 = op.tag?.[1] || "æœªçŸ¥";
    const cls1 = (tag1==="ä¸»çº¿") ? "tag-main"
              : (tag1==="æ€æ¡Œ"||tag1==="é»‘åŒ–") ? "tag-risk"
              : (tag1==="å±æœº") ? "tag-warn"
              : (tag1==="æƒè°‹") ? "tag-warn"
              : "tag-safe";
    const cls2 = tag2.includes("é«˜") ? "tag-risk" : (tag2.includes("ä¸­") ? "tag-warn" : "tag-safe");

    div.innerHTML = `
      <span class="tag ${cls1}">${tag1}</span>
      <span class="tag ${cls2}">${tag2}</span>
      <div style="margin-top:6px;font-weight:700;color:#fff">${optionTitle(op)}</div>
      <div class="small" style="margin-top:6px">${effectPreview(op.effect)}</div>
    `;
    div.onclick = ()=>applyAction(op);
    optionBox.appendChild(div);
  });
}

function optionTitle(op){
  const id = op.id || "";
  if(id.endsWith("a")) return "ç¨³ä½å±€é¢ï¼ˆä¸»çº¿/ä½“é¢æ¨è¿›ï¼‰";
  if(id.endsWith("b")) return "æ€æ¡Œå¼€æ€ï¼ˆé«˜é£é™©é«˜æ”¶ç›Šï¼‰";
  if(id.endsWith("c")) return "è¯æ®æ¨è¿›ï¼ˆè°‹ç•¥çº¿ï¼‰";
  if(id.endsWith("d")) return "é—­é—¨ä¿®æ•´ï¼ˆå›è¡€ç¨³å¿ƒï¼‰";
  if(id.endsWith("e")) return "å¤„ç†å±æœºï¼ˆç³»ç»ŸæŠ•æ”¾ï¼‰";
  return "è¡ŒåŠ¨";
}

function effectPreview(effect){
  if(!effect) return "";
  const keys = Object.keys(effect).slice(0,6);
  return keys.map(k=>{
    const v=effect[k];
    const s = v>0?`+${v}`:`${v}`;
    return `${k}${s}`;
  }).join(" Â· ");
}

function renderShop(){
  shopMoney.innerHTML = `å½“å‰æ€æ¡Œå€¼ï¼š<b style="color:var(--accent)">${State.player.æ€æ¡Œå€¼}</b>`;
  shopGrid.innerHTML="";
  Shop.forEach(item=>{
    const can = State.player.æ€æ¡Œå€¼ >= item.price;
    const owned = (item.id==="actor" && State.buffs.actor)
              || (item.id==="iron" && State.buffs.iron)
              || (item.id==="lux" && State.buffs.lux);
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <h4>${item.name} ${owned ? "<span class='badge badge-ok'>å·²æ‹¥æœ‰</span>":""}</h4>
      <div class="meta"><span class="price">-${item.price} æ€æ¡Œå€¼</span><span>${can ? "å¯è´­ä¹°" : "ä½™é¢ä¸è¶³"}</span></div>
      <div class="desc">${item.desc}</div>
      <div class="row">
        <button class="btn" ${(!can || owned) ? "disabled":""}>è´­ä¹°å¹¶ä½¿ç”¨</button>
        <span class="small">ID: ${item.id}</span>
      </div>
    `;
    el.querySelector("button").onclick = ()=>purchase(item.id);
    shopGrid.appendChild(el);
  });
}

function renderAchievements(){
  achList.innerHTML = "";
  Achievements.forEach(a=>{
    const got = !!State.achievementsUnlocked[a.id];
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <h4>${got?"âœ…":"ğŸ”’"} ${a.name}</h4>
      <div class="desc">${a.desc}</div>
      <div class="meta">${got ? "<span class='badge badge-ok'>å·²è§£é”</span>" : "<span class='badge badge-warn'>æœªè§£é”</span>"}</div>
    `;
    achList.appendChild(el);
  });
}

/* =========================
   7) Core Logicï¼ˆå«ä½ ç¼ºçš„â€œè¿›å…¥ä¸‹ä¸€å¤©â€ï¼‰
   ========================= */

function applyDelta(delta){
  Object.entries(delta).forEach(([k,v])=>{
    if(!(k in State.player)) return;
    const before=State.player[k];
    State.player[k]=clamp(before+v,0,100);
    const sign=v>0?"+":"";
    tip(`${k} ${sign}${v}`, v>0 ? "good" : (v<0 ? "bad" : "warn"));
  });
}

function punish(level=1, reason="åç¦»ä¸»çº¿"){
  if(State.buffs.noPunishOnce){
    State.buffs.noPunishOnce=false;
    tip("å±è”½ç¬¦ç”Ÿæ•ˆï¼šå…ä¸€æ¬¡æƒ©ç½š", "warn");
    renderSystem("ã€å±è”½ç¬¦ã€‘å·²æ¶ˆè€—ï¼šç³»ç»ŸçŸ­æš‚å¤±æ˜ã€‚");
    return;
  }

  // æ¼”æŠ€å¤§å¸ˆï¼šé™ä½è§¦å‘æ¦‚ç‡
  if(State.buffs.actor){
    const skip = Math.random() < 0.35;
    if(skip){
      tip("æ¼”æŠ€å¤§å¸ˆï¼šä½ éª—è¿‡ç³»ç»Ÿä¸€æ¬¡", "warn");
      return;
    }
  }

  flash.classList.add("on");
  cards.forEach(c=>c.classList.add("shake"));
  setTimeout(()=>{
    flash.classList.remove("on");
    cards.forEach(c=>c.classList.remove("shake"));
  }, 520);

  let base = level===1 ? 3 : level===2 ? 7 : 12;
  if(State.buffs.iron) base = Math.max(1, base-1);

  const dMind = -base;
  const dHp = -Math.max(1, Math.floor(base/2));
  const dWarn = +(level===1 ? 12 : level===2 ? 22 : 35);

  applyDelta({å¿ƒæ™º:dMind, å¥åº·:dHp, "ç³»ç»Ÿè­¦å‘Šå€¼":dWarn});
  tip(`ç³»ç»Ÿæƒ©ç½šï¼š${reason}`, "bad");
}

function unlockAchievements(){
  let unlockedAny = false;
  Achievements.forEach(a=>{
    if(State.achievementsUnlocked[a.id]) return;
    if(a.cond(State)){
      State.achievementsUnlocked[a.id] = true;
      tip(`æˆå°±è§£é”ï¼š${a.name}`, "good");
      unlockedAny = true;
    }
  });
  if(unlockedAny) renderAchievements();
}

function postResolveChecks(){
  // ä½è¡€ç¡¬æ‰›æˆå°±
  if(State.player.å¥åº·<=15 && State.player.å¥åº·>0){
    State.stats.lowHPsurvive = true;
  }
  unlockAchievements();

  // Day20 æˆ–æå‰ç»“å±€
  if(State.day>=20 && !State.flags.ending){
    const e = endingJudge(State);
    State.flags.ending = true;
    State.phase = "END";
    setSpeaker("ç³»ç»Ÿ");
    typeText(`ã€ç»ˆå±€åˆ¤å®šã€‘\n\n${e.title}\n\n${e.text}\n\nâ€”â€”ï¼ˆä½ å¯ä»¥ç‚¹ã€æ¸…æ¡£é‡å¼€ã€‘æˆ–ã€è¯»æ¡£ã€‘å†èµ°åˆ«çš„è·¯çº¿ã€‚ï¼‰`);
    renderSystem(`ç»“å±€ï¼š${e.title}`);
    renderOptions();
  }

  // å¼ºåˆ¶BE
  if(!State.flags.ending && (State.player.å¥åº·<=0 || State.player.å¿ƒæ™º<=0)){
    const e = endingJudge(State);
    State.flags.ending = true;
    State.phase = "END";
    setSpeaker("ç³»ç»Ÿ");
    typeText(`ã€å¼ºåˆ¶ç»“å±€ã€‘\n\n${e.title}\n\n${e.text}`);
    renderSystem(`ç»“å±€ï¼š${e.title}`);
    renderOptions();
  }
}

function applyAction(op){
  if(State.flags.ending) return;
  if(State.phase==="RESOLVE") return; // é˜²æ­¢è¿ç‚¹
  State.phase="RESOLVE";
  State.flags.mainDone=false;

  // ç»Ÿè®¡æ€æ¡Œæ¬¡æ•°
  if(op.tag?.[0]==="æ€æ¡Œ" || op.tag?.[0]==="é»‘åŒ–"){
    State.stats.flipCount += 1;
  }

  // åˆ¤æ–­ä¸»çº¿æ˜¯å¦å®Œæˆï¼šactionKey åŒ¹é… key
  const dayPlot = Plot[State.day];
  if(dayPlot && op.actionKey === dayPlot.key){
    State.flags.mainDone = true;
  }

  // ä¸€æ¬¡æ€§buffï¼šæƒ…æŠ¥çº¿äºº
  if(State.buffs.nextIntelBoost){
    State.buffs.nextIntelBoost=false;
    applyDelta({è°‹ç•¥:+3});
    tip("æƒ…æŠ¥çº¿äººï¼šè°‹ç•¥åŠ æˆè§¦å‘", "warn");
  }

  // äººè„‰ï¼šç¤¾äº¤é¢å¤–åŠ æˆï¼ˆè¿™é‡Œç”¨å£°æœ›/ä½“é¢åšè¿‘ä¼¼ï¼‰
  const extra = {};
  if(State.buffs.lux && (op.tag?.[0]==="ä¸»çº¿")){
    extra["è´µå¥³å£°æœ›"] = (extra["è´µå¥³å£°æœ›"]||0) + 2;
  }

  // è®²æ•…äº‹
  if(op.tag?.[0]==="ä¸»çº¿") setSpeaker("æŸ³æ‰¶é£");
  if(op.tag?.[0]==="è°‹ç•¥") setSpeaker("æŸ³æ‰¶é£");
  if(op.tag?.[0]==="æ€æ¡Œ") setSpeaker("æŸ³æ‰¶é£");
  if(op.tag?.[0]==="å±æœº") setSpeaker("ç³»ç»Ÿ");

  typeText(op.story);

  // åº”ç”¨æ•°å€¼
  applyDelta({...op.effect, ...extra});

  // å¦‚æœæ²¡åšä¸»çº¿ï¼šç³»ç»Ÿæƒ©ç½šï¼ˆå¼ºåº¦éšè­¦å‘Šå€¼æå‡ï¼‰
  if(dayPlot && !State.flags.mainDone){
    const warn = State.player["ç³»ç»Ÿè­¦å‘Šå€¼"];
    const lvl = (warn>=70) ? 2 : 1;
    punish(lvl, "ä»Šæ—¥ä¸»çº¿æœªå®Œæˆ");
  }else{
    // ä¸»çº¿å®Œæˆï¼šå°‘é‡é™å‹
    applyDelta({"ç³»ç»Ÿè­¦å‘Šå€¼": -2});
  }

  renderStats();
  computeRoute();
  renderSystem(State.flags.mainDone ? "ä¸»çº¿å·²å®Œæˆï¼šç³»ç»Ÿæš‚æ—¶æ”¶æ•›ã€‚" : "ä¸»çº¿æœªå®Œæˆï¼šç³»ç»Ÿæ­£åœ¨åŠ ç ä¿®æ­£ã€‚");

  // æç¤ºï¼šç°åœ¨è¦ç‚¹â€œç»“æŸæœ¬å›åˆâ€è¿›ä¸‹ä¸€å¤©
  tip("å·²ç»“ç®—ï¼šç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©", "warn");

  postResolveChecks();
}

/**
 * âœ… å…³é”®ä¿®å¤ï¼šç»“æŸå›åˆâ†’è¿›å…¥ä¸‹ä¸€å¤©
 * ä½ ä¹‹å‰å¡ Day1ï¼Œé€šå¸¸å°±æ˜¯è¿™é‡Œæ²¡å†™å®Œ/æ²¡ç»‘å®šæˆåŠŸ/é€»è¾‘æ²¡åˆ‡ phaseã€‚
 */
function endTurn(){
  if(State.flags.ending) return;

  // å¦‚æœç”¨æˆ·æ²¡é€‰è¡ŒåŠ¨ä¹Ÿå…è®¸ç»“æŸï¼šå½“ä½œâ€œè™šåº¦â€å¹¶æƒ©ç½šè½»å¾®
  if(State.phase!=="RESOLVE"){
    tip("ä½ è·³è¿‡äº†è¡ŒåŠ¨ï¼šç³»ç»Ÿä¸æ»¡", "warn");
    punish(1, "ä½ è¯•å›¾é€ƒé¿å›åˆæ¨è¿›");
  }

  // è¿›ä¸‹ä¸€å¤©
  State.day = clamp(State.day + 1, 1, 20);
  State.phase = "CHOOSE";
  State.flags.mainDone = false;

  // Dayåˆ‡æ¢å¼€åœº
  const dayPlot = Plot[State.day];
  setSpeaker("æŸ³æ‰¶é£");
  typeText(dayPlot.intro);

  // UIæ›´æ–°
  renderSubtitle();
  renderStats();
  computeRoute();
  renderSystem("æ–°çš„ä¸€å¤©ï¼šç³»ç»Ÿé‡æ–°é”å®šä½ çš„è½¨è¿¹ã€‚");
  renderOptions();

  unlockAchievements();
}

/* =========================
   8) Save / Load
   ========================= */
function saveGame(){
  localStorage.setItem("flipGameSave_v1", JSON.stringify(State));
  tip("å­˜æ¡£æˆåŠŸ", "good");
}
function loadGame(){
  const raw = localStorage.getItem("flipGameSave_v1");
  if(!raw){ tip("æ²¡æœ‰å­˜æ¡£", "bad"); return; }
  try{
    const obj = JSON.parse(raw);
    // ç®€å•åˆå¹¶ï¼ˆé¿å…ç¼ºå­—æ®µå´©ï¼‰
    Object.assign(State, obj);
    tip("è¯»æ¡£æˆåŠŸ", "good");
    afterLoadRefresh();
  }catch(e){
    tip("è¯»æ¡£å¤±è´¥ï¼šå­˜æ¡£æŸå", "bad");
  }
}
function resetGame(){
  localStorage.removeItem("flipGameSave_v1");
  localStorage.removeItem("flipGameAIKey_v1");
  localStorage.removeItem("flipGamePortrait_v1");
  location.reload();
}
function afterLoadRefresh(){
  const dayPlot = Plot[State.day];
  setSpeaker(State.speaker || "æŸ³æ‰¶é£");
  renderSubtitle();
  renderStats();
  computeRoute();
  renderSystem("å·²è¯»æ¡£ï¼šç³»ç»Ÿé‡æ–°è®¡ç®—ä¸­â€¦");
  renderOptions();
  // è¯»æ¡£åæŠŠæ•…äº‹æ¡†å¡«ç‚¹ä¸œè¥¿
  if(!storyBox.textContent.trim()){
    typeText(dayPlot?.intro || "ï¼ˆå·²è¯»æ¡£ï¼‰");
  }
  // æ¢å¤å¤´åƒ
  applyPortraitToUI();
}

/* =========================
   9) Shop / Ach / Portrait
   ========================= */
function purchase(id){
  const item = Shop.find(x=>x.id===id);
  if(!item) return;
  if(State.player.æ€æ¡Œå€¼ < item.price){ tip("æ€æ¡Œå€¼ä¸è¶³", "bad"); return; }

  // è¢«åŠ¨å·²æ‹¥æœ‰å°±ä¸é‡å¤ä¹°
  const owned = (id==="actor" && State.buffs.actor)
            || (id==="iron" && State.buffs.iron)
            || (id==="lux" && State.buffs.lux);
  if(owned){ tip("å·²æ‹¥æœ‰ï¼Œæ— éœ€é‡å¤è´­ä¹°", "warn"); return; }

  State.player.æ€æ¡Œå€¼ = clamp(State.player.æ€æ¡Œå€¼ - item.price, 0, 100);
  item.apply(State);
  tip(`è´­ä¹°æˆåŠŸï¼š${item.name}`, "good");
  renderStats();
  renderShop();
}

function applyPortraitToUI(){
  // å­˜å‚¨è¯»å–
  const raw = localStorage.getItem("flipGamePortrait_v1");
  if(raw){
    try{
      const p = JSON.parse(raw);
      State.portraits = Object.assign(State.portraits, p);
    }catch(e){}
  }
  // è®©è¾“å…¥æ¡†æ˜¾ç¤ºå½“å‰
  inYou.value = State.portraits.you || "";
  inPrince.value = State.portraits.prince || "";
  inSu.value = State.portraits.su || "";
  inSys.value = State.portraits.sys || "";
  // åº”ç”¨åˆ°å½“å‰speaker
  setSpeaker(State.speaker || "æŸ³æ‰¶é£");
}

function savePortrait(){
  localStorage.setItem("flipGamePortrait_v1", JSON.stringify(State.portraits));
  tip("ç«‹ç»˜å·²ä¿å­˜", "good");
  applyPortraitToUI();
}

/* =========================
   10) AIç»­å†™ï¼ˆå¯é€‰ï¼‰
   ========================= */
function loadAIKey(){
  State.ai.key = localStorage.getItem("flipGameAIKey_v1") || "";
  inKey.value = State.ai.key;
}

async function aiContinue(){
  if(State.flags.ending){ tip("å·²æ˜¯ç»“å±€ï¼Œæ— æ³•ç»­å†™", "warn"); return; }

  if(!State.ai.key){
    tip("å…ˆç‚¹ã€è®¾ç½®AIå¯†é’¥ã€‘å¡«Key", "warn");
    aiMask.classList.add("show");
    return;
  }

  // ç”¨ Responses APIï¼š/v1/responses  [oai_citation:2â€¡OpenAI å¹³å°](https://platform.openai.com/docs/guides/migrate-to-responses?utm_source=chatgpt.com)
  const dayPlot = Plot[State.day];
  const P = State.player;

  const prompt = `
ä½ æ˜¯ä¸€ä¸ªä¸­æ–‡äº’åŠ¨å°è¯´å¼•æ“ã€‚ç»­å†™ä¸€ä¸ªâ€œå¤é£å¥³é…æ€æ¡Œ+æƒè°‹+ç”œå® å¯é€‰â€çš„æ®µè½ä¸4ä¸ªé€‰é¡¹ã€‚
è¦æ±‚ï¼šæ–‡å­—æœ‰ç”»é¢æ„Ÿã€äººç‰©æœ‰æƒ…ç»ªã€æ¯ä¸ªé€‰é¡¹ä¸€å¥è¯+æ•ˆæœæ ‡ç­¾(ä¸»çº¿/æ€æ¡Œ/è°‹ç•¥/å…»æˆ)ã€‚
å½“å‰Dayï¼š${State.day}
ä»Šæ—¥ä¸»çº¿ï¼š${dayPlot?.mainTask}
è§’è‰²çŠ¶æ€ï¼šå¤ªå­å¥½æ„Ÿ=${P["å¤ªå­å¥½æ„Ÿ"]}ï¼Œè°‹ç•¥=${P.è°‹ç•¥}ï¼Œåç¦»åº¦=${P["åç¦»åº¦"]}ï¼Œç³»ç»Ÿè­¦å‘Š=${P["ç³»ç»Ÿè­¦å‘Šå€¼"]}ï¼Œæ€æ¡Œå€¼=${P["æ€æ¡Œå€¼"]}ï¼Œå£°æœ›=${P["è´µå¥³å£°æœ›"]}ï¼Œå¥åº·=${P["å¥åº·"]}ï¼Œå¿ƒæ™º=${P["å¿ƒæ™º"]}
å½“å‰å‰§æƒ…æ‘˜è¦ï¼š${(storyBox.textContent||"").slice(-600)}
è¾“å‡ºæ ¼å¼ï¼š
ã€AIå‰§æƒ…ã€‘
(200-400å­—)
ã€AIé€‰é¡¹ã€‘
1) æ ‡ç­¾ï¼š...ï¼›æ–‡æœ¬ï¼š...
2) ...
3) ...
4) ...
`;

  tip("AIæ­£åœ¨ç»­å†™â€¦", "warn");
  try{
    const res = await fetch("https://api.openai.com/v1/responses", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${State.ai.key}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        input: [{ role:"user", content: prompt }],
        max_output_tokens: 500
      })
    });

    if(!res.ok){
      const t = await res.text();
      tip("AIå¤±è´¥ï¼šè¯·æ£€æŸ¥Key/é¢åº¦", "bad");
      console.log("AI error:", t);
      return;
    }
    const data = await res.json();
    // å…¼å®¹ï¼šæŠŠæ‰€æœ‰ output_text æ‹¼èµ·æ¥
    let text = "";
    if(typeof data.output_text === "string") text = data.output_text;
    else if(Array.isArray(data.output)){
      // å…œåº•ï¼šç²—æš´æœæ–‡æœ¬
      text = JSON.stringify(data.output);
    }

    setSpeaker("ç³»ç»Ÿ");
    typeText(`ã€AIç»­å†™ã€‘\n\n${text}\n\nï¼ˆæç¤ºï¼šAIç»­å†™åªç»™æ–‡æœ¬ï¼Œä¸ä¼šè‡ªåŠ¨æ”¹æ•°å€¼ã€‚ä½ å¯ä»¥ç»§ç»­æŒ‰åŸæœ¬é€‰é¡¹èµ°ï¼Œæˆ–è‡ªå®šä¹‰è¡ŒåŠ¨ã€‚ï¼‰`);
    renderSystem("AIå·²ç»­å†™ï¼šä½ å¯ä»¥ç»§ç»­æ‰‹åŠ¨é€‰æ‹©è¡ŒåŠ¨ã€‚");
  }catch(e){
    tip("AIè¯·æ±‚å¼‚å¸¸ï¼ˆç½‘ç»œ/Keyï¼‰", "bad");
    console.log(e);
  }
}

/* =========================
   11) äº‹ä»¶ç»‘å®š
   ========================= */
$("btnEnd").onclick = endTurn;

$("btnCustom").onclick = ()=>{
  if(State.flags.ending) return;
  const s = prompt("è¾“å…¥ä½ çš„è‡ªå®šä¹‰è¡ŒåŠ¨ï¼ˆä¾‹å¦‚ï¼šâ€˜è£…ç—…è¿›å®«è¯•æ¢å¤ªå­â€™ï¼‰");
  if(!s) return;
  State.phase="RESOLVE";
  setSpeaker("æŸ³æ‰¶é£");
  typeText(`ã€è‡ªå®šä¹‰è¡ŒåŠ¨ã€‘\n${s}\n\nä½ åšå®Œè¿™ä¸€æ­¥ï¼Œå¿ƒé‡Œå¾ˆæ¸…æ¥šï¼š\nä¸ç®¡ç³»ç»Ÿæ€ä¹ˆå«ï¼Œä½ éƒ½ä¸ä¼šå†è·ªã€‚`);
  // è‡ªå®šä¹‰è¡ŒåŠ¨ç»™ä¸€ç‚¹â€œä¸­æ€§æ”¶ç›Šâ€
  applyDelta({æ€æ¡Œå€¼:+2, åç¦»åº¦:+1, å¿ƒæ™º:+1});
  renderStats(); computeRoute();
  renderSystem("è‡ªå®šä¹‰è¡ŒåŠ¨ï¼šç³»ç»Ÿæ­£åœ¨é‡æ–°è¯„ä¼°ã€‚");
  tip("å·²ç»“ç®—ï¼šç‚¹ã€ç»“æŸæœ¬å›åˆã€‘è¿›å…¥ä¸‹ä¸€å¤©", "warn");
  postResolveChecks();
};

$("btnShop").onclick = ()=>{ renderShop(); shopMask.classList.add("show"); };
$("btnCloseShop").onclick = ()=> shopMask.classList.remove("show");

$("btnAch").onclick = ()=>{ renderAchievements(); achMask.classList.add("show"); };
$("btnCloseAch").onclick = ()=> achMask.classList.remove("show");

$("btnPortrait").onclick = ()=>{ applyPortraitToUI(); porMask.classList.add("show"); };
$("btnClosePor").onclick = ()=> porMask.classList.remove("show");

$("btnSaveYou").onclick = ()=>{ State.portraits.you = inYou.value.trim(); savePortrait(); };
$("btnSavePrince").onclick = ()=>{ State.portraits.prince = inPrince.value.trim(); savePortrait(); };
$("btnSaveSu").onclick = ()=>{ State.portraits.su = inSu.value.trim(); savePortrait(); };
$("btnSaveSys").onclick = ()=>{ State.portraits.sys = inSys.value.trim(); savePortrait(); };

$("btnSave").onclick = saveGame;
$("btnLoad").onclick = loadGame;
$("btnReset").onclick = ()=>{ if(confirm("ç¡®å®šæ¸…æ¡£é‡å¼€ï¼Ÿ")) resetGame(); };

$("btnAIKey").onclick = ()=>{ loadAIKey(); aiMask.classList.add("show"); };
$("btnCloseAI").onclick = ()=> aiMask.classList.remove("show");
$("btnSaveKey").onclick = ()=>{
  const k = inKey.value.trim();
  localStorage.setItem("flipGameAIKey_v1", k);
  State.ai.key = k;
  tip("AI Keyå·²ä¿å­˜", "good");
  aiMask.classList.remove("show");
};
$("btnAI").onclick = aiContinue;

/* =========================
   12) åˆå§‹åŒ–
   ========================= */
(function init(){
  // è¯»å¤´åƒ
  applyPortraitToUI();
  // è¯»AI Key
  loadAIKey();

  // å¼€åœº
  renderSubtitle();
  renderStats();
  computeRoute();
  renderSystem("æ¬¢è¿è¿›å…¥ï¼šé€‰è¡ŒåŠ¨â†’ç»“ç®—â†’ç»“æŸå›åˆè¿›ä¸‹ä¸€å¤©ã€‚");
  renderOptions();

  setSpeaker("æŸ³æ‰¶é£");
  typeText(Plot[1].intro);

  // æˆå°±åˆ·æ–°
  unlockAchievements();
})();
</script>
</body>
</html>
